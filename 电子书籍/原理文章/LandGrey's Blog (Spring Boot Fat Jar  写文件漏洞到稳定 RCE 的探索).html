<!DOCTYPE html> <html class=trancy-zh-CN style><!--
 Page saved with SingleFile 
 url: https://landgrey.me/blog/22/ 
 saved date: Tue Apr 30 2024 13:31:36 GMT+0800 (中国标准时间)
--><meta charset=utf-8>
<title>LandGrey's Blog</title>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<style>@media (pointer:coarse){@media only screen and (max-device-width:1024px){}@media only screen and (max-device-width:414px){}@media only screen and (max-device-width:320px){}}</style><style>@media screen and (max-width:768px){}</style><style>/*!
 * Waves v0.7.5
 * http://fian.my.id/Waves
 * 
 * Copyright 2014-2016 Alfiana E. Sibuea and other contributors
 * Released under the MIT license
 * https://github.com/fians/Waves/blob/master/LICENSE
 */</style><style>@media (max-height:620px){}@media (max-height:783px){}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}</style><style>@-webkit-keyframes fadeOutUp{0%{opacity:1}to{margin-top:0;padding:0;height:0;min-height:0;opacity:0;-webkit-transform:scaleY(0);transform:scaleY(0)}}@keyframes fadeOutUp{0%{opacity:1}to{margin-top:0;padding:0;height:0;min-height:0;opacity:0;-webkit-transform:scaleY(0);transform:scaleY(0)}}@media (pointer:coarse){}</style><style>:root{--sr-annote-color-0:#b4d9fb;--sr-annote-color-1:#ffeb3b;--sr-annote-color-2:#a2e9f2;--sr-annote-color-3:#a1e0ff;--sr-annote-color-4:#a8ea68;--sr-annote-color-5:#ffb7da}</style><style>@-webkit-keyframes sr-annote-slideInUp{0%{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0);visibility:visible}to{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}}@keyframes sr-annote-slideInUp{0%{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0);visibility:visible}to{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}}@-webkit-keyframes sr-annote-slideInDown{0%{opacity:1;visibility:visible}to{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}}@keyframes sr-annote-slideInDown{0%{opacity:1;visibility:visible}to{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}}</style><style>@-webkit-keyframes fadeInUp{0%{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}to{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}}@keyframes fadeInUp{0%{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}to{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}}@-webkit-keyframes fadeOutDown{0%{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}to{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}}@keyframes fadeOutDown{0%{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}to{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}}@-webkit-keyframes scaleAnimation{0%{opacity:0;-webkit-transform:scale(1.5);transform:scale(1.5)}to{opacity:1;-webkit-transform:scale(1);transform:scale(1)}}@keyframes scaleAnimation{0%{opacity:0;-webkit-transform:scale(1.5);transform:scale(1.5)}to{opacity:1;-webkit-transform:scale(1);transform:scale(1)}}@-webkit-keyframes fadeOut{0%{opacity:1}to{opacity:0}}@keyframes fadeOut{0%{opacity:1}to{opacity:0}}@-webkit-keyframes fadeIn{0%{opacity:0}to{opacity:1}}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}@-webkit-keyframes swing{20%{-webkit-transform:rotate(15deg);transform:rotate(15deg)}40%{-webkit-transform:rotate(-10deg);transform:rotate(-10deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}80%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}@keyframes swing{20%{-webkit-transform:rotate(15deg);transform:rotate(15deg)}40%{-webkit-transform:rotate(-10deg);transform:rotate(-10deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}80%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}</style><style>@-webkit-keyframes fadeInUp{0%{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}to{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}}@keyframes fadeInUp{0%{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}to{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}}@-webkit-keyframes fadeOutDown{0%{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}to{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}}@keyframes fadeOutDown{0%{opacity:1;-webkit-transform:translateZ(0);transform:translateZ(0)}to{opacity:0;-webkit-transform:translate3d(0,100%,0);transform:translate3d(0,100%,0)}}</style><style data-id=immersive-translate-input-injected-css>@-webkit-keyframes immersive-translate-loading-animation{from{-webkit-transform:rotate(0deg)}to{-webkit-transform:rotate(359deg)}}@keyframes immersive-translate-loading-animation{from{transform:rotate(0deg)}to{transform:rotate(359deg)}}@keyframes immersiveTranslateShadowRolling{0%{box-shadow:0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0)}12%{box-shadow:100px 0 var(--loading-color),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0)}25%{box-shadow:110px 0 var(--loading-color),100px 0 var(--loading-color),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0)}36%{box-shadow:120px 0 var(--loading-color),110px 0 var(--loading-color),100px 0 var(--loading-color),0px 0 rgba(255,255,255,0)}50%{box-shadow:130px 0 var(--loading-color),120px 0 var(--loading-color),110px 0 var(--loading-color),100px 0 var(--loading-color)}62%{box-shadow:200px 0 rgba(255,255,255,0),130px 0 var(--loading-color),120px 0 var(--loading-color),110px 0 var(--loading-color)}75%{box-shadow:200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),130px 0 var(--loading-color),120px 0 var(--loading-color)}87%{box-shadow:200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),130px 0 var(--loading-color)}100%{box-shadow:200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0)}}@media (prefers-color-scheme:dark){}@media screen and (max-width:768px){}</style><meta name=referrer content=no-referrer><link rel=canonical href=https://landgrey.me/blog/22/><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
 <body>
 
 <header id=top>
 <div class=row>
 <div class="header-content twelve columns">
 <h1 id=logo-text><a href=https://landgrey.me/ title>LandGrey's Blog </a></h1>
 <p id=intro></p>
 </div>
 </div>
 <nav id=nav-wrap>
 <a class=mobile-btn href=#nav-wrap title="Show navigation">Show Menu</a>
 <a class=mobile-btn href=# title="Hide navigation">Hide Menu</a>
 <div class=row>
 <ul id=nav class=nav>
 <li>
 <a href=https://landgrey.me/>首页</a></li>
 <li>
 <a href=https://landgrey.me/archive/ title=归档>归档</a>
 </li>
 <li>
 <a href=https://landgrey.me/comment/ title=留言>留言</a>
 </li>
 <li>
 <a href=https://landgrey.me/about/ title=关于>关于</a>
 </li>
 <li>
 <a href=https://landgrey.me/friends/ title=关于>友链</a>
 </li> 
 </ul> 
 </div>
 </nav> 
 </header> 
 
 <div id=content-wrap>
 
 
 
 <div class=row>
 <div id=main class="eight columns">
 
 
 <article class=entry>
 <header class=entry-header>
 <h2 class=entry-title>
 Spring Boot Fat Jar 写文件漏洞到稳定 RCE 的探索
 </h2>
 <div class=entry-meta>
 <ul>
 <li><span data-timestamp=2021-04-12T15:57:23Z data-format=fromNow(0) data-refresh=0>3年前</span></li>
 <span class=meta-sep>•</span>
 <li>原创</li>
 </ul>
 </div>
 </header>
 <div class=entry-content>
 <p class=lead>
 
 <h3>0x00: 背景</h3>
<p>现在生产环境部署 <code>spring boot</code> 项目一般都是将其打包成一个 <code>FatJar</code>，即把所有依赖的第三方 jar 也打包进自身的 <code>app.jar</code> 中，最后以 <code>java -jar app.jar</code> 形式来运行整个项目。</p>
<p>运行时项目的 <code>classpath</code> 包括 <code>app.jar</code> 中的 <code>BOOT-INF/classes</code> 目录和 <code>BOOT-INF/lib</code> 目录下的所有 jar，因此无法在其运行的时候往 classpath 中增加文件。并且现阶段 spring boot 项目多以 RESTful API 接口形式向外提供服务，很少会动态解析 jsp 和其他外部模版文件，直接 webshell 文件的情况一般不会出现。</p>
<p>这样就导致了一个不太好解决但又经常有人来问的有趣问题：<strong>一个正在运行中的 spring boot 项目如果存在本地任意写文件漏洞，怎么升级成 RCE 漏洞</strong> ？</p>
<p>目前口口相传和网络上能查到的通用方法基本就是通过写 linux <code>crontab</code> 计划任务文件、替换 <code>so/dll</code> 系统文件进行劫持等<strong>一些操作系统层面</strong>的东西来实现 RCE。实际环境下因为网络联通性、文件权限等各种条件限制，都不是特别好用，所以找一个 java 代码层面的利用方法就显得很有必要。</p>
<h3>0x01: 类装载与类初始化</h3>
<p>现在大家很多时候会把 <strong>类装载 (Class loading)</strong> 和 <strong>类初始化 (Class initialization)</strong> 的概念混淆在一起，并称为<strong>类加载</strong>，平常讨论时不需要特意的区别对待，但在比较精细化的漏洞利用中，有必要先清晰的理解两者的差别。</p>
<p>类装载是由 jvm 的不同 ClassLoader，包括 <code>Bootstrap Classloder</code>、<code>Extention ClassLoader</code>、<code>App ClassLoader</code> 和用户自定义的 <code>Classloder</code> 完成的。类装载通常是一个 Class 在字节码中引用另一个 Class 时被动触发的，也有通过 <strong>Classloder loadClass</strong> 和 <strong>Class forName</strong> 等方式主动触发的。</p>
<p>在 java 程序运行的命令行中使用 <code>-XX:+TraceClassLoading</code>，可以观察到像如下在控制台输出的类装载过程日志：</p>
<pre><code>[Opened **/jre/lib/rt.jar]
[Loaded java.lang.Object from **/jre/lib/rt.jar]
[Loaded java.io.Serializable from **/jre/lib/rt.jar]
[Loaded java.lang.Comparable from **/jre/lib/rt.jar]
[Loaded java.lang.CharSequence from **/jre/lib/rt.jar]
......
</code></pre>
<p>其中里面的 <code>Opened</code> 操作代表打开指定文件，通常表示第一次读取相关字节码到内存；<code>Loaded</code> 操作代表将读取的指定类的字节码进行装载。</p>
<p>我仔细跟踪了下 jdk 的类装载过程，发现当经过 <code>java.lang.Classloder.defineClass</code> 方法的时候，即<strong>读取字节码并定义Class类型</strong>后，类装载 <code>Loaded</code> 操作就算完成了。</p>
<p>类初始化（也可以叫类实例化）一定发生在类装载之后，当调用类中的静态属性或者静态方法时，会<strong>被动触发</strong>类的初始化；调用 <code>new</code> 关键词、<code>newInstance</code> 方法、<code>Class.forName</code> 等方法时，会<strong>主动触发</strong>类的初始化。</p>
<p>用一小段简单的代码来形象的区别类装载和类初始化：</p>
<ul>
<li>loadClass 类装载</li>
</ul>
<p><code>classLoader.loadClass(className);</code></p>
<ul>
<li>loadClass 类初始化</li>
</ul>
<p><code>classLoader.loadClass(className).newInstance();</code></p>
<ul>
<li>Class forName 类装载</li>
</ul>
<p><code>Class.forName(className, false, classLoader);</code></p>
<ul>
<li>Class forName 类初始化</li>
</ul>
<p><code>Class.forName(className, true, classLoader);</code></p>
<p><strong>总结一下：</strong></p>
<ul>
<li>类装载并不一定会接着进行类初始化，不会执行类中的任何代码；</li>
<li>类初始化意味着类装载已经完成，会执行类中的一些特殊代码；</li>
</ul>
<h3>0x02: 类初始化与写文件漏洞的思考</h3>
<p>关于类加载器的双亲委托机制，类初始化的时机等知识可以参考 <a href=https://developer.ibm.com/zh/articles/j-lo-classloader/ rel=nofollow>深入探讨 Java 类加载器</a>、<a href=https://www.cnblogs.com/czwbig/p/11127222.html rel=nofollow>深入理解Java类加载</a>，本文中不做重复描述，人生苦短，减少搬运。</p>
<p>这里讲一下为什么要重点说类初始化：</p>
<ul>
<li>
<p>类初始化的时候会执行 static 代码块、static 属性引用的方法等，还可能执行构造器中的代码</p>
</li>
<li>
<p>类装载和类初始化对于应用来说是个很平常的操作</p>
<ul>
<li>应用第一次启动时会装载很多类</li>
<li>运行过程中也会因为一些代码第一次执行或者第一次异常报错而触发一些类的装载和初始化</li>
<li>有些框架和程序员很喜欢用 <code>Class.forName(className)</code> 类似的，可以初始化类的代码去加载类，其中的 <code>className</code> 也容易被外部控制</li>
</ul>
</li>
<li>如果找到一种方法可以<strong>控制程序在指定的写文件漏洞可控的文件范围内，主动触发初始化恶意的类</strong>，就有可能让写文件漏洞变成代码执行漏洞</li>
</ul>
<h3>0x03: 写什么文件</h3>
<p>前文已经讲了，由于 spring boot 把所有资源打包进一个 jar 文件内，所以我们无法在运行时往其 classpath 等目录内写入任何东西，也就没办法通过写 webshell、替换模版资源文件、替换 class 文件等方式来达到 RCE。</p>
<p>那么自然而然的可以想到：没办法写入文件到应用的 classpath 目录，可以写入文件到更底层的 <strong>"系统的 classpath 目录"</strong>，即 JDK HOME 目录下。</p>
<p>经过一段时间的类加载过程观察、研究和不断的~~测试~~试错，我发现 jvm 为了避免一下加载太多暂时用不到或者以后都用不到的类，不会在一开始运行时把所有的 JDK HOME 目录下自带的 jar 文件全部加载到类中，存在 "<strong>懒加载</strong>" 行为。主要特征就是相关 jar 文件的 <code>Opened</code> 操作没有在一开始就发生，而是调用到相关类时被触发。</p>
<p>这样一来，结合 JDK HOME 目录下的系统 jar 文件、写文件漏洞，就很自然而然的想到，通过增加或替换 JDK HOME 目录下的系统 jar 文件，再主动触发 jar 文件里的类初始化来达到执行任意代码的方法。</p>
<p>JDK 在启动后，不会主动寻找 HOME 目录下新增的 jar 文件去尝试加载，所以也只有替换 JDK HOME 目录下原有的 jar 才可行，而且还得寻找系统启动后没有进行过 <code>Opened</code> 操作的系统 jar 文件。</p>
<p>然后又经过长时间的 debug 和不断~~测试~~试错，我发现程序代码中如果没有使用 <code>Charset.forName("GBK")</code> 类似的代码，默认就不会加载到 <code>/jre/lib/charsets.jar</code> 文件，同时为了兼容下文讲的更多的利用场景，所以我下面举例覆盖的系统 jar 文件都是 <code>charsets.jar</code> 。</p>
<p>其他类似没有一开始就被 <code>Opened</code> 操作的系统 jar 文件可能也有较好的姿势和效果，留给读者自行去扩展研究了。</p>
<p>另外，写文件一般需要指定写入文件的目录，而 JDK HOME 的目录一般不是固定的，所以可以提前收集好 JDK HOME 字典文件，在信息不透明的时候可以使用目录枚举的方式去批量上传测试。</p>
<p>测试时收集了几个常见 JDK 的目录，希望能有小伙伴一块补充下：</p>
<pre><code>/usr/lib/jvm/java-8-oracle/jre/lib/
/usr/lib/jvm/java-1.8-openjdk/jre/lib/
/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/
</code></pre>
<h3>0x04: 可控的主动类初始化</h3>
<p>解决 <strong>"写什么文件"</strong> 的问题只是提供了 RCE 的土壤，想要发芽还得需要解决另一个重要问题：<strong>怎么主动触发可以控制类名的类初始化行为</strong>。</p>
<p>经过一番思考和调试，我暂时总结了 6 种比较常见的场景来完成可控的主动类初始化，希望也有小伙伴能提些建议和或者补充更多的场景。</p>
<p>下面主要介绍了下第一种场景，其余完整的测试场景 demo 代码托管在 <a href=https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/tree/main/fatJarWriteFileRCE rel=nofollow>spring-boot-upload-file-lead-to-rce-tricks</a> 项目中，有兴趣的小伙伴可以看看。</p>
<h4>零. spring 原生场景</h4>
<p><strong>spring-web</strong> 组件中的 <code>org.springframework.web.accept.HeaderContentNegotiationStrategy</code> 类中有下面一段代码（部分省略）：</p>
<pre><code class=java>public List&lt;MediaType&gt; resolveMediaTypes(NativeWebRequest request) throws HttpMediaTypeNotAcceptableException {
    String[] headerValueArray = request.getHeaderValues("Accept");
    ...
        try {
            List&lt;MediaType&gt; mediaTypes = MediaType.parseMediaTypes(headerValues);
            ...
        } catch (InvalidMediaTypeException var5) {
            ...
        }
    }
}
</code></pre>
<p>其作用是对于每一次请求，spring 框架都会尝试解析 <code>Accept</code> 头的值，设置相应的字符集编码。</p>
<p>正常请求的一条 <code>Accept</code> 头示例可能如下：</p>
<pre><code>Accept: text/plain, */*; q=0.01
</code></pre>
<p>可以利用的地方在 <code>MediaType.parseMediaTypes(headerValues)</code> 这行代码。经过一番调用会来到 <strong>spring-core</strong> 组件 <code>org.springframework.util.MimeTypeUtils</code> 类的 <code>parseMimeTypeInternal</code> 方法中 (部分代码省略)：</p>
<pre><code class=java>private static MimeType parseMimeTypeInternal(String mimeType) {
    int index = mimeType.indexOf(';');
    ...
    Map&lt;String, String&gt; parameters = null;
    do {
        int nextIndex = index + 1;
        boolean quoted = false;
        while (nextIndex &lt; mimeType.length()) {
            char ch = mimeType.charAt(nextIndex);
            if (ch == ';') {
                if (!quoted) {
                    break;
                }
            }
            else if (ch == '"') {
                quoted = !quoted;
            }
            nextIndex++;
        }
        String parameter = mimeType.substring(index + 1, nextIndex).trim();
        if (parameter.length() &gt; 0) {
            if (parameters == null) {
                parameters = new LinkedHashMap&lt;&gt;(4);
            }
            int eqIndex = parameter.indexOf('=');
            if (eqIndex &gt;= 0) {
                String attribute = parameter.substring(0, eqIndex).trim();
                String value = parameter.substring(eqIndex + 1, parameter.length()).trim();
                parameters.put(attribute, value);
            }
        }
        index = nextIndex;
    }
    while (index &lt; mimeType.length());

    try {
        return new MimeType(type, subtype, parameters);
    }
    ...
}
</code></pre>
<p>可以看到，上述代码经过对获取的 <code>Accept</code> 头格式的解析，最终用可控的 <code>type</code>、<code>subtype</code> 和 <code>parameters</code> 生成 <code>org.springframework.util.MimeType</code> 类型实例：</p>
<pre><code>new MimeType(type, subtype, parameters)
</code></pre>
<p>跟入对应的有参构造函数中：</p>
<pre><code class=java>public MimeType(String type, String subtype, @Nullable Map&lt;String, String&gt; parameters) {
    ...
    if (!CollectionUtils.isEmpty(parameters)) {
        Map&lt;String, String&gt; map = new LinkedCaseInsensitiveMap&lt;&gt;(parameters.size(), Locale.ENGLISH);
        parameters.forEach((attribute, value) -&gt; {
            checkParameters(attribute, value);
            map.put(attribute, value);
        });
        ...
    }
    ...
}
</code></pre>
<p>发现会利用 <code>checkParameters(attribute, value)</code> 对 <code>parameters</code> 进行解析</p>
<pre><code>protected void checkParameters(String attribute, String value) {
    ...
    if (PARAM_CHARSET.equals(attribute)) {
        value = unquote(value);
        Charset.forName(value);
    }
    ...
}
</code></pre>
<p>然后就看到 <code>Charset.forName(value)</code> 用来主动加载字符集的代码，剩下的部分就和 <strong>一. fastjson 最新版(目前是 1.2.76)默认配置场景</strong> 后面讲的一致了。</p>
<p>在实际的环境中，替换过 <code>charsets.jar</code> 后，用如下的数据包就可触发 RCE 了 ^_^：</p>
<pre><code>GET / HTTP/1.1
Accept: text/html;charset=GBK

</code></pre>
<h4>一. fastjson 最新版(目前是 1.2.76)默认配置场景</h4>
<p>选择替换 <code>charsets.jar</code> 文件可以绕过 fastjson 最新版的 autoType 限制。</p>
<p>以 fastjson 1.2.76 举例， <code>com.alibaba.fastjson.parser.ParserConfig</code> 类中有如下代码：</p>
<pre><code class=java>if (clazz == null) {
    clazz = this.deserializers.findClass(typeName);
}
</code></pre>
<p>实际的 <code>findClass</code> 方法会枚举 <code>this.buckets</code> 中保存的 <code>IdentityHashMap&lt;Type, ObjectDeserializer&gt;</code> 类型键值对</p>
<pre><code class=java>public Class findClass(String keyString) {
    for(int i = 0; i &lt; this.buckets.length; ++i) {
        IdentityHashMap.Entry bucket = this.buckets[i];
        if (bucket != null) {
            for(IdentityHashMap.Entry entry = bucket; entry != null; entry = entry.next) {
                Object key = bucket.key;
                if (key instanceof Class) {
                    Class clazz = (Class)key;
                    String className = clazz.getName();
                    if (className.equals(keyString)) {
                        return clazz;
                    }
                }
            }
        }
    }

    return null;
}
</code></pre>
<p>而 <code>java.nio.charset.Charset</code> 类名正好在白名单中，所以可以直接返回 clazz。并且在 fastjson <code>com.alibaba.fastjson.serializer.MiscCodec</code> 类的后续处理中有以下代码</p>
<pre><code class=java>else if (clazz == Charset.class) {
    return Charset.forName(strVal);
}
</code></pre>
<p>发现 Class 类型为 <code>java.nio.charset.Charset</code> ，就会使用 <code>Charset.forName(strVal)</code> 方法。经过一番调试，发现最终会调用到 <code>jre/lib/rt.jar!/sun/nio/cs/AbstractCharsetProvider.class</code> 类的如下代码：</p>
<pre><code class=java>Class var4 = Class.forName(this.packagePrefix + "." + var9, true, this.getClass().getClassLoader());
Charset var5 = (Charset)var4.newInstance();
</code></pre>
<p>其中的 <code>this.packagePrefix</code> 值为 <code>sun.nio.cs.ext</code> ，即 <code>charsets.jar</code> 的包名前缀，这些对于写文件都是可控的，所以我们可以通过如下的 json 包直接加载可控的类：</p>
<pre><code>{
    "x":{
        "@type":"java.nio.charset.Charset",
        "val":"GBK"
    }
}
</code></pre>
<p>这样就完成了写文件漏洞在使用 fastjson 的场景下的 RCE 利用。</p>
<h4>二. jackson 开启 enableDefaultTyping 场景</h4>
<h4>三. jdbc url getConnection 场景</h4>
<h4>四. 直接 Class forName 场景</h4>
<h4>五. 直接 loadClass newInstance 场景</h4>
<h3>0x05: 测试环境</h3>
<p>快速搭建 docker 漏洞测试环境及相关代码托管在 <a href=https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks rel=nofollow>spring-boot-upload-file-lead-to-rce-tricks</a>，敬请查看。</p>
<p>希望有小伙伴能提 issue，一起补充下常见的 JDK HOME 目录和更多的漏洞利用场景 ^_^</p>
<h3>参考文章：</h3>
<p><a href=https://javarevisited.blogspot.com/2012/07/when-class-loading-initialization-java-example.html rel=nofollow>when-class-loading-initialization</a></p>
<p><a href=https://docs.oracle.com/cd/B14099_19/web.1012/b14032/appA006.htm rel=nofollow>Improving Performance with Caching</a></p>
<p><a href=https://docs.oracle.com/javase/tutorial/ext/basics/load.html rel=nofollow>Understanding Extension Class Loading</a></p>
<p><a href=https://developer.ibm.com/zh/articles/j-lo-classloader/ rel=nofollow>深入探讨 Java 类加载器</a></p>
<p><a href=https://www.cnblogs.com/czwbig/p/11127222.html rel=nofollow>深入理解Java类加载</a></p>
<p><a href=https://hunterzhao.io/post/2018/05/15/hotspot-explore-java-lang-class-forname/ rel=nofollow>细说Class.forName()底层实现</a></p>
<p><a href=https://github.com/LeadroyaL/fastjson-blacklist rel=nofollow>LeadroyaL/fastjson-blacklist</a></p>
 
 <p></p>
 </div>
 
 <p class=tags>
 <span>标签</span>：
 
 <a href=https://landgrey.me/tag/spring/ title rel=tag>spring</a>&nbsp;
 
 <a href=https://landgrey.me/tag/%E7%BA%A2%E9%98%9F%E6%94%BB%E9%98%B2/ title rel=tag>红队攻防</a>&nbsp;
 
 <a href=https://landgrey.me/tag/java/ title rel=tag>java</a>&nbsp;
 
 </p>
 
 <ul class="post-nav group">
 
 <li class=prev><a rel=prev href=https://landgrey.me/blog/21/><strong>上篇</strong>spring actuator restart logging.config rce
 </a></li>
 
 
 <li class=next><a rel=next href=https://landgrey.me/blog/23/><strong>下篇</strong> spring-security 三种情况下的认证绕过
 </a></li>
 
 </ul>
 
 <div id=comments>
 
 <h3>5 评论</h3>
 
 
 
<ol class=commentlist>
 
 
 
 <li class=depth-1>
 <div class=avatar>
 <img width=50 height=50 class=avatar src=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAE9UlEQVRYhbWYbUhbVxjH/+kyWBXGlqQQ/TIoGwzRUXCOTYpV2tJFWGW1NDIobHPCED9IU9cIFYOODjptwVopWCsUOtuxqbVoKJtg/LBhssFmbSukFgNTW018q0lE8T77kJ7rveeevDb5wwXvc+859+dznpeTA+I04Z6lwaFJ3qzRlasuWvJvxH1vyb9BV6664r43ODRJE+5ZjR28odLaQwdLL9POjhQTzmi2JwxoNNtjQu7sSHSw9DJVWns0z/ZAIbfHhzGXF4+nn+Pe8BRE6uwah6PVKXwWS45WJzq7xoXP7g1P4fH0c4y5vHB7fKpnKsCL7aPy322XRiFJlBa4WJCSRGi7tPtdJYMKkHmPiffiq8JFg2TeY9J4ka312XMDtLj4gpb8G/J1pqFfjkWlnV2x4lQZX6Kx7NmZhn6VfXHxBZ09NyCPB1Ekc41muyp7RbZ0a3Bokoxmuyp7edse5bor405kS6eUsce+JbLplbHH4i7H/KbGVvFZQVoBlbHH4m7h2brG9trKeoFj1rcsD/R6F/HPv3Pwcbavv/w4rYA13/bB7w/K9//NreK336dVtrn5NeiISLV+nV3jqLIWwmTMVk1oymlU3dfVlsBkzI6b2Y4mC/yBoKa8+Bd+UN8Hgrh952/U1Zao7HoeztHqRJW1MOZH62pL4Giy7EJEgXQ0WVQfjFao+XmUY2TAROscg1tdDSO8uS1Pxo9lcAvP1rH3jdflfyhpSKLd3souUY81mu3U3DJCREQrKyEqO9pBRcVtNL+wRvwcrO/OL6xRUXEblR3toJWVEBERNbeMkNFs18zPejY/hz4Vz504dR2TD+YBABWV3bj7a41qWZjnKiq78fSpHwBw4tR19P/8jSo0EvGkvspaqIk5w9tZmgEsacKb29gIbsn2cGgL4VDk3mDIEtoBYCO4hfDmNt7CXk0Csm9OT53XkiZa9UVLl3/gAs3MLBER0a0+D+3LbaR9uY10q89DREQzM0uUf+CCMBQSVVKAPCQPx97hIUVxmqj0Wp/GFp9lP93+C/W2flU7lCRCva0fAPBF1YcAUt8NJQ2ohDQYsjRwIsjl5VDKW7WUAIFI5Wcg0SRJhOXlkPxuKkoJMFOdRKSkATPdSTRKJosz2UmiKWFAHo7B8JA8HHuPh0xUetEvremp89rtVoY7iT8QxPv536tsdbUlkSVmbo+3WchkJ+E3C8zL8hIrIaMBZrKTKAGVISBncar7tXR3Er6EqcpMsluhdHcSHg5A/DIz4Z4VHuq8qiqtPcLTLF5RC7Xb48PF9lHVcUg6NebyYszlRemh9/Cd7TA+KnpH+J4G0O3xYeDuJLp7/sgIGC8GWlNdjM8rPtCAqg6PTlbdQPnxa7DVl+Fm72kU5OdmHLAgPxc3e0/DVl+G8uPXcLLqhvrwiMWYqA5KEtGw8yGVHulIewyWHumgYedDkl6eP/F1kMWo3h8IIhBlO6TTRTqI0ZAlPNsTdRxe0TqE0ZAFkzEbOp14XCAQhD8QhL780zxYjuXBef8RfmwfxYOpyK81Pkl+uVMNILUtEw/naLLAlNOIsfEncpLs328CEFnyBtthWI7lQaeD+uiDCHDefwTX+BP09P6p9sTLowqlJ5P1oLLO8Ucp1V99gkMl78pgskTxoYw9UWtibTGZQ3R+B8Pm5WORV8xCHStJmltGEgYUba/igTH9D/ZrXkrX8CtHAAAAAElFTkSuQmCC alt>
 </div>
 <div class=comment-content>
 <div class=comment-info>
 <cite>MatthewStymn</cite>
 <div class=comment-meta>
 <time class=comment-time datetime=2014-07-12T23:05>2021-04-29 22:27:29.639394</time>
 
 <span class=sep>/</span><a class=reply href=javascript:void(0)>回复</a>
 </div>
 </div>
 <div class=comment-text>
 <p> Woodworking projects ideas and DIY </p>
 </div>
 </div>
 
 </li>
 
 
 
 <li class=depth-1>
 <div class=avatar>
 <img width=50 height=50 class=avatar src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAC5ElEQVRYhc2Yv3ISURTGv73cjWgFjINMCpLSwsI3CE4aegsak8rkCfICtpoX0LG0iIU9TYbRJ0hhYefAjE7iOIhNQmDZa8Heze7dc/8sLODXcdjd++PsOfc7F08IIWDQILzFh+ASDz0fH6e/Ut99uv8EFY+bbsdIBHh+8zUV6/h1/BZTvOANNNk94/3ap0uwXjBCCIHzB08BIAOZVx2/jmN/G/vXF+gFIzzjFSNoBlAFS+rY314KUsJJhRA4D/4YQWNAE1gRkCpcUiZQ7gpGQRYBZwP11CbpBkOcTgYZ1I5fz2StzWvoBkPjotQ11LM8ACdbTbR5LRVnLnDAPGsdv56KHRExFeRIyZwumwLA6WSQ+TExoAnOBEnFdCC2V01BMle4PJCLwOkgeR64JJAptiicCgkA3tvJD+HiEPvXF84LuEhu/FI6x2G6Gtq0ZNYZoC/0TSlZEnEX/y+Qar2mCi2vQxQtqpnIJnFxiKKlcxyySWwOUbRMjqNtknXVpG1TNzbJqiFdHMfaJMsOqcvAZQAlkOoa6ghUhP6KILOO6i6AMm5RavMaTraaxZFFomY/SkZACecVhnUn3YCqSgu4SjgpF0jy2LkOOCkJqROnGqIbDFO7+iqa5A0x3gPQj/wSRP0162wS46GJeq3rbhIqxjYBlweSbwpOBdLFvFfj7+LzbGR9ELXL6xxHLXSXeyntlSrgh34DX2ajXKc6SmozLTtPegAO/QbYLitjr1QpBM6Du0PYtFeqYJeV501y4DfspuwAJ7UsJIuYgMhJZBZ7DrVog1MhF5HMHoC7f7f64Rgvx98QYj5yvZv+tMKpdaZrEpczjlyTAXhffoydCDB+szusjFapCsD+V4XJcVwdQoWTk3urVI3hUoAAcOA/igM6SNu+6eoQFByLGJJKATZZGS1ejT+rkK6buiukeuZp8SqaiewBAISi/uxGDYmzyZV4fdsXoRKnYkmF0TVU7GxylbmeWvsfbJgNLA6Fd1QAAAAASUVORK5CYII=" alt>
 </div>
 <div class=comment-content>
 <div class=comment-info>
 <cite>killdooks</cite>
 <div class=comment-meta>
 <time class=comment-time datetime=2014-07-12T23:05>2021-04-30 18:07:18.979850</time>
 
 <span class=sep>/</span><a class=reply href=javascript:void(0)>回复</a>
 </div>
 </div>
 <div class=comment-text>
 <p>Como se llamo esto i am from SPAIN</p>
 </div>
 </div>
 
 </li>
 
 
 
 <li class=depth-1>
 <div class=avatar>
 <img width=50 height=50 class=avatar src=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFeUlEQVRYhbWYTWgUZxjHfzM7u5vJarPJxlo3lSjBrBJ6KAlEKLlILQQbhFhaCiZH9VK1l6K3ngztofXjYnoSFYti4zcBt724FBJMDkUWs4a0LuqKMZtsdDdrPnanh2S2M/PO7I42+cPC8sz78Xufd57ned+RfvqnUcOgtpqDxLNXyRfSJtvIbD9WHdo8iuoJCXaj8oU0Z5+0CnbrmKonRMu6L4R5ZGunjtrjwkBW22qoo/Y4bTUHK9pKgG8LV+dtQpGqKoIoUhV13qZ3hlTeFq7O20R78DCRQBeSeQNs5ZUD9DZESeRuMZw5zfTihAAEEM9eFWwjs/1wb/qEZtX9zFnBdu7pLu1h9rpW1ArCM7cqagXtYfa6du7pLldz3ps+oSmqXCesWvXUCrbehmhZj6XmRxnKnARgZ/AoYb8YGBIy2wN7iQS6XM2pynUosZk+ANO+x2Z+IF+YMdmc4HSwZD5WsiXzMRrVjrKgRo3M9jPy6hda1n1pssVm+pbfQXtI0WbVwIseE5hRyXysBNq98YLjGDqIMV3pNjBEcWymT8hBdjYrRCWVa2MEcbIpViCr3HjyXeQGDkCyVhKwrxAPswOEfBHe97XYTji9OMGTN38CsLnqE8fcN7kQJ72QYMe6bpPdqeJUTmQr2uBr4VKqi5uTB5hciJvABl8e4fyz3QSVrQSVrZx/tpvBl0dMOW9yIc7NyQNcSnWxwWGRdlKsBqcKUe+LsC3QyaPcHSbmojRV78YrqSRyt9AoEva30qh2ALDJ/zFjuRskcreIBLpY1PJMzEUBjebAHup9ERFkpeJYE3lpi91UiKmFBBdTnWgUhWfdGy+UAJP5GAMveoQ2EjL7w4O2gAAaRaHiKG9TuoxeNMroPYBGtYOwv5XU/Kip3bZApyOcvgA9keugcm9DlO2BvWUTsdEbiqQKbbxytSubse/Aix5hAVbQ3oYociWwy8/3lXJZZinJWPaa0DaZj5kmS82P2ua/sew1MkvJUp/Lz/dVBLWls4LpGs6coUgBELdVr8PW//p2AxQpMJw5IyxOB7WTEMV6J6t074X9rewMHi3BGWux7gm7WpzMxxjKnGQse4324Deu5gSQNE0TEvXPj7cIDT8N9fGe8qHJa0al5kdJvRkBIFzVZntI0EFeLT3l97R41vx2y2PBZrvFdoMrkh/VIx7NdFXJQbyyildWqZKDju1UTx2K5Hc1pyPgzuBRwbbWlcRuTnB4B+3y2FpWEmvAGeWYme1W1F5zeCVfakzM3WUsd6NUVYzt9f8aRcZyN5iYuwtoSMi01xx2NVdFQGN60KV70SqnSmKVXSUp5z0ARY/Yel+E/eFBU0Xp/uAiS8U5c4dVqiSHNi+/PoqlnUaRi6lOphYSgMGDUwsJxnOD5kkkFdUTKp0NV7OS6ON6LQsezw2W4EyAAMOzp21PKqXna1BJjNIoMjx72mQzRbHuxebAHqHzaleSoNIozGH1Htgc+e3eRYAHr39d1Ury0fqvTXbru1cCvJ85q1W6EMWzV0x3Vl2Xn+9zPInoCvtb+WrTb67HNGpkth+50tUynr1CdOqY7bNy+atSm+jUMeLZK2XhYjN9y/voBKnDOQWOU77TVS7HaRQdIV1d3CvB6SrnxUoetoN0dXFXPbWu4MD5/lGpQlghAfKFGfHi7jZI7k59B0DIF6HHEuWLWl6sOHK1KQlrFLmQ6iS9EqWf1f/oKkg8Ow4++N4rqYSr2hzhlleorawyTci7jZCvudTGI3nxytWmn0fymsYZz93hr9f/fUT6e+4P1iubHL9U/K8gGcqccrX9ujSKDGVOCbY1C5L04jiPcrddAz7K3Sa9OG4LvmZBMpQ5RXPg84qXfTvv2UGCfZD8C9LyBuh726XdAAAAAElFTkSuQmCC alt>
 </div>
 <div class=comment-content>
 <div class=comment-info>
 <cite>于洋</cite>
 <div class=comment-meta>
 <time class=comment-time datetime=2014-07-12T23:05>2021-05-07 02:36:18.846478</time>
 
 <span class=sep>/</span><a class=reply href=javascript:void(0)>回复</a>
 </div>
 </div>
 <div class=comment-text>
 <p>very np，but, 你列举的jdk的路径都是ubuntu的？centos的jdk路径是包含具体版本号</p>
 </div>
 </div>
 
 
 <ul class=children>
 <li class=depth-2>
 <div class=avatar>
 <img width=50 height=50 class=avatar src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAE30lEQVRYhbWYTWgbRxiG3/2T1lbqmrh1E9LajqVAQP5JFNMSiFzjEmzaphCKoFAcGoJy6CGQNhDT9uBTaSEk95iQQJ1LfQj05ECpEzmHFIootVxycMFWScEWLq4dWSuttNODvOud3dkfrZwPBLvfjr559Grme0fiNr8+S7APwb/+FuSRTwEAyqP70Ap/70dZiM0W0MGkgRGA4wEA0sAI1D8e7QsoF1RBFpgtiNY0aMOAvsCs0QSob8BAYNYIAMoRQvwpSDRXsFp+CcovPwAA5NEJCF3xwLWCAXqAVZezVF6MJbxBXyagE5g1mgVtGNAvmDWCgvoGDApmjUZBPXexvnt3Zr+j8uFkClykHcrctOsE8ngapLiJ8sIslW9NTfrazY5OYmsrJsBwMgV5LG3cO0HK42mEz6SMezOkNDjqy3FsgF79TocjpW0QtWIAWCF1OG1rA5wUMj4QpSTHe4IagH4asRmuePc6SLmEyKUbNkgzXPHONXDhFkQufs+G9AAVvvp4ZKrlg8/R8tEVCId6AY5jwkFVKLjaP8sgpW1Unz2FFE9COjYELiRDjJ2i4LSN5yDb/6L6VxZS3zCk46cBVYEYO2Wfg+MgHDqK8DvnILz2JmqFVYivXJn25RB6QaJWQMolChyqUq/f2sbMAwApl0DUCrgWgIu0o3hv0nk3mxR1bDOstmL96qAqiFy6Ab7jCCrZhyg9uAkAaDn/BUKJMWgbz+vjJLk+rq0D5Sez1Hr1ajs2QK9+Z4aEqtBweimOoyAhyUw4cziBGoCNNGJz+7DBGZX3IAG4wrmBctXVHAniEPJ4GlxrGxvOAkl2tnzBsUBFbWsDkc9ol3hx+ypq+SXXAqS4uXvhYkSEgOxs7Y11CaErjgOXb1E5NZcBX56fsU0ij064FtP7YfhMCvJ42nGcvhTksTTCyZTjOOachKA8PwO+trYCdWmBeibGEo67ytysta0NR0jzZiKlbVdIoSsOMZagcurSAmprK+ABwK+KVicp3rnGhLS2o+Ld666QTuoBgDA5HJ0ixU0Ib/RA6Ow2xvAHD6O6nAX5r8CEa9ZJavk/DfXksxdt6lV+/anOoSe9VOQi7fUP5+Ekhps4OIm5lpd6FKDXWlTmplF+Mgu+rcNwD/O13g9LD26ikn0IvuOI4R7ma3M/dFt7egiTw9Ep/UYr5BF6+0PqwMC/2gn1958BANXlLLiQDOnYEKR4EqHBUaaTVJ89Bd/eCTF6EtLx0wgNvc90ktbzX4I/eJhSr/Tjt1Rbok4Jfna0WUmmzekTmZRkwflRD2AcWMvzM5DiSUpFeXQCxXuTFCQAdyfZhQTAdBKvtecIWFtbsZ0JxVgCrZ98A6lvmMq/uH3V00kqv83hwOVb1NFfzWVs6oHjbOoBlq/YLZi7/D13x2GOcVDKKXwD1tZWoOYyVE6MJiB29zm+R+zugxi1rLNchqlU04CArqJG5cIuvm17RrSG1AMaBKytrzJUPAmxx66i2NMHMXqSyqm5DGrrqy8PEACU+fsMFS/YxtlyRKu/t8FoGFBbX4W6aFGx9wTEnv69+55+iL0nqDHqYgZag+oFAgQAhbkWLzCvAeyq19ja0yMQoFbIQ118TOXE3kGIRwfqr95B6pm6+BhaIR8IMPC//Mr8DKT+d6nf1Mwd3YR6APA/k4hUp5X8lYoAAAAASUVORK5CYII=" alt>
 </div>
 <div class=comment-content>
 <div class=comment-info>
 <cite>LandGrey</cite>
 <div class=comment-meta>
 <time class=comment-time datetime=2014-07-12T25:05>2021-05-07 03:35:11.730067
 </time>
 <span class=sep>/</span><a class=reply href=javascript:void(0)>回复</a>
 </div>
 </div>
 <div class=comment-text>
 <p>@于洋 https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks 这里面列的 jdk 路径大部分都是网络搜集来的，相当一部分是 docker 环境里的 jdk 路径，不带具体的版本号。你说的存在具体版本号的路径我也注意到了，没有其他任何辅助信息的情况下盲猜确实困难。</p>
 </div>
 </div>
 </li>
 </ul>
 
 
 </li>
 
 
 
 
 
 <li class=depth-1>
 <div class=avatar>
 <img width=50 height=50 class=avatar src=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAJvUlEQVRYw5WYe4xdVRXGf2ufc+fOq0NTS1sKiQWxUoG0hCJKraVQC0LERAzRKGoTg4kEIhET44Omf0iCCRASQUDQWkowTX0rVAsCNmDBtjhl2kKhLX1QoB2dzkzv3HPPYy//2Puce+6dB/Uk93Fee6+9Ht/3rS2jjREFEEBxR/k/xTX1d9oPBRRBEAzDJ0+y78BBTpyssXjhBUzr7gIULUadaIzJj7A8zUT/y9ekmKi5kPyqYnl14HXuvOse+nfswoQdXL78Um64/rMs/eTHMWL8OONHmHgu/+xJ78H2m8W5PxFV76f8t9XbO3fv4Zabv89ru9+gHsUIUK0GzDljJrd/79t89YufB3Gjy/sY1lyIYHIDNPecOKPUXxXcuC6AoCLumXwYgbcOv83t3/kRe3Yfph5VUfqw9FKPDEcOD/Krtb/jnWODfrU6SYzyxVqsX4YCpvCSgJ/bfYovb7CAlQmyT5U//eWvvLZnL42oAQQgBiQAApI4Yv8bu9m6bYd/w6B+8omNbI2OKa/G5VL5v8ut/BlTerE8hQSG7u4uxPgn3OoQqYDpIarXOPTWIecAYVIPNk1sHkbaJhQUVJqexDQzQ9uKSEBEuGnVjVy+cjmVagXFIta6N8T49/H3BNVmlE7lMMUfZUKQ0VLKaikFkGYwOiqGlVcup6c7BI2wGrl3NEFtjSAIqXZ2Fc9PFeJxBuYvWckz38OA5itQ78MphlXhYxdfxGnTZ2CMQSRE1YJmYDNEKnR1dQH2//Je4cHcCCP4X39ehFQcQpRytP0YG6vR3VMlCBRsHTQCTUAqxIlhYOB1xuqNArY4RR8aU1SOlrMNEaEMQVIksPVAoSUoUs6edxarVt1AX18FozXIRkBjCHppNIQNj/+GTU8/hyhFtk9NDW05qKX6pISBBjB5JXugdNdyrwoqQqUS8rUvf4EVVy1j1txZzJ47l6DSiUiAtcKJoRobNj7F3n2HUFUE24aAk9R0rTHiZpbmOowKxVKFJmAWZiuqJYwsYMiw/+AR9u8/xOant/DwA2tJsm63HGPp6qmyYMFZ3HfvGhZduABUTy0HRQRTeAasePSTMgtLSTRQYJq28fLoyCg/feBBHlv7OGmauDdFUA2o12L2DOzl/vsfRu0p5mDOHuUjwBlcpkBVV4NaZkt1+SfaNHLTps3864VXODmaonQ2fS9ujKge8+yzL7F1W38pk9uzuvkxMkkmNIFaPDm1PVdygIgzNGrEbH+ln3o9RakipsvRXuk9m2UMD42wdv1GMmvLjF/wr5Q+Ridlwpx0/DUp+86JBvFgrb5YhoaG2ffmYdLMZa2IaRJ8KRmi2igvPL+F7TsHCg/m/pO2ujZTg6aOY+gMvNoos4rz8ZsHDjE4OOzzSybQKoCEQIX/Do7ywpatPpmkpABbQ26mTlVp09Ti2EC1ZZWiEMcxT2z4LbXR0ZbilNK3ln7jqM6+fQexVlue0sIBLm3CMjtIm1HaxsmO6E0BPYV0Feh/dQ9P/+0lkqTLKa02DxZjSycEFRAIwtB7H2+W5qqzmDVslzeTdg2Kz0MtOhBRhzVHjh7lvvse4j/Hh7FqCh3ZmlF5iA2ooFjSJC3dEu85i2LaPSiTyO+c2CiUjJayL45jHnp0HevWPcHBA+8RNypApZhwnMKTPFUsai1Hjx4hjiM6O6ulwPrZVbEiedPkXGtLXYcW5OcGbPGzhW39/Ty27tf8+Q9PMnh8iCwTCKaXUKXZZk0UDkWJGnWsLaskW/zmOiCEoJxNzTVrK+CJd3qjEfPzXzzOIw//kncOHyaqN8hs4CFF34dfdYJTXxaqviPRAuzUhdi2GeFDKa3lY1V599ggq9fcy6annmF48DhZmoJ0OKgzLVpovE1NGVMYFicJmc2wWk4qj4fizsKygtE8R9SiuVbwFLXtlZ2svuPH7Ni+i7GTdbI0xpiQsKODamcVaw1RFEwinLTpLc1AM5SU3p4eKmEIqo5KxXpxAJ5kMIJBJPCMkKGauRdwTGGtsPm5rdx6yw95eWs/teET2DQjDEP6pndx0eIF3HX3Gi5efD4mmFqGuuIYQ9MTiB1jWu80TBC0Olldp6iqWFXCZlQMoqYgHMEyMlLjZw89yqOPrGfwvRHiRoQIVHt6mDVnFl9fdT3f+uY3sGnM+rXrEbUlidGsX6XUEmNBIKx0c/qs0wkC4w3KiqLKQQaFUPOX/EVBEDG8tH0799xzPy9u2crI0DBZllHp6GBaXy/nL7yQ2267mWVLL6VaqfLmW8c4dnwQa20J82QKdhJ6entYvHghatMCmgtezlcjECpZi4aIoohnnv8nd/xgNYcOvk0cKx2d0+g7rZf5H/0IN37leq6+6gqm9/X5hWW8++5xTgydwKqWQFrbsLB5Nezo4IKFC1i58nLwOwm2hLCI9VDogRoMUZLw7D9eZOPG37Pj5a0MD41QrVY446w5LF22hM9ddw2XXrKIvt5un00JRp2J/x54nUYjBTU08Una8q9Z4UHYwcJFFzC9r9d5XcTrTRdHI75QBVfFUSPhwbVP8NjaDfR2V7ji0yu49jNX0b9zF1desZTz5n+YMMjhJvaVDhmQWWXg1T2kqUyxFVQWA65i335nkEwz3zFqmQMQdSrcA7Ww8Y9Psnnz3zn3vA9x5+rvcs4HzwQRln/qspJ6zrB+8CZsQBRFvDawiySOULomb3+0lGM2ZmhwkCyzDuCt63cd9jnxYP0ORKhWSQPhlltvYubsmZwz70zvbi22RFwTjnN7Pp83NIpihmtjqOoUUq11b1FQZnxguq9ULfS9lnYt3JxCaALDl667miTJ6M63J8Ri1POID4Nq0wvFBpAK9ajG2Oio20EYp4lL/UvRKAphRycLzp+P5lVvAyzWNUgqqLqwuyJRqFY6qVa0SY3Fpq4tmqNiSm+cEcgU9h44QtKooaSuDWiHmXHCWghDw2l93V6xeKHl57WqSOYkl2KbjXu5H3HC1IXWlpA9N1Y1z0XLydEaS5YtYcbM0zESjqvg9q1lY2D27BnMP/dsUMHk+lEVq040pGKxar0yLB1WLVZTry4s1lqHbeoVh7j9T6uWTJ1kWrH8Mu7+yRrmnzffKeT32xQPAxYuWsAnLlnUYpR45lAg0MBTn8FYTbE2w9rUVapaMpuSZqk32GLFoiiZOoPVq5ssVUQsnd0V5s2bSxjKlHstIkJHtcq5888mSWPiLCHLUmyWkPq5rU3dRy1WM0yWJWQ2JvMPq7+p4vBdxMU8UxwFWcFaXOdmM9RRK9dcu4JqVxVkYqJzO8qGWXNms2zZEpI0I2rUiZMGcZqQxQlJGpOkCUmWkGYxadrgf90tdeK9XdDDAAAAAElFTkSuQmCC alt>
 </div>
 <div class=comment-content>
 <div class=comment-info>
 <cite>darkless</cite>
 <div class=comment-meta>
 <time class=comment-time datetime=2014-07-12T23:05>2022-02-25 02:19:34.868969</time>
 
 <span class=sep>/</span><a class=reply href=javascript:void(0)>回复</a>
 </div>
 </div>
 <div class=comment-text>
 <p>经测试，在linux默认配置下，是不会加载charsets.jar包的。
默认 LANG=zh_CN.UTF-8，当把 LANG改为zh_CN.GBK时才可以加载charsets.jar</p>
 </div>
 </div>
 
 </li>
 
 
 
</ol> 
 
 
 <nav class="pagination add-bottom">
 <a class="page-numbers prev inactive" href=#>«</a>
 
 
 
 <a class="page-numbers current" href="https://landgrey.me/blog/22/?page=1#comments">1</a>
 
 
 
 <a class="page-numbers next inactive" href=#>
 »
 </a>
 </nav>
 
 
 <div class=respond id=submit-comment>
 <h3>评论</h3>
 
 
<form id=submit-comment-form method=post action>
 <fieldset>
 
 
 
 <div class=group>
 <label for=cName>昵称 <span class=required>*</span></label>
 <input id=cName name=name required size=35 type=text value>
 </div>
 <div class=group>
 <label for=cEmail>邮箱 <span class=required>*</span></label>
 <input id=cEmail name=email required size=35 type=text value>
 </div>
 <div class="message group">
 <label for=cMessage>Message <span class=required>*</span></label>
 <textarea cols=50 id=content name=content required rows=10></textarea>
 </div>
 <button type=submit class=submit>提交</button>
 </fieldset>
</form>
 </div> 
 </div> 
 </article>
 </div>
 <div id=sidebar class="four columns">
 <div class="widget widget_search">
 <h3>Search</h3>
 <form action=/search/>
 <input type=text value=搜索... name=keyword id=keyword class=text-search>
 <input type=submit value class=submit-search>
 </form>
 </div>
 <div class="widget widget_categories group">
 <h3>分类</h3>
 <ul>
 
 <li><a href=https://landgrey.me/category/6/ title>代码审计</a>
 (9)
 </li>
 
 <li><a href=https://landgrey.me/category/5/ title>其他</a>
 (5)
 </li>
 
 <li><a href=https://landgrey.me/category/2/ title>安全开发</a>
 (2)
 </li>
 
 <li><a href=https://landgrey.me/category/1/ title>渗透测试</a>
 (6)
 </li>
 
 <li><a href=https://landgrey.me/category/4/ title>红队战争</a>
 (2)
 </li>
 
 </ul>
 </div>
 <div class="widget widget_popular">
 <h3>最新文章</h3>
 <ul class=link-list>
 
 <li>
 <a href=https://landgrey.me/blog/23/ title="spring-security 三种情况下的认证绕过">spring-security 三种情况下的认证绕过</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/22/ title="Spring Boot Fat Jar 写文件漏洞到稳定 RCE 的探索">Spring Boot Fat Jar 写文件漏洞到稳定 RCE 的探索</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/21/ title="spring actuator restart logging.config rce">spring actuator restart logging.config rce</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/20/ title="Apollo 配置中心未授权获取配置漏洞利用">Apollo 配置中心未授权获取配置漏洞利用</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/19/ title="利用 intercetor 注入 spring 内存 webshell">利用 intercetor 注入 spring 内存 webshell</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/18/ title="xxl-job 执行器 RESTful API 未授权访问 RCE">xxl-job 执行器 RESTful API 未授权访问 RCE</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/17/ title="Beetl 模版引擎执行任意 Java 代码的方法">Beetl 模版引擎执行任意 Java 代码的方法</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/16/ title="使用 MAT 查找 spring heapdump 中的密码明文">使用 MAT 查找 spring heapdump 中的密码明文</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/15/ title="bypass openrasp SpEL RCE 的过程及思考">bypass openrasp SpEL RCE 的过程及思考</a>
 </li>
 
 <li>
 <a href=https://landgrey.me/blog/14/ title="通过mysql jdbc 反序列化触发的 SpringBoot RCE 新利用方法">通过mysql jdbc 反序列化触发的 SpringBoot RCE 新利用方法</a>
 </li>
 
 </ul>
 </div>
 <div class="widget widget_tags">
 <h3>标签</h3>
 <div class="tagcloud group">
 
 <a href=https://landgrey.me/tag/spring/ title=spring>spring</a>
 
 <a href=https://landgrey.me/tag/php/ title=php>php</a>
 
 <a href=https://landgrey.me/tag/%E7%BA%A2%E9%98%9F%E6%94%BB%E9%98%B2/ title=红队攻防>红队攻防</a>
 
 <a href=https://landgrey.me/tag/%E5%88%86%E4%BA%AB/ title=分享>分享</a>
 
 <a href=https://landgrey.me/tag/java/ title=java>java</a>
 
 <a href=https://landgrey.me/tag/python/ title=python>python</a>
 
 <a href=https://landgrey.me/tag/%E5%A4%87%E5%BF%98/ title=备忘>备忘</a>
 
 <a href=https://landgrey.me/tag/%E9%9A%8F%E7%AC%94/ title=随笔>随笔</a>
 
 </div>
 </div>
 <div class="widget widget_popular">
 <h3>热门文章</h3>
 <ul class=link-list>
 
 </ul>
 </div>
 </div> 
 </div>
 
 </div>
 
 <footer>
 <div class=row>
 <div class="twelve columns">
 <ul class=social-links>
 <li>
 <a href=https://github.com/LandGrey target=_blank>
 <i class="fa fa-github-square"></i>
 </a>
 </li>
 </ul>
 </div>
 <p class=copyright>© Copyright 2019 LandGrey's Blog</p>
 </div> 
 <div id=go-top>
 <a class=smoothscroll title="Back to Top" href=#top>
 <i class="fa fa-chevron-up"></i>
 </a>
 </div>
 </footer> 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
<style>@keyframes skeleton-loading{0%{background-color:rgba(128,128,128,.1)}100%{background-color:rgba(128,128,128,.2)}}</style>